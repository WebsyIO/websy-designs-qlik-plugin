"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _websyDesignsEs=_interopRequireDefault(require("@websy/websy-designs/dist/websy-designs-es6"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,n)}return o}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(o),!0).forEach(function(e){_defineProperty(t,e,o[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))})}return t}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,n=new Array(t);o<t;o++)n[o]=e[o];return n}function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function _readOnlyError(e){throw new TypeError('"'+e+'" is read-only')}var Bookmarks=function(){function i(e,t){var o=this;_classCallCheck(this,i),this.elementId=e;this.options=_extends({},{dock:"left",bookmarkIcon:"<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 512 512'><path d='M352 48H160a48 48 0 00-48 48v368l144-128 144 128V96a48 48 0 00-48-48z' fill='none' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='32' /></svg>",closeIcon:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512"><line x1="368" y1="368" x2="144" y2="144" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/><line x1="368" y1="144" x2="144" y2="368" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/></svg>',searchIcon:'<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 512 512"><path d="M221.09 64a157.09 157.09 0 10157.09 157.09A157.1 157.1 0 00221.09 64z" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="32"/><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32" d="M338.29 338.29L448 448"/></svg>',editIcon:'\n        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n          <path d="M384 224v184a40 40 0 01-40 40H104a40 40 0 01-40-40V168a40 40 0 0140-40h167.48"\n          fill="none" stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"/>\n          <path d="M459.94 53.25a16.06 16.06 0 00-23.22-.56L424.35 65a8 8 0 000 11.31l11.34 11.32a8 8 0 0011.34\n          0l12.06-12c6.1-6.09 6.67-16.01.85-22.38zM399.34 90L218.82 270.2a9 9 0 00-2.31 3.93L208.16 299a3.91 3.91\n            0 004.86 4.86l24.85-8.35a9 9 0 003.93-2.31L422 112.66a9 9 0 000-12.66l-9.95-10a9 9 0 00-12.71 0z"/>\n        </svg>\n      ',deleteIcon:'\n        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><title>Trash</title>\n          <path d="M296 64h-80a7.91 7.91 0 00-8 8v24h96V72a7.91 7.91 0 00-8-8z" fill="none"/>\n          <path d="M432 96h-96V72a40 40 0 00-40-40h-80a40 40 0 00-40 40v24H80a16 16 0 000 32h17l19 304.92c1.42\n            26.85 22 47.08 48 47.08h184c26.13 0 46.3-19.78 48-47l19-305h17a16 16 0 000-32zM192.57 416H192a16 16 0 \n            01-16-15.43l-8-224a16 16 0 1132-1.14l8 224A16 16 0 01192.57 416zM272 400a16 16 0 01-32 0V176a16 16 0 0132\n            0zm32-304h-96V72a7.91 7.91 0 018-8h80a7.91 7.91 0 018 8zm32 304.57A16 16 0 01320 416h-.58A16 16 0 01304 \n            399.43l8-224a16 16 0 1132 1.14z"/>\n        </svg>               \n      ',copyIcon:"Copy",tickIcon:'\n        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n          <path d="M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192 192-86 192-192z" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="32"/><path fill="none"\n            stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" \n            stroke-width="32" d="M352 176L217.6 336 160 272"/>\n        </svg>\n      ',crossIcon:"",infoIcon:'\n        <svg class="i-icon-public" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">\n          <path d="M256 56C145.72 56 56 145.72 56 256s89.72 200 200 200 200-89.72 200-200S366.28 \n          56 256 56zm0 82a26 26 0 11-26 26 26 26 0 0126-26zm48 226h-88a16 16 0 010-32h28v-88h-16a16 16 0 010-32h32a16 16 0 0116 \n          16v104h28a16 16 0 010 32z"/>\n        </svg>\n      '},t);var n=document.getElementById(this.elementId);if(n){n.addEventListener("click",this.handleClick.bind(this)),n.addEventListener("keyup",this.handleKeyUp.bind(this)),n.addEventListener("change",this.handleChange.bind(this)),n.addEventListener("contextmenu",this.handleContextMenu.bind(this));var a="\n        <div class='websy-bookmark'>\n          <div class='bookmarkBtn'>\n            ".concat(this.options.bookmarkIcon,"\n          </div>\n          <div class='bookmark-mask' id='").concat(this.elementId,"_bookmarkPopup'></div>\n          <div class='bookmarkContainer dock-").concat(this.options.dock,"' id='bookmarkContainer'>\n            <div class='bookmark-topline'>\n              <span class=\"heading\">").concat(this.options.title||"Bookmarks","</span>\n              <button class='createNew'>Create new bookmark</button>\n              <button class=\"closeButton close-panel\">\n                ").concat(this.options.closeIcon,"\n              </button>\n            </div>            \n            <div style='position: relative;' class='websy-bookmark-search'>              \n              <input class='search-input' type='text' id=\"").concat(this.elementId,'_search" placeholder="Search">\n              ').concat(this.options.searchIcon,"\n            </div>            \n            <div class='public'>\n              <div class=\"public-heading-caret\">\n                <svg class='public-caret caret' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 512 512'>\n                  <title>Caret Down</title>\n                  <path d='M98 190.06l139.78 163.12a24 24 0 0036.44 0L414 190.06c13.34-15.57 2.28-39.62-18.22-39.62h-279.6c-20.5 0-31.56 24.05-18.18 39.62z' />\n                </svg>\n                <span class=\"heading\">Public bookmarks <span id=\"publicCount\">(0)</span></span>\n              </div>\n              <div id=\"public-placeholder\" class=\"active\"><p class='public-text'>You have no public bookmarks</p>\n                <p class='public-text'>Right-click on a bookmark and select 'Make public'.</p>              \n              </div>\n            </div>\n            <div class='my-bookmarks'>\n              <div class=\"heading-caret\">\n                <svg class='myBookmarks-caret caret' xmlns='http://www.w3.org/2000/svg' viewbox='0 0 512 512'>\n                  <title>Caret Down</title>\n                  <path\n                    d='M98 190.06l139.78 163.12a24 24 0 0036.44 0L414 190.06c13.34-15.57 2.28-39.62-18.22-39.62h-279.6c-20.5 0-31.56 24.05-18.18 39.62z' />\n                </svg>\n                <span class=\"heading\">My bookmarks <span id=\"myBookmarksCount\">(0)</span></span>\n              </div>\n              <div id=\"myBookmarks-placeholder\" class=\"active\"></div>\n            </div>\n          </div> \n          <div class='bookmark-mask-dark' id='bookmarkNewPopup'></div>       \n          <div class='createNewPopup' id='createForm'>\n            <div class='createTopline'>\n              <span class=\"heading\">Create bookmark</span>\n              <span class='closeCreate'>\n                <svg xmlns='http://www.w3.org/2000/svg' viewbox='0 0 512 512'>    \n                  <path fill='none' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='32'\n                    d='M368 368L144 144M368 144L144 368' />\n                </svg>\n              </span>\n            </div>\n            <div class=\"create-input\">\n              <label for='bookmarkName' class=\"title\">Title</label>\n              <input type='text' class=\"bookmark-name\" id='bookmarkName' name='bookmarkName'>\n              <label for='bookmarkDescription' class=\"description\">Description <span class='optional'>(optional)</span></label>\n              <textarea type='text' id='").concat(this.elementId,"_bookmarkDescription' name='bookmarkDescription'></textarea>\n              <div class=\"create-flex\">\n                <button type=\"button\" disabled class='create-submit' id='createSubmit'>Create</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    ");n.innerHTML=a,this.options.app.createSessionObject({qInfo:{qId:"BookmarkList",qType:"BookmarkList"},qBookmarkListDef:{qType:"bookmark",qData:{title:"/qMetaDef/title",description:"/qMetaDef/description",sheetId:"/sheetId",selectionFields:"/selectionFields",creationDate:"/creationDate"}}}).then(function(e){o.options.model=e,o.render()})}}return _createClass(i,[{key:"createBookmarkHtml",value:function(o,e){var t='\n      <div class="public-li" id="public-li" data-bookmark="'.concat(o.qInfo.qId,'">\n        <span class="bookmark-text" data-bookmark="').concat(o.qInfo.qId,'">').concat(o.qMeta.title,'</span>\n        <div class="date-and-i">\n          <span class="bookmark-text">').concat(new Date(o.qMeta.createdDate).toLocaleString().slice(0,10),'</span>\n          <span class="info-button" data-bookmark="').concat(o.qInfo.qId,'">\n            ').concat(this.options.infoIcon,'\n          </span>\n        </div>\n      </div>          \n      <div class="info-popup" id="info-popup-').concat(o.qInfo.qId,'">\n        <div class="info-topline" id="info-topline-').concat(o.qInfo.qId,'" data-bookmark="').concat(o.qInfo.qId,'">\n          <span class="description-heading" id="description-heading">').concat(o.qMeta.description,"</span>\n        </div>");return-1!==o.qMeta.privileges.indexOf("update")&&(t+='\n        <div class="edit-topline">\n          <div data-bookmark="'.concat(o.qInfo.qId,'" class="edit-info active" id="edit-info-').concat(o.qInfo.qId,'">\n            ').concat(this.options.editIcon,'\n          </div> \n          <div class="tick-icon" id="tick-icon-').concat(o.qInfo.qId,'">\n            ').concat(this.options.tickIcon,"\n          </div>                             \n      "),-1!==o.qMeta.privileges.indexOf("delete")&&(t+='\n          <div class="trash-icon" data-bookmark="'.concat(o.qInfo.qId,'" id="deleteIcon-').concat(o.qInfo.qId,'">\n            ').concat(this.options.deleteIcon,"\n          </div>\n        ")),t+='        \n        </div>\n        <div id="edit-inputs-'.concat(o.qInfo.qId,'" data-bookmark="').concat(o.qInfo.qId,'" class="edit-inputs">\n          <input type="text" id="edit-title-').concat(o.qInfo.qId,'" placeholder="Bookmark title"  value="').concat(o.qMeta.title,'"/>\n          <input type="text" id="edit-description-').concat(o.qInfo.qId,'" placeholder="Bookmark description" value="').concat(o.qMeta.description,'"  />\n        </div>')),t+='\n      <span class="selections">Selections: '.concat(o.qData.selectionFields,"</span>\n    "),t+=o.qData.qBookmark.qStateData.map(function(e,t){return'\n      <div class="info-copy">\n        <span class="set-expression">'.concat(e.qStateName,'</span>\n        <input type="text" READONLY class="info-input" value="" id="').concat(o.qInfo.qId,'_i_set" />\n        <div class="flex">\n          <div class="copied" data-bookmark="').concat(o.qInfo.qId,'" id="copied"><h5>copied to clipboard</h5></div>\n          <button class="copy" data-bookmark="').concat(o.qInfo.qId,'" id="copyBtn-').concat(o.qInfo.qId,'_i" >Copy</button>          \n        </div>\n      </div>\n    ')}).join(""),!0===o.qMeta.published&&-1!==o.qMeta.privileges.indexOf("publish")&&(t+='\n        <div class="right-click-popup" id="rightClickPopup-'.concat(o.qInfo.qId,'" data-bookmark="').concat(o.qInfo.qId,'">\n          <div class="right-click-menu">\n            <p class="unpublish-btn" id="unpublishBtn-').concat(o.qInfo.qId,'" data-bookmark="').concat(o.qInfo.qId,'">Unpublish</p>\n          </div>\n        </div>\n        ')),!0!==o.qMeta.published&&-1!==o.qMeta.privileges.indexOf("publish")&&(t+='\n        <div class="right-click-popup" id="rightClickPopup-'.concat(o.qInfo.qId,'" data-bookmark="').concat(o.qInfo.qId,'">\n          <div class="right-click-menu">\n            <p class="publish-btn" id="publishBtn-').concat(o.qInfo.qId,'" data-bookmark="').concat(o.qInfo.qId,'">Publish</p>\n          </div>\n        </div>\n        ')),t+="</div>"}},{key:"render",value:function(n){var a=this,i=document.getElementById("publicCount");this.publicBookmarks=[];var s=document.getElementById("myBookmarksCount");this.myBookmarks=[],this.options.model.getLayout().then(function(e){e.qBookmarkList.qItems.forEach(function(e){!0===e.qMeta.published?n?-1!==e.qMeta.title.toLowerCase().indexOf(n.toLowerCase())&&a.publicBookmarks.push(e):a.publicBookmarks.push(e):n?-1!==e.qMeta.title.toLowerCase().indexOf(n.toLowerCase())&&a.myBookmarks.push(e):a.myBookmarks.push(e)});var t='<div id="info-popup-mask" class="info-popup-mask"></div>';a.publicBookmarks=a.publicBookmarks.filter(function(e){return!(a.options.hidePrefix&&0===e.qMeta.title.indexOf(a.options.hidePrefix))}),a.publicBookmarks.forEach(function(e){t+=a.createBookmarkHtml(e)});var o="";a.myBookmarks.forEach(function(e){new Date;e.qMeta.createdDate&&new Date(e.qMeta.createdDate),o+=a.createBookmarkHtml(e)}),document.getElementById("public-placeholder").innerHTML=t,document.getElementById("myBookmarks-placeholder").innerHTML=o,i.textContent="("+a.publicBookmarks.length+")",s.textContent="("+a.myBookmarks.length+")"})}},{key:"handleKeyUp",value:function(e){var t=document.getElementById("bookmarkName").value;e.target.classList.contains("search")&&this.searchFunction(),e.target.classList.contains("bookmark-name")&&(0===t.length?this.disableCreate():this.enableCreate())}},{key:"handleClick",value:function(e){var o=this,t=document.getElementById("bookmarkName"),n=document.getElementById("bookmarkDescription");(e.target.classList.contains("bookmarkBtn")&&this.openForm(),e.target.classList.contains("bookmark-mask")||e.target.classList.contains("close-panel"))&&(this.closeForm(),this.closeBookmark(),Array.from(document.getElementsByClassName("info-popup")).forEach(function(e){e.classList.remove("active")}),document.getElementById("info-popup-mask").classList.remove("active"));(e.target.classList.contains("createNew")&&this.createNewBookmark(),e.target.classList.contains("closeCreate"))&&(document.getElementById("".concat(this.elementId,"_bookmarkPopup")).style.backgroundColor="transparent",this.closeBookmark());(e.target.classList.contains("public-heading-caret")&&(this.closePublicUL(),e.target.classList.toggle("closed")),e.target.classList.contains("heading-caret")&&(this.closeMyBookmarksUL(),e.target.classList.toggle("closed")),e.target.classList.contains("create-submit"))&&(document.getElementById("".concat(this.elementId,"_bookmarkPopup")).style.backgroundColor="transparent",this.options.app.createBookmark({qInfo:{qType:"bookmark"},qMetaDef:{title:"".concat(t.value),description:"".concat((n||{}).value||"")}}).then(function(){document.getElementById("bookmarkName").value="",o.render()}),this.closeBookmark());if(e.target.classList.contains("trash-icon")){var a=e.target.getAttribute("data-bookmark");this.options.app.destroyBookmark(a).then(function(){o.render()})}(e.target.classList.contains("info-button")&&this.toggleInfo(e),e.target.classList.contains("i-icon-my")&&this.toggleInfo(e),e.target.classList.contains("info-popup-mask"))&&(Array.from(document.getElementsByClassName("info-popup")).forEach(function(e){e.classList.remove("active")}),document.getElementById("info-popup-mask").classList.remove("active"));if(e.target.classList.contains("edit-info")&&(this.editInfo(e),this.hideInfoTopline(e),this.showTickIcon(e),this.showdeleteIcon(e)),e.target.classList.contains("tick-icon")){var i=e.target.getAttribute("data-bookmark"),s=document.getElementById("edit-title-".concat(i)),r=document.getElementById("edit-description-".concat(i));this.options.app.getBookmark(i).then(function(t){t.getProperties().then(function(e){e.qMetaDef.title=s.value,e.qMetaDef.description=r.value,t.setProperties(e),o.render()})})}if(e.target.classList.contains("public-li")||e.target.classList.contains("myBookmarks-li")){var l=e.target.getAttribute("data-bookmark");this.options.app.applyBookmark(l),this.closeForm()}e.target.classList.contains("copy")&&(this.copyToClipboard(e),this.toggleCopied(e)),e.target.classList.contains("publish-btn")&&(this.publish(e),this.handleContextMenu(e)),e.target.classList.contains("unpublish-btn")&&(this.unpublish(e),this.handleContextMenu(e))}},{key:"handleChange",value:function(e){e.target.classList.contains("search")&&this.render(e.target.value)}},{key:"searchFunction",value:function(){var e=document.getElementById("".concat(this.elementId,"_search")).value.toLowerCase();this.render(e)}},{key:"publish",value:function(e){var t=e.target.getAttribute("data-bookmark");this.options.app.getBookmark(t).then(function(e){e.publish()}).catch(function(e){console.log("error",e)})}},{key:"unpublish",value:function(e){var t=e.target.getAttribute("data-bookmark");this.options.app.getBookmark(t).then(function(e){e.unpublish()}).catch(function(e){console.log("error",e)})}},{key:"openForm",value:function(){var e=document.getElementById("".concat(this.elementId,"_bookmarkPopup"));e&&(e.style.display="block");var t=document.getElementById("bookmarkContainer");t&&(t.style.display="block")}},{key:"closeForm",value:function(){document.getElementById("".concat(this.elementId,"_bookmarkPopup")).style.display="none";var e=document.getElementById("bookmarkContainer");e&&(e.style.display="none"),Array.from(document.getElementsByClassName("info-popup")).forEach(function(e){e.classList.remove("active")}),Array.from(document.getElementsByClassName("right-click-popup")).forEach(function(e){e.classList.remove("active")});var t=document.querySelectorAll(".edit-topline svg");t.forEach(function(e){e.classList.remove("active")});document.querySelectorAll(".edit-topline svg");t.forEach(function(e){e.classList.remove("active")})}},{key:"createNewBookmark",value:function(){var e=document.getElementById("createForm"),t=document.getElementById("bookmarkNewPopup");e.classList.add("active"),t.classList.add("active")}},{key:"copyToClipboard",value:function(e){var t=e.target.getAttribute("data-bookmark"),o=document.getElementById("infoInput");document.getElementById("copyBtn-".concat(t));o.select(),navigator.clipboard.writeText(o.value)}},{key:"toggleCopied",value:function(e){var t=e.target.getAttribute("data-bookmark");document.getElementById("copied-".concat(t)).classList.toggle("active"),setTimeout(this.toggleCopied,3e3)}},{key:"closeBookmark",value:function(){document.getElementById("createForm").classList.remove("active"),document.getElementById("bookmarkNewPopup").classList.remove("active")}},{key:"closePublicUL",value:function(){document.getElementById("public-placeholder").classList.toggle("active")}},{key:"closeMyBookmarksUL",value:function(){document.getElementById("myBookmarks-placeholder").classList.toggle("active")}},{key:"toggleInfo",value:function(e){Array.from(document.getElementsByClassName("info-popup")).forEach(function(e){e.classList.remove("active")});var t=e.target.getAttribute("data-bookmark"),o=document.getElementById("info-popup-".concat(t));o.classList.add("active"),document.getElementById("info-popup-mask").classList.add("active")}},{key:"enableCreate",value:function(){document.getElementById("createSubmit").disabled=!1}},{key:"disableCreate",value:function(){document.getElementById("createSubmit").disabled=!0}},{key:"editInfo",value:function(e){var t=e.target.getAttribute("data-bookmark"),o=document.getElementById("edit-info-".concat(t)),n=document.getElementById("edit-inputs-".concat(t));o.classList.add("active"),n.classList.toggle("active"),this.hideInfoTopline(e)}},{key:"hideInfoTopline",value:function(e){var t=e.target.getAttribute("data-bookmark");document.getElementById("info-topline-".concat(t)).classList.toggle("active")}},{key:"showTickIcon",value:function(e){var t=e.target.getAttribute("data-bookmark");document.getElementById("tick-icon-".concat(t)).classList.toggle("active"),document.getElementById("edit-info-".concat(t)).classList.toggle("active")}},{key:"showdeleteIcon",value:function(e){var t=e.target.getAttribute("data-bookmark");document.getElementById("deleteIcon-".concat(t)).classList.toggle("active")}},{key:"handleContextMenu",value:function(e){if(e.target.classList.contains("public-li")||e.target.classList.contains("myBookmarks-li")){e.preventDefault(),Array.from(document.getElementsByClassName("right-click-popup")).forEach(function(e){e.classList.remove("active")});var t=e.clientX,o=e.target.getAttribute("data-bookmark"),n=document.getElementById("rightClickPopup-".concat(o));n&&(n.classList.toggle("active"),n.style.left="".concat(t,"px"))}}}]),i}(),Chart=function(){function n(e,t){var o=this;_classCallCheck(this,n),this.elementId=e,this.options=_extends({},t),this.optionDefaults={data:{left:{min:0,max:0},right:{min:0,max:0},bottom:{min:0,max:0},top:{min:0,max:0},series:[]}},this.chart=new _websyDesignsEs.default.WebsyChart(e),window.addEventListener("resize",function(){return o.chart.render()}),this.monthMap={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"},this.render()}return _createClass(n,[{key:"addOptions",value:function(e,t){for(var o in t)e[o]=t[o]}},{key:"checkForData",value:function(){var i=this;return new Promise(function(t,e){var o="qDataPages",n="getHyperCubeData",a="qMatrix";"K"===i.layout.qHyperCube.qMode&&(o="qStackedDataPages",n="getHyperCubeStackData",a="qData"),i.layout.qHyperCube[o][0]&&i.layout.qHyperCube[o][0][a]?("K"===i.layout.qHyperCube.qMode&&(i.layout.qHyperCube.qDataPages=[{qMatrix:i.transformDataToMatrix(i.layout.qHyperCube[o][0][a][0].qSubNodes)}]),t()):i.options.model[n]("/qHyperCubeDef",[{qTop:0,qLeft:0,qWidth:i.layout.qHyperCube.qSize.qcx,qHeight:Math.floor(1e4/i.layout.qHyperCube.qSize.qcx)}]).then(function(e){i.layout.qHyperCube[o]=e,"K"===i.layout.qHyperCube.qMode&&(i.layout.qHyperCube.qDataPages=[{qMatrix:i.transformDataToMatrix(e[0].qData[0].qSubNodes)}]),t()})})}},{key:"close",value:function(){this.chart.close()}},{key:"createSeriesKey",value:function(e){var t=new RegExp("[^a-zA-Z0-9 -]","g");return e.replace(t,"_").replace(/ /g,"_")}},{key:"formatValue",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};console.log("formatting",e,t);var n=0,a=!1;return void 0===t.max&&o.qMax&&(t.max=o.qMax),t.decimals?n=t.decimals:o.qNumFormat.qnDec&&(n=o.qNumFormat.qnDec),!0===t.showAsPercentage?a=t.showAsPercentage:o.qNumFormat.qFmt&&(a=-1!==o.qNumFormat.qFmt.indexOf("%")),"Time"===(t||{}).scale&&e.getDate?e="".concat(e.getDate()," ").concat(this.monthMap[e.getMonth()]," ").concat(e.getFullYear()):isNaN(e)||(e=_websyDesignsEs.default.Utils.toReduced(e,n,a,!1,t.max),!0===t.showAsCurrency&&(e=e.toCurrency())),e}},{key:"fromQlikDate",value:function(e){var t=new Date(Math.round(864e5*(e-25569)));return t.setTime(t.getTime()+6e4*t.getTimezoneOffset()),t}},{key:"getColor",value:function(e,t){if(t.qAttrExprInfo&&t.qAttrExprInfo[0]&&"colorByExpression"===t.qAttrExprInfo[0].id&&e.qAttrExps&&e.qAttrExps.qValues&&e.qAttrExps.qValues[0]&&e.qAttrExps.qValues[0].qText)return e.qAttrExps.qValues[0].qText}},{key:"render",value:function(){var o=this;this.options.model.getLayout().then(function(t){o.layout=t,console.log("layout",t),o.checkForData().then(function(){var e={};1===t.qHyperCube.qDimensionInfo.length&&1===t.qHyperCube.qMeasureInfo.length?e=o.transformMultiMeasure():1===t.qHyperCube.qDimensionInfo.length&&1<t.qHyperCube.qMeasureInfo.length?e=o.transformMultiMeasure():1<t.qHyperCube.qDimensionInfo.length?e=o.transformMultiDimensions():0===t.qHyperCube.qDimensionInfo.length&&0<t.qHyperCube.qMeasureInfo.length&&(e=o.transformNoDimensions()),t.refLine&&t.refLine.refLines&&0<t.refLine.refLines.length&&(e.refLines=t.refLine.refLines.filter(function(e){return!1!==e.show}).map(function(e){return{value:e.refLineExpr.value,displayValue:e.refLineExpr.label,label:e.showLabel?e.label:"",color:(e.paletteColor||{color:"#000000"}).color||"#000000",lineWidth:(e.style||{lineThickness:1}).lineThickness||1,lineStyle:(e.style||{lineType:""}).lineType||""}})),o.chart.render(e)})})}},{key:"resize",value:function(){this.chart.render()}},{key:"transformBasic",value:function(){var t=this,o=_extends({},this.optionDefaults,this.layout.options,this.options.chartOptions);this.addOptions(o.data.left,this.layout.qHyperCube.qMeasureInfo[0].options||{}),o.data.left.min=this.layout.qHyperCube.qMeasureInfo[0].qMin,o.data.left.max=this.layout.qHyperCube.qMeasureInfo[0].qMax,o.data.left.label=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,this.addOptions(o.data.bottom,this.layout.qHyperCube.qDimensionInfo[0].options||{}),o.data.bottom.label=this.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle,o.data.bottom.data=[],o.data.left.title=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,o.data.left.formatter=function(e){return t.formatValue(e,t.layout.qHyperCube.qMeasureInfo[0].options||{},t.layout.qHyperCube.qMeasureInfo[0])};var n=this.layout.qHyperCube.qMeasureInfo[0].options||{};return n.data=[],n.key=this.createSeriesKey(this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle),this.layout.qHyperCube.qDataPages[0].qMatrix.forEach(function(e){e[0].value=e[0].qText,e[1].value=isNaN(e[1].qNum)?0:e[1].qNum,e[1].tooltipValue=e[1].qText,e[1].label=e[1].qText,o.data.bottom.data.push(e[0]),n.data.push({x:e[0],y:e[1]})}),o.data.series=[n],o}},{key:"transformMultiDimensions",value:function(){var i=this,s=_extends({},this.optionDefaults,this.layout.options,this.options.chartOptions),r="bottom",e="left";"horizontal"===s.orientation&&(r="left",e="bottom"),this.addOptions(s.data.left,this.layout.qHyperCube.qMeasureInfo[0].options||{}),s.data[r].scale="Band",s.data[e].scale="Linear",s.data[e].label=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,this.addOptions(s.data[r],this.layout.qHyperCube.qDimensionInfo[1].options||{}),s.data[r].label=this.layout.qHyperCube.qDimensionInfo[1].qFallbackTitle,s.data[r].data=[],s.data[e].title=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,s.data[e].formatter=function(e){return i.formatValue(e,i.layout.qHyperCube.qMeasureInfo[0].options||{},i.layout.qHyperCube.qMeasureInfo[0])};var l=[],u=[],c=[],p=[],d=[];return this.layout.qHyperCube.qDataPages[0].qMatrix.forEach(function(e){var t=u.indexOf(e[0].qText),o=c.indexOf(e[1].qText),n=e[1].qText;"Time"===(i.layout.qHyperCube.qDimensionInfo[1].options||{}).scale&&(n=i.fromQlikDate(e[1].qNum)),-1===o&&(c.push(n),p.push(0),d.push(0),e[1].value=n,s.data[r].data.push(e[1]),o=c.length-1),-1===t&&(u.push(e[0].qText),t=u.length-1,l.push({key:"series_".concat(t),type:s.type||"bar",accumulative:0,label:e[0].qText,data:[]}));var a=e[2];a.value=a.qNum,a.label=a.qText,a.color=i.getColor(a,i.layout.qHyperCube.qMeasureInfo[0]),a.tooltipLabel=e[0].qText,a.tooltipValue=a.qText,a.accumulative=p[o],"NaN"!==a.value&&(d[o]+=a.value,p[o]+=a.value),!isNaN(a.value)&&l[t].data.push({x:{value:n},y:a})}),s.data.series=l,s.data[e].min=this.layout.qHyperCube.qMeasureInfo[0].qMin,s.data[e].max=Math.max.apply(Math,d),s}},{key:"transformNoDimensions",value:function(){var o=this,t=_extends({},this.optionDefaults,this.layout.options,this.options.chartOptions),n="bottom",a="left";return"horizontal"===t.orientation&&(n="left",a="bottom"),t.data[n].scale="Band",t.data[a].scale="Linear",t.data[n].padding=t.padding||0,t.data[n].data=[],t.xTitle&&(t.data[n].title=t.xTitle,t.data[n].showTitle=!0,t.data[n].titlePosition=1),t.data[a].formatter=function(e){return o.formatValue(e,t||{})},this.layout.qHyperCube.qMeasureInfo.forEach(function(e){t.data[n].data.push({value:e.qFallbackTitle}),t.data[a].min=Math.min(t.data[a].min,e.qMin),t.data[a].max=Math.max(t.data[a].max,e.qMax)}),t.yMinOverride&&(t.data[a].min=t.yMinOverride),t.yMaxOverride&&(t.data[a].max=t.yMaxOverride),this.layout.qHyperCube.qDataPages[0]&&(t.data.series=[{key:this.layout.qInfo.qId,type:t.type||"bar",color:t.color,data:this.layout.qHyperCube.qDataPages[0].qMatrix.map(function(e){return e.map(function(e,t){return e.value=isNaN(e.qNum)?0:e.qNum,e.qAttrExps&&e.qAttrExps.qValues[0]&&e.qAttrExps.qValues[0].qText&&(e.label=e.qAttrExps.qValues[0].qText),{x:{value:o.layout.qHyperCube.qMeasureInfo[t].qFallbackTitle},y:e}})})[0]}]),t}},{key:"transformMultiMeasure",value:function(){var a=this,i=_extends({},this.optionDefaults,this.layout.options,this.options.chartOptions),s="bottom",n="left",r="right";if("horizontal"===i.orientation&&(s="left","right",n="bottom",r="top"),i.data[n].min=0,i.data[n].max=0,i.data[r].min=0,i.data[r].max=0,i.data[s].padding=i.padding||0,i.data.series=this.layout.qHyperCube.qMeasureInfo.map(function(t,e){var o=_extends({},t.options);return o.key=a.createSeriesKey(t.qFallbackTitle),o.data=[],o.type=(t.options||{}).type||i.type||"bar",o.accumulative=0,"secondary"===t.axis?(a.addOptions(i.data[r],t.options||{}),"stacked"!==i.grouping&&(i.data[r].min=Math.min(i.data[r].min,t.qMin),i.data[r].max=Math.max(i.data[r].max,t.qMax)),i.data[r].scale=(t.options||{}).scale||"Linear",i.data[r].title=t.qFallbackTitle,i.data[r].formatter=function(e){return a.formatValue(e,_extends({},t.options,i.data[r]),t)}):(a.addOptions(i.data[n],t.options||{}),"stacked"!==i.grouping&&(i.data[n].min=Math.min(i.data[n].min,t.qMin),i.data[n].max=Math.max(i.data[n].max,t.qMax)),console.log("max",i.data[n].max),i.data[n].scale=(t.options||{}).scale||"Linear",i.data[n].title=t.qFallbackTitle,i.data[n].formatter=function(e){return a.formatValue(e,_extends({},t.options,i.data[n]),t)}),o}),this.addOptions(i.data[s],this.layout.qHyperCube.qDimensionInfo[0].options||{}),i.data[s].ticks&&-1!==i.data[s].ticks.indexOf("d3.time")){var e=i.data[s].ticks.split(".").pop();i.data[s]=d3.time[e]}i.data[s].title=this.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle,i.data[s].data=[],i.data[s].min=this.layout.qHyperCube.qDimensionInfo[0].qMin,i.data[s].max=this.layout.qHyperCube.qDimensionInfo[0].qMax,i.data[s].scale=(this.layout.qHyperCube.qDimensionInfo[0].options||{}).scale||"Band","Time"!==i.data[s].scale?i.data[s].formatter=function(e){return a.formatValue(e,a.layout.qHyperCube.qDimensionInfo[0].options||{},a.layout.qHyperCube.qMeasureInfo[0])}:(i.data[s].min=this.fromQlikDate(this.layout.qHyperCube.qDimensionInfo[0].qMin),i.data[s].max=this.fromQlikDate(this.layout.qHyperCube.qDimensionInfo[0].qMax));var l=[],u=[],c=[];return this.layout.qHyperCube.qDataPages[0].qMatrix.map(function(n){n.forEach(function(e,t){if(0!==t){var o=n[0];o.value=o.qText,"Time"===(a.layout.qHyperCube.qDimensionInfo[0].options||{}).scale&&(o.value=a.fromQlikDate(o.qNum)),-1===l.indexOf(o.qElemNumber)&&(l.push(o.qElemNumber),c.push(0),u.push(0),i.data[s].data.push(o)),e.value=isNaN(e.qNum)?0:e.qNum,u[l.indexOf(o.qElemNumber)]+=e.value,e.tooltipLabel=a.layout.qHyperCube.qMeasureInfo[t-1].qFallbackTitle,e.tooltipValue=e.qText,e.label=e.qText,e.index=t,e.accumulative=c[l.indexOf(o.qElemNumber)],c[l.indexOf(o.qElemNumber)]+=e.value,o.index=l.indexOf(o.value),i.data.series[t-1].data.push({x:o,y:e})}else"Time"!==i.data[s].scale&&(i.data[s].min=i.data[s].min.length<e.qText.length?i.data[s].min:e.qText,i.data[s].max=i.data[s].max.length>e.qText.length?i.data[s].max:e.qText)})}),"stacked"===i.grouping&&(i.data[n].min=0,i.data[n].max=Math.max.apply(Math,u),i.data[r].min=0,i.data[r].max=Math.max.apply(Math,u)),console.log("multi measure options",i,u),i}},{key:"transformDataToMatrix",value:function(e){var i=[];return e.forEach(function(a,e){0<a.qSubNodes.length&&a.qSubNodes.forEach(function(e){var t=[{qText:a.qText,qElemNumber:a.qElemNo}],o={qText:e.qText,qElemNumber:e.qElemNo};if(e.qAttrExps&&(o.qAttrExps=e.qAttrExps),t.push(o),e.qSubNodes&&0<e.qSubNodes.length){var n={qText:e.qSubNodes[0].qText,qNum:e.qSubNodes[0].qValue};e.qSubNodes[0].qAttrExps&&(n.qAttrExps=e.qSubNodes[0].qAttrExps),t.push(n)}i.push([t[1],t[0],t[2]])})}),console.log("stacked matrix",i),i}}]),n}(),CurrentSelections=function(){function i(e,t){var o=this;_classCallCheck(this,i),this.elementId=e;this.options=_extends({},{def:{qInfo:{qType:"currentSelections"},qSelectionObjectDef:{}},backIcon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M448,440a16,16,0,0,1-12.61-6.15c-22.86-29.27-44.07-51.86-73.32-67C335,352.88,301,345.59,256,344.23V424A16,16,0,0,1,229,435.57l-176-168a16,16,0,0,1,0-23.14l176-168A16,16,0,0,1,256,88v80.36c74.14,3.41,129.38,30.91,164.35,81.87C449.32,292.44,464,350.9,464,424a16,16,0,0,1-16,16Z"/></svg>',forwardIcon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M58.79,439.13A16,16,0,0,1,48,424c0-73.1,14.68-131.56,43.65-173.77,35-51,90.21-78.46,164.35-81.87V88a16,16,0,0,1,27.05-11.57l176,168a16,16,0,0,1,0,23.14l-176,168A16,16,0,0,1,256,424V344.23c-45,1.36-79,8.65-106.07,22.64-29.25,15.12-50.46,37.71-73.32,67a16,16,0,0,1-17.82,5.28Z"/></svg>',clearIcon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><line x1="368" y1="368" x2="144" y2="144" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/><line x1="368" y1="144" x2="144" y2="368" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/></svg>'},t),this.hasOpenDropdown=!1,this.dropdowns={},this.current=[];var n=document.getElementById(this.elementId);if(n){n.addEventListener("click",this.handleClick.bind(this));var a='\n      <div class="websy-selection-bar">\n        <div class="left-group">\n          <div class="back">\n            '.concat(this.options.backIcon,'\n          </div>\n          <div class="forward">\n            ').concat(this.options.forwardIcon,'\n          </div>\n          <div class="clear-all">\n            ').concat(this.options.clearIcon,'\n          </div>\n        </div>\n        <div class="no-selections" id="').concat(this.elementId,'_noselections">No Selections</div>\n        <div class="selections-group" id="').concat(this.elementId,'_selections"></div>    \n      </div>\n      ');n.innerHTML=a}this.options.app.createSessionObject(this.options.def).then(function(e){e.on("changed",o.render.bind(o)),o.options.model=e,o.render()})}return _createClass(i,[{key:"onDropdownOpen",value:function(){this.hasOpenDropdown=!0}},{key:"onDropdownClose",value:function(){this.hasOpenDropdown=!1}},{key:"render",value:function(){var s=this,r=document.getElementById("".concat(this.elementId,"_selections")),n=document.getElementById("".concat(this.elementId,"_noselections"));this.options.model.getLayout().then(function(e){for(var t in console.log(e),s.current=[],0<e.qSelectionObject.qSelections.length?(r.classList.add("active"),n.classList.remove("active"),e.qSelectionObject.qSelections.forEach(function(e,t){if(!0!==e.qIsHidden){var o=e.qField.toLowerCase().replace(/ /g,"_");if(s.current.push(o),!s.dropdowns[o]){e.id=o;var n=document.createElement("div");n.id="".concat(s.elementId,"_").concat(o),n.classList.add("selection-tabs"),r.appendChild(n);var a={qInfo:{qType:"filter"},qListObjectDef:{qDef:{qFieldDefs:[e.qField],qSortCriterias:[{qSortByState:1,qSortByAscii:1}]},options:{closeAfterSelection:!1}}},i={};void 0!==s.options.clearIcon&&(i.clearIcon=s.options.clearIcon),void 0!==s.options.searchIcon&&(i.searchIcon=s.options.searchIcon),void 0!==s.options.arrowIcon&&(i.arrowIcon=s.options.arrowIcon),s.options.app.createSessionObject(a).then(function(e){s.dropdowns[o]={instance:new WebsyDesignsQlikPlugins.Dropdown("".concat(s.elementId,"_").concat(o),_extends({},i,{model:e,multiSelect:!0,closeAfterSelection:!1})),model:e},e.on("changed",function(){s.dropdowns[o].instance.render()})})}}})):(r.classList.remove("active"),n.classList.add("active")),s.dropdowns)if(-1===s.current.indexOf(t)){var o=document.getElementById("".concat(s.elementId,"_").concat(t));o&&o.remove(),s.options.app.destroySessionObject(s.dropdowns[t].model.id),delete s.dropdowns[t]}})}},{key:"backSelection",value:function(){this.options.app.back(),this.render()}},{key:"forwardSelection",value:function(){this.options.app.forward(),this.render()}},{key:"clearSelection",value:function(){this.options.app.clearAll(),this.render()}},{key:"handleClick",value:function(e){e.target.classList.contains("back")&&this.backSelection(),e.target.classList.contains("forward")&&this.forwardSelection(),e.target.classList.contains("clear-all")&&this.clearSelection()}}]),i}(),DatePicker=function(){function o(e,t){_classCallCheck(this,o);this.elementId=e,this.monthYearIsDate=!0,this.options=_extends({},{mode:"date",pageSize:1e3,dateFormat:"%_m/%_d/%Y",softLock:!1},t),this.picker=new _websyDesignsEs.default.WebsyDatePicker(e,_extends({},t,{onChange:this.onChange.bind(this),onClear:this.onClear.bind(this)})),this.listening=!0,this.dateList=[],this.selectedRangeIndex=0,this.hourList=new Array(24).fill(0).map(function(e,t){return(t<10?"0":"")+t+":00"}),this.altHourList=new Array(24).fill(0).map(function(e,t){return t+":00"}),"undefined"!=typeof d3?d3.timeFormat?this.formatDate=d3.timeFormat(this.options.dateFormat):d3.time&&d3.time.format?this.formatDate=d3.time.format(this.options.dateFormat):this.formatDate=function(e){return e}:this.formatDate=function(e){return e},this.render()}return _createClass(o,[{key:"checkForData",value:function(){var n=this;return new Promise(function(t,o){!0===n.listening&&(n.listening=!1,n.options.model.getListObjectData("/qListObjectDef",[{qTop:0,qLeft:0,qWidth:1,qHeight:n.options.pageSize}]).then(function(e){n.layout.qListObject.qDataPages=[e[0]],n.listening=!0,t()},function(e){n.listening=!0,o(e)}))})}},{key:"floorDate",value:function(e){return"number"==typeof e&&(e=new Date(e)),new Date(e.setUTCHours(12,0,0,0))}},{key:"fromQlikDate",value:function(e){var t=new Date(Math.round(864e5*(e-25569)));return this.floorDate(t)}},{key:"getField",value:function(o){var n=this;return new Promise(function(t,e){n.field?t(n.field):n.options.app.getField(o).then(function(e){e&&(n.field=e,t(n.field))},e)})}},{key:"toQlikDate",value:function(e){return"number"==typeof e&&(e=new Date(e)),this.formatDate(e).replace(/ /g,"")}},{key:"toQlikDateNum",value:function(e){return"number"==typeof e?Math.floor(e/864e5+25569):Math.floor(e.getTime()/864e5+25569)}},{key:"onChange",value:function(e,t,o){var n=this;this.selectedRangeIndex=o;var a=e.map(function(e){return"date"===n.options.mode?"number"==typeof e?e:e.getTime():"monthyear"===n.options.mode?!0===n.monthYearIsDate?n.toQlikDate(e):(e.getFullYear||(e=new Date(e)),+"".concat(e.getFullYear()).concat(e.getMonth()<9?"0":"").concat(e.getMonth()+1)):e}),i="",s=[];if(t)if("date"===this.options.mode)if(2===a.length&&a[0]!==a[1])for(var r=this.toQlikDateNum(a[0]),l=this.toQlikDateNum(a[1]),u=r;u<l+1;u++)this.completeQlikDateList[u]&&void 0!==this.completeQlikDateList[u].qElemNumber&&s.push(this.completeQlikDateList[u].qElemNumber);else this.completeDateList[a[0]]&&void 0!==this.completeDateList[a[0]].qElemNumber&&s.push(this.completeDateList[a[0]].qElemNumber);else i="".concat(a[0]),1<a.length&&(i=">=".concat(a[0],"<=").concat(a[a.length-1]));else"date"===this.options.mode?s=a.map(function(e){return n.completeDateList[e].qElemNumber}):i=a.join(" ");"hour"===this.options.mode?this.options.model.selectListObjectValues("/qListObjectDef",e.map(function(e){return e.qElemNumber}),!1,this.options.softLock):"date"===this.options.mode?0===s.length||this.options.model.selectListObjectValues("/qListObjectDef",s,!1,this.options.softLock):this.options.model.searchListObjectFor("/qListObjectDef",i).then(function(){n.options.model.acceptListObjectSearch("/qListObjectDef",!1,n.options.softLock)})}},{key:"onClear",value:function(){this.options.onClear?this.options.onClear():this.options.model.clearSelections("/qListObjectDef")}},{key:"render",value:function(){var b=this;this.options.model.getLayout().then(function(y){b.layout=y,b.checkForData().then(function(){var s,r,a=[],i=[];if(y.qListObject.qDataPages[0]&&!0===b.listening){b.completeDateList={},b.completeQlikDateList={};var e,t;if("date"===b.options.mode)e=y.qListObject.qDataPages[0].qMatrix[0][0].qNum,t=y.qListObject.qDataPages[0].qMatrix[y.qListObject.qDataPages[0].qMatrix.length-1][0].qNum;else if("year"===b.options.mode)e=y.qListObject.qDataPages[0].qMatrix[0][0].qNum,(t=y.qListObject.qDataPages[0].qMatrix[y.qListObject.qDataPages[0].qMatrix.length-1][0].qNum)<e&&(t=y.qListObject.qDataPages[0].qMatrix[0][0].qNum,e=y.qListObject.qDataPages[0].qMatrix[y.qListObject.qDataPages[0].qMatrix.length-1][0].qNum,b.options.sortDirection="desc",b.picker.options.sortDirection="desc"),s=e,r=t,b.picker.options.minAllowedYear=e,b.picker.options.maxAllowedYear=t;else if("monthyear"===b.options.mode)if(e=y.qListObject.qDataPages[0].qMatrix[0][0],t=y.qListObject.qDataPages[0].qMatrix[y.qListObject.qDataPages[0].qMatrix.length-1][0],5===e.qNum.toString().length)b.monthYearIsDate=!0,e=b.fromQlikDate(e.qNum),t=b.fromQlikDate(t.qNum);else{b.monthYearIsDate=!1;var o=+e.qNum.toString().substring(0,4),n=+e.qNum.toString().substring(4,6)-1,l=+t.qNum.toString().substring(0,4),u=+t.qNum.toString().substring(4,6)-1;e=new Date(new Date(new Date((new Date).setDate(1)).setMonth(n)).setFullYear(o)),t=new Date(new Date(new Date((new Date).setDate(1)).setMonth(u)).setFullYear(l))}else b.options.mode;var c=t-e;if("monthyear"===b.options.mode){var p=12*(t.getFullYear()-e.getFullYear());c=Math.floor(t.getMonth()-e.getMonth())+p}for(var d=0;d<c+1;d++)if("date"===b.options.mode){var h=b.fromQlikDate(e+d);b.completeDateList[h.getTime()]={qNum:e+d,qState:"Z"},b.completeQlikDateList[e+d]={qNum:e+d,qState:"Z"}}else if("year"===b.options.mode)b.completeDateList[e+d]={qNum:e+d,qState:"Z"};else if("monthyear"===b.options.mode){var q=b.floorDate(new Date(new Date(e.getTime()).setMonth(e.getMonth()+d)));b.completeDateList[q.getTime()]={qNum:!0===b.monthYearIsDate?b.toQlikDateNum(q):"".concat(q.getFullYear()).concat(q.getMonth()<9?"0":"").concat(q.getMonth()+1),qState:"Z"}}else b.options.mode;var f=[];y.qListObject.qDataPages[0].qMatrix.forEach(function(e,t,o){if("date"===b.options.mode)b.completeDateList[b.fromQlikDate(e[0].qNum).getTime()]&&(b.completeDateList[b.fromQlikDate(e[0].qNum).getTime()]=e[0]),b.completeQlikDateList[e[0].qNum]&&(b.completeQlikDateList[e[0].qNum]=e[0]),0===t?s=b.fromQlikDate(e[0].qNum):t===o.length-1&&(r=b.fromQlikDate(e[0].qNum));else if("year"===b.options.mode)b.completeDateList[e[0].qNum]&&(b.completeDateList[e[0].qNum]=e[0]);else if("monthyear"===b.options.mode)if(!0===b.monthYearIsDate)b.completeDateList[b.fromQlikDate(e[0].qNum).getTime()]&&(b.completeDateList[b.fromQlikDate(e[0].qNum).getTime()]=e[0]),b.completeQlikDateList[e[0].qNum]&&(b.completeQlikDateList[e[0].qNum]=e[0]),0===t?s=b.fromQlikDate(e[0].qNum):t===o.length-1&&(r=b.fromQlikDate(e[0].qNum));else{var n=e[0],a=+n.qNum.toString().substring(0,4),i=+n.qNum.toString().substring(4,6)-1;n=b.floorDate(new Date(new Date(new Date((new Date).setDate(1)).setMonth(i)).setFullYear(a))),b.completeDateList[n.getTime()]&&(b.completeDateList[n.getTime()]=e[0]),0===t?s=n:t===o.length-1&&(r=n)}else"hour"===b.options.mode&&f.push(_extends({},e[0],{text:e[0].qText,num:e[0].qNum}))});var m=Object.values(b.completeDateList);"hour"===b.options.mode&&(m=f),m.forEach(function(e){if(-1!==["S","L","XS","XL"].indexOf(e.qState))if("date"===b.options.mode)i.push(b.fromQlikDate(e.qNum));else if("monthyear"===b.options.mode)if(!0===b.monthYearIsDate)i.push(b.fromQlikDate(e.qNum));else{var t=+e.qNum.toString().substring(0,4),o=+e.qNum.toString().substring(4,6)-1;e=b.floorDate(new Date(new Date(new Date((new Date).setDate(1)).setMonth(o)).setFullYear(t))),i.push(e)}else if("hour"===b.options.mode){var n=b.hourList.indexOf(e.qText);-1!==n?i.push(n):-1!==(n=b.altHourList.indexOf(e.qText))&&i.push(n)}else i.push(e.qNum);-1!==["Z"].indexOf(e.qState)&&("date"===b.options.mode?a.push(b.fromQlikDate(e.qNum)):"monthyear"===b.options.mode?!0===b.monthYearIsDate?a.push(b.fromQlikDate(e.qNum)):a.push(e.qNum):"hour"===b.options.mode?a.push(e.qText):a.push(e.qNum))}),(b.options.minAllowedDate||b.options.maxAllowedDate)&&(s=b.options.minAllowedDate,r=b.options.maxAllowedDate),"hour"===b.options.mode&&(b.picker.options.hours=m),b.picker.setDateBounds([s,r]),b.selectedRangeIndex<0&&(i.length===y.qListObject.qDataPages[0].qMatrix.length||(0<i.length?b.picker.selectCustomRange(i):0===i.length&&b.picker.selectRange(0,!1))),b.picker.render(a),b.listening=!0}})})}}]),o}(),Dropdown=function(){function n(e,t){var o=this;_classCallCheck(this,n),this.elementId=e;this.options=_extends({},{pageSize:100,path:"",useVariable:!1},t),t.def||(t.def={options:{}}),this.busy=!1,this.dropdownOptions=_extends({},t,t.def.options||{},{onItemSelected:this.itemSelected.bind(this),onClearSelected:this.clearSelected.bind(this),onSearch:this.search.bind(this),onCancelSearch:this.cancelSearch.bind(this),onScroll:this.handleScroll.bind(this),onOpen:this.onOpen.bind(this),onClose:this.onClose.bind(this),customActions:[{label:"Select All",fn:function(){o.options.model.selectListObjectAll("/".concat(o.options.path,"/qListObjectDef").replace(/\/\//g,"/")).then(function(){o.render()})}},{label:"Select Possible",fn:function(){o.options.model.selectListObjectPossible("/".concat(o.options.path,"/qListObjectDef").replace(/\/\//g,"/")).then(function(){o.render()})}},{label:"Select Alternative",fn:function(){o.options.model.selectListObjectAlternative("/".concat(o.options.path,"/qListObjectDef").replace(/\/\//g,"/")).then(function(){o.render()})}},{label:"Select Excluded",fn:function(){o.options.model.selectListObjectExcluded("/".concat(o.options.path,"/qListObjectDef").replace(/\/\//g,"/")).then(function(){o.render()})}}]}),this.dropdown=new _websyDesignsEs.default.WebsyDropdown(e,this.dropdownOptions),this.render()}return _createClass(n,[{key:"cancelSearch",value:function(e){this.options.model.abortListObjectSearch("/".concat(this.options.path,"/qListObjectDef").replace(/\/\//g,"/"))}},{key:"checkForData",value:function(){var n=this;return new Promise(function(t,o){!1===n.busy&&(n.busy=!0,n.options.model.getListObjectData("/".concat(n.options.path,"/qListObjectDef").replace(/\/\//g,"/"),[{qTop:n.rowsLoaded,qLeft:0,qWidth:1,qHeight:n.options.pageSize}]).then(function(e){""!==n.options.path?(n.layout[n.options.path].qListObject.qDataPages[0].qMatrix=n.layout[n.options.path].qListObject.qDataPages[0].qMatrix.concat((e[0]||{qMatrix:[]}).qMatrix),n.rowsLoaded=n.layout[n.options.path].qListObject.qDataPages[0].qMatrix.length):(n.layout.qListObject.qDataPages[0]||(n.layout.qListObject.qDataPages[0]={qMatrix:[]}),n.layout.qListObject.qDataPages[0].qMatrix=n.layout.qListObject.qDataPages[0].qMatrix.concat((e[0]||{qMatrix:[]}).qMatrix),n.rowsLoaded=n.layout.qListObject.qDataPages[0].qMatrix.length),n.busy=!1,t()},function(e){n.busy=!1,o(e)}))})}},{key:"checkForVariable",value:function(){var o=this;return new Promise(function(t,e){!0===o.options.useVariable&&o.options.variable&&o.options.app?o.options.app.getVariableByName(o.options.variable).then(function(e){e.getLayout().then(function(e){t(e)})}):t()})}},{key:"clearSelected",value:function(){this.options.model.clearSelections("/".concat(this.options.path,"/qListObjectDef").replace(/\/\//g,"/"))}},{key:"onClose",value:function(e){var t=this;this.options.model.endSelections(!0).then(function(){t.options.onClose&&t.options.onClose(e)})}},{key:"handleScroll",value:function(e){var t=this;.7<e.target.scrollTop/(e.target.scrollHeight-e.target.clientHeight)&&this.checkForData().then(function(){t.dropdown.data=t.transformData()})}},{key:"itemSelected",value:function(t,o,n){var a=this;!0===this.options.useVariable&&this.options.variable&&this.options.app?this.options.app.getVariableByName(this.options.variable).then(function(e){"NaN"===t.qNum?e.setStringValue(t.qText).then(function(){a.options.onItemSelected&&a.options.onItemSelected(t,o,n)}):e.setNumValue(t.qNum).then(function(){a.options.onItemSelected&&a.options.onItemSelected(t,o,n)})}):this.options.model.selectListObjectValues("/".concat(this.options.path,"/qListObjectDef").replace(/\/\//g,"/"),[t.qElemNumber],!0===this.dropdown.options.multiSelect).then(function(){a.options.onItemSelected&&a.options.onItemSelected(t,o,n)})}},{key:"onOpen",value:function(){console.log("dropdown open"),this.options.model.beginSelections(["/".concat(this.options.path,"/qListObjectDef").replace(/\/\//g,"/")])}},{key:"open",value:function(){this.dropdown.open()}},{key:"render",value:function(){var o=this;this.options.model&&(this.rowsLoaded=0,this.options.model.getLayout().then(function(e){o.layout=e,o.checkForVariable().then(function(e){var t=""!==o.options.path?o.layout[o.options.path].qListObject:o.layout.qListObject;t.qDataPages&&0!==t.qDataPages.length||(t.qDataPages=[{qMatrix:[]}]),t.qDimensionInfo.qLocked?o.dropdown.options.allowClear=!1:o.dropdown.options.allowClear=void 0===o.options.allowClear||o.options.allowClear,o.rowsLoaded=t.qDataPages[0].qMatrix.length,o.checkForData().then(function(){t.qDataPages[0]&&(o.dropdown.options.label=t.qDimensionInfo.qFallbackTitle,o.dropdown.data=o.transformData(e))})})}))}},{key:"search",value:function(e){this.options.model.searchListObjectFor("/".concat(this.options.path,"/qListObjectDef").replace(/\/\//g,"/"),"*".concat(e,"*"))}},{key:"transformData",value:function(e){var o={},t=""!==this.options.path?this.layout[this.options.path].qListObject:this.layout.qListObject,n=t.qDataPages[0].qMatrix.map(function(e){return e[0].qText});if(!0===this.options.hideExcluded&&(t.qDataPages[0].qMatrix=t.qDataPages[0].qMatrix.filter(function(e){return-1===["X","XS","XL"].indexOf(e[0].qState)})),e){var a=n.indexOf(e.qText);-1!==a&&(this.dropdown.selectedItems=[a])}else t.qDataPages[0].qMatrix.forEach(function(e,t){o[e[0].qState]||(o[e[0].qState]=[]),o[e[0].qState].push(t)}),o.S&&0<o.S.length?this.dropdown.selectedItems=o.S:o.L&&0<o.L.length?this.dropdown.selectedItems=o.L:(o.L&&0===o.L.length||o.S&&0===o.S.length)&&o.O&&1===o.O.length?this.dropdown.selectedItems=o.O:this.dropdown.selectedItems=[];return t.qDataPages[0].qMatrix.map(function(e,t){return _extends(e[0],{index:t,label:e[0].qText||"-",classes:["state-".concat(e[0].qState)]})})}}]),n}(),KPI=function(){function o(e,t){_classCallCheck(this,o),this.elementId=e,this.options=_extends({},t),this.kpiOptions={},this.kpi=new _websyDesignsEs.default.WebsyKPI(e,this.kpiOptions),this.render()}return _createClass(o,[{key:"close",value:function(){this.kpiOptions.value={value:"-"},this.kpiOptions.subValue={value:""},this.kpi.render(this.kpiOptions)}},{key:"render",value:function(){var n=this;this.options.model.getLayout().then(function(e){var t=e.kpi.qHyperCube.qDataPages[0].qMatrix[0][0].qText;if(n.kpiOptions.value={value:t},n.kpiOptions.label={value:e.kpi.qHyperCube.qMeasureInfo[0].qFallbackTitle},e.icon&&(n.kpiOptions.icon="".concat(window.location.origin,"/resources/svg/").concat(e.icon,".svg")),e.tooltip&&e.tooltip.value&&(n.kpiOptions.tooltip={value:e.tooltip.value},e.tooltip.classes&&(n.kpiOptions.tooltip.classes=e.tooltip.classes)),n.kpiOptions.subValue={value:""},e.kpi.qHyperCube.qMeasureInfo[1]){void 0!==e.kpi.qHyperCube.qMeasureInfo[1].decimals&&e.kpi.qHyperCube.qMeasureInfo[1].decimals;var o=e.kpi.qHyperCube.qDataPages[0].qMatrix[0][1].qText;n.kpiOptions.subValue={value:"".concat(e.kpi.qHyperCube.qMeasureInfo[1].qFallbackTitle," ").concat(o)}}n.kpi.render(n.kpiOptions)})}},{key:"resize",value:function(){this.kpi.resize()}}]),o}(),GeoMap=function(){function n(t,e){var o=this;_classCallCheck(this,n),this.elementId=t;this.options=_extends({},{geoFillColor:"#783c96",geoAutoFill:!0,geoShowTooltip:!0},e,e.def.options),this.options.geoJSON&&"string"==typeof this.options.geoJSON?_websyDesignsEs.default.service.get(this.options.geoJSON).then(function(e){o.geoJSON=e,delete o.options.geoJSON,o.map=new _websyDesignsEs.default.WebsyMap(t,o.options),o.render()}):(this.map=new _websyDesignsEs.default.WebsyMap(t,this.options),this.render())}return _createClass(n,[{key:"findGeoJsonByProperty",value:function(e){for(var t=0;t<this.geoJSON.features.length;t++)if(this.geoJSON.features[t].properties.name.toLowerCase()===e.toLowerCase())return this.geoJSON.features[t];return null}},{key:"render",value:function(){var n=this,e=document.getElementById(this.elementId);e.parentElement&&e.parentElement.classList.add("loading"),this.options.model.getLayout().then(function(a){if(a.options&&(n.options=_extends({},n.options,a.options)),a.qHyperCube.qDataPages[0]){if(n.geoJSON){var o={type:"FeatureCollection",features:[]};a.qHyperCube.qDataPages[0].qMatrix.forEach(function(e){var t=n.findGeoJsonByProperty(e[0].qText);t&&(!0===n.options.geoAutoFill&&(t.fillColor=n.options.geoFillColor,t.fillOpacity=.4+e[1].qNum/a.qHyperCube.qMeasureInfo[0].qMax*.6),e[1].qAttrExps&&e[1].qAttrExps.qValues&&e[1].qAttrExps.qValues[0]&&e[1].qAttrExps.qValues[0].qText&&(t.fillColor=e[1].qAttrExps.qValues[0].qText),!0===n.options.geoShowTooltip&&(t.tooltip="".concat(e[1].qText,"<br>").concat(t.properties.label),t.tooltipClass="websy-map-tooltip"),o.features.push(t))}),n.map.options.geoJSON=o}var i={};a.qHyperCube.qDataPages[0].qMatrix.forEach(function(n){n.forEach(function(e,t){if(0!==t&&"polygon"===(a.qHyperCube.qMeasureInfo[t-1].options||{}).type){i.polygons||(i.polygons=[]);var o=JSON.parse("[".concat(e.qText,"]"));i.polygons.push({label:n[0].qText,data:o.map(function(e){return e.map(function(e){return{Latitude:e[1],Longitude:e[0]}})})})}})}),n.map.options.data=i,e.parentElement&&e.parentElement.classList.remove("loading"),n.map.render()}})}}]),n}(),SimpleSearch=function(){function o(e,t){_classCallCheck(this,o),this.elementId=e,this.options=_extends({},t),this.paused=!1,this.searchText="",document.getElementById(this.elementId)&&(this.search=new _websyDesignsEs.default.Search(this.elementId,{placeholder:this.options.placeholder,onSubmit:this.handleSearchSubmit.bind(this),onClear:this.handleSearchClear.bind(this)}))}return _createClass(o,[{key:"handleSearchClear",value:function(){this.options.model.clearSelections("/qListObjectDef"),this.searchText="",this.options.onClear&&this.options.onClear()}},{key:"handleSearchSubmit",value:function(e){var t=this;this.searchText=e,this.paused=!0,this.options.model.searchListObjectFor("/qListObjectDef","*".concat(e,"*")).then(function(e){t.options.model.acceptListObjectSearch("/qListObjectDef",!1).then(function(){t.paused=!1,t.render()})})}},{key:"render",value:function(){var t=this;!0!==this.paused&&this.options.model.getLayout().then(function(e){t.options.onResults&&t.options.onResults(0===t.searchText.length||0!==e.qListObject.qDimensionInfo.qStateCounts.qSelected&&0<t.searchText.length)})}}]),o}(),Table=function(){function n(e,t){_classCallCheck(this,n);this.elementId=e,this.options=_extends({},{pageSize:50},t),this.rowCount=0,this.pageNum=0,this.pageCount=0,this.errorCount=0,this.retryFn=null,this.pivotIndent=!1,this.busy=!1,this.table=new _websyDesignsEs.default.WebsyTable(this.elementId,_extends({},{onClick:this.handleClick.bind(this),onScroll:this.handleScroll.bind(this),onSort:this.handleSort.bind(this),onChangePageSize:this.setPageSize.bind(this),onSetPage:this.setPageNum.bind(this)},this.options));var o=document.getElementById(this.elementId);o&&o.addEventListener("click",this.handleClick.bind(this)),this.render()}return _createClass(n,[{key:"appendRows",value:function(e){this.table.appendRows(e)}},{key:"getData",value:function(t){var o=this;if(!1===this.busy)if((this.busy=!0)===this.options.getAllData)getAllData("qHyperCube",this.options.model,this.layout,function(e){o.rowCount=e.qHyperCube.qDataPages[0].qMatrix.length,o.busy=!1,t&&t(e.qHyperCube.qDataPages[0].qMatrix)});else{var e=[{qTop:this.rowCount,qLeft:0,qWidth:this.dataWidth,qHeight:1e4<this.dataWidth*this.options.pageSize?Math.floor(1e4/this.dataWidth):this.options.pageSize}];if(this.rowCount<this.layout.qHyperCube.qSize.qcy){var n="getHyperCubeData";"P"===this.layout.qHyperCube.qMode&&(n="getHyperCubePivotData"),this.options.model[n]("/qHyperCubeDef",e).then(function(e){e&&e[0]&&("P"===o.layout.qHyperCube.qMode?(o.layout.qHyperCube.qPivotDataPages.push(e[0]),o.rowCount+=e[0].qData.length):(e[0].qMatrix=e[0].qMatrix.filter(function(e){return"-"!==e[0].qText}),o.layout.qHyperCube.qDataPages.push(e[0]),o.rowCount+=e[0].qMatrix.length),o.busy=!1,t&&("P"===o.layout.qHyperCube.qMode?t(e[0]):t(e[0].qMatrix)))},function(e){o.errorCount<50&&(o.errorCount++,console.log("error getting data, attempt",o.errorCount),clearTimeout(o.retryFn),o.retryFn=setTimeout(function(){o.getData(t)},300))})}else this.busy=!1}}},{key:"getFontColor",value:function(e){var t,o,n,a;return-1!==e.indexOf("#")?(t=(t=e.toLowerCase().replace("#","")).split(""),o=parseInt(t[0]+t[1],16),n=parseInt(t[2]+t[3],16),a=parseInt(t[4]+t[5],16)):-1!==e.toLowerCase().indexOf("rgb")&&(o=(t=(t=e.toLowerCase().replace("rgb(","").replace(")","")).split(","))[0],n=t[1],a=t[2]),186<.299*o+.587*n+.114*a?"#000000":"#ffffff"}},{key:"handleClick",value:function(e,t,o,n){e.target.classList.contains("table-try-again")?this.render():t&&t.qElemNumber&&this.options.model.selectHyperCubeValues("/qHyperCubeDef",0,[t.qElemNumber],!1)}},{key:"handleScroll",value:function(e){var t=this;.7<e.target.scrollTop/(e.target.scrollHeight-e.target.clientHeight)&&this.getData(function(e){t.appendRows(t.transformData(e))})}},{key:"handleSort",value:function(e,t,o){var n=!0===t.reverseSort,a=[{qOp:"replace",qPath:"/qHyperCubeDef/qInterColumnSortOrder",qValue:JSON.stringify([o])}],i=o<this.layout.qHyperCube.qDimensionInfo.length?"qDimensions":"qMeasures",s=o<this.layout.qHyperCube.qDimensionInfo.length?o:o-this.layout.qHyperCube.qDimensionInfo.length;a.push({qOp:"replace",qPath:"/qHyperCubeDef/".concat(i,"/").concat(s,"/qDef/qReverseSort"),qValue:JSON.stringify(n)}),this.options.model.applyPatches(a,!0)}},{key:"render",value:function(){var n=this,a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;this.table.showLoading({message:"Loading..."}),this.options.model.getLayout().then(function(e){if(console.log(e),n.layout=e,n.rowCount=a*n.options.pageSize,n.errorCount=0,n.pageNum=a,n.pageCount=Math.ceil(e.qHyperCube.qSize.qcy/n.options.pageSize),n.table.options.pageNum=n.pageNum,n.table.options.pageCount=n.pageCount,e.qHyperCube.qError&&e.qHyperCube.qCalcCondMsg)return n.table.hideLoading(),void n.table.showError({message:n.options.customError||e.qHyperCube.qCalcCondMsg});n.dataWidth=n.layout.qHyperCube.qSize.qcx,n.columnOrder=n.layout.qHyperCube.qColumnOrder,void 0===n.columnOrder&&(n.columnOrder=new Array(n.layout.qHyperCube.qSize.qcx).fill({}).map(function(e,t){return t}));var t=n.layout.qHyperCube.qDimensionInfo.concat(n.layout.qHyperCube.qMeasureInfo),o=n.layout.qHyperCube.qEffectiveInterColumnSortOrder[0];(t=t.map(function(e,t){return e.colIndex=n.columnOrder.indexOf(t),e.name=e.qFallbackTitle,e.tooltip&&(e.name+='\n          <div class="websy-info websy-info-dock-right" data-info="'.concat(e.tooltip,'">\n            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512"><path d="M256,56C145.72,56,56,145.72,56,256s89.72,200,200,200,200-89.72,200-200S366.28,56,256,56Zm0,82a26,26,0,1,1-26,26A26,26,0,0,1,256,138Zm48,226H216a16,16,0,0,1,0-32h28V244H228a16,16,0,0,1,0-32h32a16,16,0,0,1,16,16V332h28a16,16,0,0,1,0,32Z"/></svg>\n          </div>\n          ')),e.reverseSort=o===t&&!0!==e.qReverseSort,e.activeSort=o===t,"A"===e.qSortIndicator?e.sort="asc":"D"===e.qSortIndicator&&(e.sort="desc"),e})).sort(function(e,t){return e.colIndex-t.colIndex}),n.getData(function(e){(n.table.options.columns=t,n.table.options.activeSort=o,n.table.hideLoading(),n.table.render(),e.err)?document.getElementById("".concat(n.elementId,"_foot")).innerHTML="\n            <div class='request-abort-error'>Could not fetch data. Click <strong class='table-try-again'>here</strong> to try again</div>\n          ":n.appendRows(n.transformData(e))})},function(e){n.errorCount<50&&(n.errorCount++,console.log("error getting layout, attempt",n.errorCount),clearTimeout(n.retryFn),n.retryFn=setTimeout(function(){n.render()},300))})}},{key:"setPageNum",value:function(e){this.render(e)}},{key:"setPageSize",value:function(e){this.options.pageSize=e,this.render()}},{key:"transformData",value:function(e){var i=this;if(console.log("page",e),"S"===this.layout.qHyperCube.qMode)return e.map(function(e){return e.map(function(o,e){if((!0===i.table.options.columns[e].showAsLink||!0===i.table.options.columns[e].showAsNavigatorLink)&&o.qAttrExps&&o.qAttrExps.qValues&&o.qAttrExps.qValues[0].qText?(o.value=o.qAttrExps.qValues[0].qText,-1===o.value.indexOf("https://")&&(o.value="https://".concat(o.value)),o.displayText=o.qText||"-"):o.value=o.qText||"-",o.qAttrExps&&o.qAttrExps.qValues){var n="qDimensionInfo",a=e;e>i.layout.qHyperCube.qDimensionInfo.length-1&&(n="qMeasureInfo",a-=i.layout.qHyperCube.qDimensionInfo.length),o.qAttrExps.qValues.forEach(function(e,t){e.qText&&""!==e.qText&&("cellForegroundColor"===i.layout.qHyperCube[n][a].qAttrExprInfo[t].id?o.color=e.qText:"cellBackgroundColor"===i.layout.qHyperCube[n][a].qAttrExprInfo[t].id&&(o.backgroundColor=e.qText))})}return o})});var t=this.transformPivotTable(e);return this.table.options.columns=t.shift(),this.table.render(),t}},{key:"transformPivotTable",value:function(e){for(var t=[],u=[],c=[],p=0,d=0,h=0,q=0,f=[],o=0;o<e.qLeft.length;o++)g.call(this,e.qLeft[o],0,0,null,[]);for(var n=0;n<e.qTop.length;n++)v.call(this,e.qTop[n],0,n);for(var a=0;a<e.qData.length;a++){for(var i=e.qData[a],s=0;s<i.length;s++){i[s].pos="Data",i[s].qAttrExps&&i[s].qAttrExps.qValues&&i[s].qAttrExps.qValues[0]&&i[s].qAttrExps.qValues[0].qText&&(i[s].backgroundColor=i[s].qAttrExps.qValues[0].qText,i[s].color=this.getFontColor(i[s].qAttrExps.qValues[0].qText)),i[s].qAttrExps&&i[s].qAttrExps.qValues&&i[s].qAttrExps.qValues[1]&&i[s].qAttrExps.qValues[1].qText&&(i[s].color=this.getFontColor(i[s].qAttrExps.qValues[1].qText));var r=c[c.length-1][s];-1===["T","E"].indexOf(i[s].qType)&&-1===["T"].indexOf(r.qType)||(i[s].qType="T"),i[s].value=i[s].qText}u[a]&&(i=u[a].concat(i)),t.push(i)}for(var l=[],m=h,y=0;y<m;y++)l.push({rowspan:1,colSpan:1,level:0,qText:"",qType:"V"});if(0!==h)for(var b=0;b<c.length;b++)b===c.length-1?c[b]=this.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError}).filter(function(e,t){return t<h}).map(function(e){return{name:e.qFallbackTitle}}).concat(c[b]):c[b]=l.concat(c[b]);function g(e,t,o,n,a){var i=_extends({},e);if(i.level=t,i.pos="Left",i.value=i.qText,e.value=e.qText,h=Math.max(h,t+1),i.childCount=i.qSubNodes.length,i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[0]&&i.qAttrExps.qValues[0].qText&&(i.backgroundColor=i.qAttrExps.qValues[0].qText,i.color=this.getFontColor(i.qAttrExps.qValues[0].qText)),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[1]&&i.qAttrExps.qValues[1].qText&&(i.color=this.getFontColor(i.qAttrExps.qValues[1].qText)),delete i.qSubNodes,void 0===i.qText&&(-1===i.qElemNo?i.qText="Totals??":-4===i.qElemNo&&(i.qText="",i.qType="T")),i.rowspan=Math.max(1,e.qSubNodes.length),e.rowspan=Math.max(1,e.qSubNodes.length),0===e.qSubNodes.length)u.push(f.concat([i])),f=[];else{f.push(i);for(var s=0;s<e.qSubNodes.length;s++)g.call(this,e.qSubNodes[s],t+1,s,e,[].concat(_toConsumableArray(a),[i]));for(var r=0,l=0;l<e.qSubNodes.length;l++)r+=e.qSubNodes[l].rowspan;e.rowspan=r,i.rowspan=r}}function v(e,t,o,n){var a;void 0===c[t]&&(c[t]=[]);var i=_extends({},e);if(i.level=t,i.pos="Top",i.rowIndex=p,i.topNode=!0,i.isHeader=!0,i.name=i.qText,i.font||(i.font={}),e.value=e.qText,"P"===i.qType&&(i.qElemNo=-99),i.childCount=i.qSubNodes.length,q=Math.max(q,t+1),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[0]&&i.qAttrExps.qValues[0].qText&&(i.backgroundColor=i.qAttrExps.qValues[0].qText,i.color=this.getFontColor(i.qAttrExps.qValues[0].qText)),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[1]&&i.qAttrExps.qValues[1].qText&&(i.color=this.getFontColor(i.qAttrExps.qValues[1].qText)),delete i.qSubNodes,-1===["T","E"].indexOf(i.qType)&&(i.qType="B"),void 0!==n&&"T"===n.qType&&(i.qType=n.qType,e.qType=n.qType),void 0===i.qText&&(-1===i.qElemNo?(i.qText=this.layout.tableTotalsLabel,i.name=this.layout.tableTotalsLabel):-4===i.qElemNo&&(i.qText="",i.qType="T",e.qType="T")),i.colSpan=Math.max(1,e.qSubNodes.length),e.colSpan=Math.max(1,e.qSubNodes.length),0===e.qSubNodes.length)-99===i.qElemNo&&!0===i.qCanCollapse&&d++;else{for(var s=0;s<e.qSubNodes.length;s++)v.call(this,e.qSubNodes[s],t+1,s,e);for(var r=0,l=0;l<e.qSubNodes.length;l++)r+=e.qSubNodes[l].colSpan;i.rowIndex=p,p+=r,i.colSpan=r,e.colSpan=r,"T"===i.qType&&-1===i.qElemNo&&(d+=r),-99===i.qElemNo&&d++,!0!==e.qCanExpand&&!0!==e.qCanCollapse||(0<e.qSubNodes.length&&!0===e.qCanCollapse&&void 0!==e.qSubNodes[0].rowIndex?(e.rowIndex=e.qSubNodes[0].rowIndex,i.rowIndex=e.qSubNodes[0].rowIndex):(e.rowIndex=d,i.rowIndex=d,d+=i.colSpan))}var u=[i];1<i.colSpan&&(u=new Array(i.colSpan).fill(_objectSpread({},i))),(a=c[t]).push.apply(a,_toConsumableArray(u))}return c[c.length-1],t=c.concat(t)}}]),n}(),Table2=function(){function n(e,t){_classCallCheck(this,n);Dropdown&&(WebsyDesignsQlikPlugins||_readOnlyError("WebsyDesignsQlikPlugins"),WebsyDesignsQlikPlugins.Dropdown=Dropdown),this.elementId=e,this.options=_extends({},{pageSize:50,cellHeight:35,virtualScroll:!1,columnOverrides:[]},t),this.rowCount=0,this.pageNum=0,this.pageCount=0,this.errorCount=0,this.leftDataCol=0,this.topDataRow=0,this.retryFn=null,this.pivotIndent=!1,this.busy=!1,this.dimensionWidth=0,this.dropdowns=[],this.searchPrepped=!1,this.table=new _websyDesignsEs.default.WebsyTable2(this.elementId,_extends({},{onClick:this.handleClick.bind(this),onScroll:this.handleScroll.bind(this),onSort:this.handleSort.bind(this),onChangePageSize:this.setPageSize.bind(this),onSetPage:this.setPageNum.bind(this),onScrollX:this.handleVirtualScrollX.bind(this)},this.options));var o=document.getElementById(this.elementId);o&&o.addEventListener("click",this.handleClick.bind(this)),this.render()}return _createClass(n,[{key:"appendRows",value:function(e){this.table.appendRows(e)}},{key:"getData",value:function(t){var o=this;if(!1===this.busy)if((this.busy=!0)===this.options.getAllData)getAllData("qHyperCube",this.options.model,this.layout,function(e){o.rowCount=e.qHyperCube.qDataPages[0].qMatrix.length,o.busy=!1,t&&t(e.qHyperCube.qDataPages[0].qMatrix)});else{var e=[{qTop:this.rowCount,qLeft:0,qWidth:this.dataWidth,qHeight:1e4<this.dataWidth*this.options.pageSize?Math.floor(1e4/this.dataWidth):this.options.pageSize}];if(this.rowCount<this.layout.qHyperCube.qSize.qcy){var n="getHyperCubeData";"P"===this.layout.qHyperCube.qMode&&(n="getHyperCubePivotData"),this.options.model[n]("/qHyperCubeDef",e).then(function(e){e&&e[0]&&("P"===o.layout.qHyperCube.qMode?(o.layout.qHyperCube.qPivotDataPages.push(e[0]),o.rowCount+=e[0].qData.length):(e[0].qMatrix=e[0].qMatrix.filter(function(e){return"-"!==e[0].qText}),o.layout.qHyperCube.qDataPages.push(e[0]),o.rowCount+=e[0].qMatrix.length),o.busy=!1,t&&("P"===o.layout.qHyperCube.qMode?t(e[0]):t(e[0].qMatrix)))},function(e){o.errorCount<50&&(o.errorCount++,console.log("error getting data, attempt",o.errorCount),clearTimeout(o.retryFn),o.retryFn=setTimeout(function(){o.getData(t)},300))})}else this.busy=!1}}},{key:"getFontColor",value:function(e){var t,o,n,a;return-1!==e.indexOf("#")?(t=(t=e.toLowerCase().replace("#","")).split(""),o=parseInt(t[0]+t[1],16),n=parseInt(t[2]+t[3],16),a=parseInt(t[4]+t[5],16)):-1!==e.toLowerCase().indexOf("rgb")&&(o=(t=(t=e.toLowerCase().replace("rgb(","").replace(")","")).split(","))[0],n=t[1],a=t[2]),186<.299*o+.587*n+.114*a?"#000000":"#ffffff"}},{key:"handleClick",value:function(e,t,o,n){e.target.classList.contains("table-try-again")?this.render():t&&t.qElemNumber&&this.options.model.selectHyperCubeValues("/qHyperCubeDef",0,[t.qElemNumber],!1)}},{key:"handleScroll",value:function(e){var t=this;.7<e.target.scrollTop/(e.target.scrollHeight-e.target.clientHeight)&&this.getData(function(e){t.appendRows(t.transformData(e))})}},{key:"handleSearch",value:function(e,t){if(console.log(e,t),this.dropdowns[t.searchField]){var o=document.getElementById("".concat(this.elementId,"_columnSearch_").concat(e.target.getAttribute("data-col-index")));o&&(o.classList.toggle("active"),o.style.top="".concat(e.pageY,"px"),o.style.right="calc(100vw - ".concat(e.pageX+e.target.offsetWidth,"px)"),this.dropdowns[t.searchField].open())}}},{key:"handleCloseSearch",value:function(e){document.getElementById(e).classList.remove("active")}},{key:"handleSort",value:function(e,t,o,n){this.table.showLoading({message:"Loading..."});var a=!0===t.reverseSort,i=[{qOp:"replace",qPath:"/qHyperCubeDef/qInterColumnSortOrder",qValue:JSON.stringify([this.columnOrder[n]])}],s=o<this.layout.qHyperCube.qDimensionInfo.length?"qDimensions":"qMeasures",r=this.columnOrder[n]<this.layout.qHyperCube.qDimensionInfo.length?this.columnOrder[n]:this.columnOrder[n]-this.layout.qHyperCube.qDimensionInfo.length;i.push({qOp:"replace",qPath:"/qHyperCubeDef/".concat(s,"/").concat(r,"/qDef/qReverseSort"),qValue:JSON.stringify(a)}),this.options.model.applyPatches(i,!0)}},{key:"handleVirtualScrollX",value:function(e){this.columnParams.scrollableWidth,this.columnParams.scrollableWidth,this.totalWidth;var t=e/this.columnParams.scrollableWidth*this.totalWidth,o=0,n=this.options.freezeColumns||this.layout.qHyperCube.qNoOfLeftDims;this.leftDataCol=0;for(var a=n;a<this.fullColumnList.length&&t>=+this.fullColumnList[a].width.replace("px","")+o;a++)o+=+this.fullColumnList[a].width.replace("px",""),this.leftDataCol=a;this.fullColumnList.length-this.leftDataCol<this.columnsToRender&&(this.leftDataCol=this.fullColumnList.length-this.columnsToRender+1),this.resize()}},{key:"prepDropdowns",value:function(){var o=this;this.layout.qHyperCube.qDimensionInfo.forEach(function(e,t){o.dropdowns["dim".concat(t)]||(o.dropdowns["dim".concat(t)]=new WebsyDesignsQlikPlugins.Dropdown("".concat(o.elementId,"_columnSearch_").concat(t),{model:o.options.model,multiSelect:!0,closeAfterSelection:!1,path:"dim".concat(t),onClose:o.handleCloseSearch}))})}},{key:"prepSearch",value:function(){var t=this;this.busy=!0,this.options.model.getProperties().then(function(e){console.log("props",e);var o=[];e.qHyperCubeDef.qDimensions.forEach(function(e,t){o.push({qOp:"add",qPath:"/dim".concat(t),qValue:JSON.stringify({qListObjectDef:{qDef:_objectSpread(_objectSpread({},e.qDef),{},{qSortCriterias:[{qSortByState:1,qSortByAscii:1}]}),qLibraryId:e.qLibraryId}})})}),t.options.model.applyPatches(o,!0).then(function(){t.busy=!1,t.searchPrepped=!0,t.render()})})}},{key:"render",value:function(){var r=this,l=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;!1!==this.searchPrepped?(this.table.showLoading({message:"Loading..."}),this.options.model.getLayout().then(function(e){if(r.layout=e,r.rowCount=l*r.options.pageSize,r.layout.qHyperCube.qPivotDataPages[0]&&(r.layout.qHyperCube.qPivotDataPages=[]),r.errorCount=0,r.pageNum=l,r.pageCount=Math.ceil(e.qHyperCube.qSize.qcy/r.options.pageSize),r.table.options.pageNum=r.pageNum,r.layout.qHyperCube.qNoOfLeftDims&&(r.table.options.leftColumns=r.options.freezeColumns||r.layout.qHyperCube.qNoOfLeftDims),r.table.options.pageCount=r.pageCount,e.qHyperCube.qError&&e.qHyperCube.qCalcCondMsg)return r.table.hideLoading(),void r.table.showError({message:r.options.customError||e.qHyperCube.qCalcCondMsg});r.table.hideError(),r.dataWidth=r.layout.qHyperCube.qSize.qcx,r.columnOrder=r.layout.qHyperCube.qColumnOrder,void 0===r.columnOrder&&(r.columnOrder=new Array(r.layout.qHyperCube.qSize.qcx).fill({}).map(function(e,t){return t})),r.layout.qHyperCube.qDimensionInfo=r.layout.qHyperCube.qDimensionInfo.map(function(e,t){return e.searchable=!0,r.options.columnOverrides[t]&&(e=_objectSpread(_objectSpread({},e),{},{onSearch:r.handleSearch.bind(r),onCloseSearch:r.handleCloseSearch.bind(r)},r.options.columnOverrides[t])),e.searchField="dim".concat(t),e}),r.layout.qHyperCube.qMeasureInfo=r.layout.qHyperCube.qMeasureInfo.map(function(e,t){return r.options.columnOverrides[r.layout.qHyperCube.qDimensionInfo.length+t]&&(e=_objectSpread(_objectSpread({},e),r.options.columnOverrides[r.layout.qHyperCube.qDimensionInfo.length+t])),e});var t=r.layout.qHyperCube.qDimensionInfo.concat(r.layout.qHyperCube.qMeasureInfo);r.orderedColumns=t.map(function(e,t,o){return o[r.columnOrder[t]]}).filter(function(e){return!e.qError}),r.dimensions=r.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError}),r.measures=r.layout.qHyperCube.qMeasureInfo.filter(function(e){return!e.qError});var o=r.layout.qHyperCube.qEffectiveInterColumnSortOrder[0];(t=t.map(function(e,t){return e.colIndex=r.columnOrder.indexOf(t),e.sortIndex=r.columnOrder.indexOf(t),e.name=e.qFallbackTitle,e.tooltip&&(e.name+='\n          <div class="websy-info websy-info-dock-right" data-info="'.concat(e.tooltip,'">\n            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512"><path d="M256,56C145.72,56,56,145.72,56,256s89.72,200,200,200,200-89.72,200-200S366.28,56,256,56Zm0,82a26,26,0,1,1-26,26A26,26,0,0,1,256,138Zm48,226H216a16,16,0,0,1,0-32h28V244H228a16,16,0,0,1,0-32h32a16,16,0,0,1,16,16V332h28a16,16,0,0,1,0,32Z"/></svg>\n          </div>\n          ')),e.reverseSort=o===e.colIndex&&!0!==e.qReverseSort,e.activeSort=o===e.colIndex,"S"===r.layout.qHyperCube.qMode&&("A"===e.qSortIndicator?e.sort="asc":"D"===e.qSortIndicator&&(e.sort="desc")),!0===e.searchable&&(e.onSearch||(e.onSearch=r.handleSearch.bind(r))),e})).sort(function(e,t){return e.colIndex-t.colIndex}),"P"===r.layout.qHyperCube.qMode&&(t=t.filter(function(e,t){return t<r.layout.qHyperCube.qNoOfLeftDims})),t=t.filter(function(e){return!e.qError}),r.table.options.columns=t;var n=r.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError}),a=n.filter(function(e,t){return"S"===r.layout.qHyperCube.qMode||t<r.layout.qHyperCube.qNoOfLeftDims}).map(function(e,t){return{value:new Array(Math.max(e.qApprMaxGlyphCount,r.layout.qHyperCube.qDimensionInfo[t].qFallbackTitle.length)).fill("X").join(""),width:e.width||null}}),i=n.pop();a=a.concat(r.layout.qHyperCube.qMeasureInfo.filter(function(e){return!e.qError}).map(function(e){return{value:new Array("S"===r.layout.qHyperCube.qMode?e.qApprMaxGlyphCount:Math.max(e.qApprMaxGlyphCount,i.qApprMaxGlyphCount)).fill("X").join(""),width:"S"===r.layout.qHyperCube.qMode?e.width||null:e.width||i.width||null}})),r.columnParams=r.table.getColumnParameters(a);for(var s=0;s<t.length;s++)t[s].width="".concat(r.columnParams.cellWidths[s]||r.columnParams.cellWidths[r.columnParams.cellWidths.length-1],"px");r.rowsToRender=Math.ceil(r.columnParams.availableHeight/r.columnParams.cellHeight),r.getData(function(e){(r.table.options.activeSort=o,r.table.hideLoading(),"S"===r.layout.qHyperCube.qMode&&(r.table.render(),r.prepDropdowns()),e.err)?document.getElementById("".concat(r.elementId,"_foot")).innerHTML="\n            <div class='request-abort-error'>Could not fetch data. Click <strong class='table-try-again'>here</strong> to try again</div>\n          ":(r.fullData=e,r.resize())})},function(e){r.errorCount<50&&(r.errorCount++,console.log("error getting layout, attempt",r.errorCount),clearTimeout(r.retryFn),r.retryFn=setTimeout(function(){r.render()},300))})):this.prepSearch()}},{key:"resize",value:function(){this.appendRows(this.transformData(this.fullData))}},{key:"setPageNum",value:function(e){this.render(e)}},{key:"setPageSize",value:function(e){this.options.pageSize=e,this.render()}},{key:"transformData",value:function(e){var a=this;if("S"===this.layout.qHyperCube.qMode)return e.map(function(e){return e.map(function(o,e){if(!0===a.table.options.columns[e].showAsLink&&o.qAttrExps&&o.qAttrExps.qValues&&o.qAttrExps.qValues[0].qText?(o.value=o.qAttrExps.qValues[0].qText,-1===o.value.indexOf("https://")&&(o.value="https://".concat(o.value)),o.displayText=o.qText||"-"):o.value=o.qText||"-",o.qAttrExps&&o.qAttrExps.qValues){var n=e;o.qAttrExps.qValues.forEach(function(e,t){e.qText&&""!==e.qText&&("cellForegroundColor"===a.orderedColumns[n].qAttrExprInfo[t].id?o.color=e.qText:"cellBackgroundColor"===a.orderedColumns[n].qAttrExprInfo[t].id&&(o.backgroundColor=e.qText))})}return o})});var t=this.transformPivotTable(e);this.fullColumnList=t.shift();for(var o=[],n=this.options.freezeColumns||this.layout.qHyperCube.qNoOfLeftDims,i=0;i<this.fullColumnList.length;i++)i<n?o.push(this.fullColumnList[i]):i>=n+this.leftDataCol&&i<n+this.leftDataCol+this.columnsToRender&&o.push(this.fullColumnList[i]);this.table.options.columns=o;var s=0;return o.forEach(function(e){s+=+e.width.toString().replace("px","")}),this.table.setWidth(s),this.table.render(),this.prepDropdowns(),t}},{key:"transformPivotTable",value:function(e){for(var o=this,t=[],u=[],c=[],p=0,d=0,h=0,q=0,f=[],n=0;n<e.qLeft.length;n++)w.call(this,e.qLeft[n],0,0,null,[]);for(var a=0;a<e.qTop.length;a++)I.call(this,e.qTop[a],0,a);u[0]&&u[0].forEach(function(e,t){e.width=o.columnParams.cellWidths[t]});for(var i=this.layout.qHyperCube.qSize.qcx,s=this.totalWidth=0,r=this.columnsToRender=0;r<i;r++)r>=this.leftDataCol&&s<this.columnParams.scrollableWidth&&(s+=this.columnParams.cellWidths[(this.options.freezeColumns||this.layout.qHyperCube.qNoOfLeftDims)+r]||this.columnParams.cellWidths[this.columnParams.cellWidths.length-1],this.columnsToRender++),this.totalWidth+=this.columnParams.cellWidths[(this.options.freezeColumns||this.layout.qHyperCube.qNoOfLeftDims)+r]||this.columnParams.cellWidths[this.columnParams.cellWidths.length-1];this.table.setHorizontalScroll({width:this.columnParams.scrollableWidth*(this.columnParams.scrollableWidth/this.totalWidth),left:0}),c[c.length-1].forEach(function(e,t){e.width="".concat(o.columnParams.cellWidths[(o.options.freezeColumns||o.layout.qHyperCube.qNoOfLeftDims)+t]||o.columnParams.cellWidths[o.columnParams.cellWidths.length-1],"px")});for(var l=0;l<e.qData.length;l++){for(var m=[],y=this.leftDataCol;y<this.leftDataCol+this.columnsToRender;y++)m.push(e.qData[l][y]);for(var b=0;b<m.length;b++){m[b].pos="Data",m[b].style="text-align: right;",m[b].width="".concat(this.columnParams.cellWidths[(this.options.freezeColumns||this.layout.qHyperCube.qNoOfLeftDims)+b]||this.columnParams.cellWidths[this.columnParams.cellWidths.length-1],"px"),m[b].qAttrExps&&m[b].qAttrExps.qValues&&m[b].qAttrExps.qValues[0]&&m[b].qAttrExps.qValues[0].qText&&(m[b].backgroundColor=m[b].qAttrExps.qValues[0].qText,m[b].color=this.getFontColor(m[b].qAttrExps.qValues[0].qText)),m[b].qAttrExps&&m[b].qAttrExps.qValues&&m[b].qAttrExps.qValues[1]&&m[b].qAttrExps.qValues[1].qText&&(m[b].color=this.getFontColor(m[b].qAttrExps.qValues[1].qText));var g=c[c.length-1][b];-1===["T","E"].indexOf(m[b].qType)&&-1===["T"].indexOf(g.qType)||(m[b].qType="T"),m[b].value=m[b].qText||""}u[l]&&(m=u[l].concat(m)),t.push(m)}for(var v=[],C=h,x=0;x<C;x++)v.push({rowspan:1,colSpan:1,level:0,qText:"",qType:"V"});if(0!==h)for(var k=0;k<c.length;k++)k===c.length-1?c[k]=this.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError}).filter(function(e,t){return t<h}).map(function(e,t){return _extends({},e,{name:e.qFallbackTitle,width:"".concat(o.columnParams.cellWidths[t]||o.columnParams.cellWidths[o.columnParams.cellWidths.length-1],"px")})}).concat(c[k]):c[k]=v.concat(c[k]);function w(e,t,o,n,a){var i=_extends({},e);if(i.level=t,i.pos="Left",i.value=i.qText||"",e.value=e.qText||"",h=Math.max(h,t+1),i.childCount=i.qSubNodes.length,i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[0]&&i.qAttrExps.qValues[0].qText&&(i.backgroundColor=i.qAttrExps.qValues[0].qText,i.color=this.getFontColor(i.qAttrExps.qValues[0].qText)),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[1]&&i.qAttrExps.qValues[1].qText&&(i.color=this.getFontColor(i.qAttrExps.qValues[1].qText)),delete i.qSubNodes,void 0===i.qText&&(-1===i.qElemNo?i.qText="Totals":-4===i.qElemNo&&(i.qText="",i.qType="T")),i.rowspan=Math.max(1,e.qSubNodes.length),e.rowspan=Math.max(1,e.qSubNodes.length),0===e.qSubNodes.length)u.push(f.concat([i])),f=[];else{f.push(i);for(var s=0;s<e.qSubNodes.length;s++)w.call(this,e.qSubNodes[s],t+1,s,e,[].concat(_toConsumableArray(a),[i]));for(var r=0,l=0;l<e.qSubNodes.length;l++)r+=e.qSubNodes[l].rowspan;e.rowspan=r,i.rowspan=r}}function I(e,t,o,n){var a;void 0===c[t]&&(c[t]=[]);var i=_extends({},e);if(i.level=t,i.pos="Top",i.rowIndex=p,i.topNode=!0,i.isHeader=!0,i.style="text-align: center;",i.name=i.qText||"",i.font||(i.font={}),e.value=e.qText,"P"===i.qType&&(i.qElemNo=-99),i.childCount=i.qSubNodes.length,q=Math.max(q,t+1),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[0]&&i.qAttrExps.qValues[0].qText&&(i.backgroundColor=i.qAttrExps.qValues[0].qText,i.color=this.getFontColor(i.qAttrExps.qValues[0].qText)),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[1]&&i.qAttrExps.qValues[1].qText&&(i.color=this.getFontColor(i.qAttrExps.qValues[1].qText)),delete i.qSubNodes,-1===["T","E"].indexOf(i.qType)&&(i.qType="B"),void 0!==n&&"T"===n.qType&&(i.qType=n.qType,e.qType=n.qType),void 0===i.qText&&(-1===i.qElemNo?i.qText=this.layout.tableTotalsLabel:-4===i.qElemNo&&(i.qText="",i.qType="T",e.qType="T")),i.colSpan=Math.max(1,e.qSubNodes.length),e.colSpan=Math.max(1,e.qSubNodes.length),0===e.qSubNodes.length)-99===i.qElemNo&&!0===i.qCanCollapse&&d++;else{for(var s=0;s<e.qSubNodes.length;s++)I.call(this,e.qSubNodes[s],t+1,s,e);for(var r=0,l=0;l<e.qSubNodes.length;l++)r+=e.qSubNodes[l].colSpan;i.rowIndex=p,p+=r,i.colSpan=r,e.colSpan=r,"T"===i.qType&&-1===i.qElemNo&&(d+=r),-99===i.qElemNo&&d++,!0!==e.qCanExpand&&!0!==e.qCanCollapse||(0<e.qSubNodes.length&&!0===e.qCanCollapse&&void 0!==e.qSubNodes[0].rowIndex?(e.rowIndex=e.qSubNodes[0].rowIndex,i.rowIndex=e.qSubNodes[0].rowIndex):(e.rowIndex=d,i.rowIndex=d,d+=i.colSpan))}var u=[i];1<i.colSpan&&(u=new Array(i.colSpan).fill(_objectSpread({},i))),(a=c[t]).push.apply(a,_toConsumableArray(u))}return c[c.length-1],t=c.concat(t)}}]),n}(),Table3=function(){function s(e,t){var o=this;_classCallCheck(this,s);this.elementId=e,this.options=_extends({},{pageSize:200,cellHeight:35,virtualScroll:!0,columnOverrides:[],maxColWidth:"50%",allowPivoting:!1,pivotPanel:"docked",pivotButtonText:"Pivot",dropdownOptions:{},maxPlaceholderRows:1e3},t),this.fullData=[],this.rowIndexList=[],this.pageNum=0,this.pageCount=0,this.errorCount=0,this.leftDataCol=0,this.topDataRow=0,this.retryFn=null,this.pivotIndent=!1,this.busy=!1,this.dimensionWidth=0,this.dropdowns={},this.searchPrepped=!1,this.pinnedColumns=0,this.startCol=0,this.endCol=0,this.startRow=0;var n=document.getElementById(this.elementId);if(n){var a="",i="height: 100%";!0===this.options.allowPivoting&&("docked"===this.options.pivotPanel?i="height: calc(100% - 100px);":(i="height: calc(100% - 30px);",a+='\n            <div class="pivot-button-container">\n              <button class="toggle-pivot-panel">'.concat(this.options.pivotButtonText,"</button>\n            </div>\n          ")),a+="\n          <div id='".concat(this.elementId,"_pivotContainer' class='websy-designs-pivot-container ").concat(this.options.pivotPanel,"'>\n            <div>\n              <h3>Rows</h3>\n              <div id='").concat(this.elementId,"_pivotRows'></div>\n            </div>\n            <div>\n              <h3>Columns</h3>\n              <div id='").concat(this.elementId,"_pivotColumns'></div>\n            </div>\n          </div>       \n        ")),a+="\n        <div id='".concat(this.elementId,"_tableContainer' style='").concat(i,"'></div>\n      "),n.innerHTML=a,this.table=new _websyDesignsEs.default.WebsyTable3("".concat(this.elementId,"_tableContainer"),_extends({},{onClick:this.handleClick.bind(this),onScroll:this.handleScroll.bind(this),onSort:this.handleSort.bind(this),onChangePageSize:this.setPageSize.bind(this),onSetPage:this.setPageNum.bind(this),onScrollX:this.handleVirtualScrollX.bind(this),onExpandCell:this.handleExpand.bind(this),onCollapseCell:this.handleCollapse.bind(this)},this.options)),!0===this.options.allowPivoting&&(this.rowList=new _websyDesignsEs.default.DragDrop("".concat(this.elementId,"_pivotRows"),{group:this.elementId,items:[],onItemAdded:function(){o.updatePivotStructure()}}),this.columnList=new _websyDesignsEs.default.DragDrop("".concat(this.elementId,"_pivotColumns"),{group:this.elementId,items:[],onItemAdded:function(){o.updatePivotStructure()}})),n.addEventListener("click",this.handleClick.bind(this)),this.render()}}return _createClass(s,[{key:"appendRows",value:function(e){this.table.appendRows(e)}},{key:"buildPivotColumns",value:function(){var n=this;if(this.layout.qHyperCube.qPivotDataPages[0]){var e=this.transformPivotTable(this.layout.qHyperCube.qPivotDataPages[0]);if(this.columns=e.columns,(this.startCol=0)!==this.columns.length){this.endCol=this.columns[this.columns.length-1].length,this.table.options.columns=this.columns;for(var t=this.layout.qHyperCube.qMeasureInfo.filter(function(e){return!e.qError}).reduce(function(e,t){return e.qApprMaxGlyphCount>t.qApprMaxGlyphCount?e:t}).qApprMaxGlyphCount,o=this.layout.qHyperCube.qMeasureInfo.filter(function(e){return!e.qError}).reduce(function(e,t){return e.qFallbackTitle>t.qFallbackTitle?e:t}).qFallbackTitle,a=o.length>t?o:new Array(t).fill("X").join(""),i=this.layout.qHyperCube.qEffectiveInterColumnSortOrder,s="P"===this.layout.qHyperCube.qMode&&!0!==this.layout.qHyperCube.qAlwaysFullyExpanded,r=this.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError}).map(function(e){var t=s?"xxx":"";return e.qApprMaxGlyphCount>e.qFallbackTitle.length?t+=new Array(e.qApprMaxGlyphCount).fill("X").join(""):t+=e.qFallbackTitle,t}),l=[],u=[],c=[],p=0;p<i.length;p++){if(i[p]<this.layout.qHyperCube.qDimensionInfo.length&&0<=i[p]){var d=this.properties.qHyperCubeDef.qDimensions[i[p]];p<this.pinnedColumns?u.push(d):c.push(d)}!0===this.layout.qHyperCube.qIndentMode?p<this.pinnedColumns&&(-1===i[p]&&l.push(a),l[0]?r[p]&&r[p].length>l[0].length&&(l[0]=r[p]):l.push(r[p])):p<this.pinnedColumns&&l.push(r[p])}if(i.indexOf(-1)>=(!0===this.layout.qHyperCube.qIndentMode?1:this.pinnedColumns))for(var h=!0===this.layout.qHyperCube.qIndentMode?1:this.pinnedColumns;h<this.columns[this.columns.length-1].length;h++)l.push(a);else if(-1===i.indexOf(-1)){this.pinnedColumns<=0&&(l=[]);for(var q=l.length;q<this.columns[this.columns.length-1].length;q++)l.push(a)}var f=l.map(function(e){return{value:e,width:null}});this.tableSizes=this.table.calculateSizes(f,this.layout.qHyperCube.qSize.qcy,this.layout.qHyperCube.qSize.qcx,this.pinnedColumns);var m=0;if(!0===this.options.allowPivoting&&this.options.app){for(var y=document.getElementById("".concat(this.elementId,"_pivotRows")),b=!0===this.layout.qHyperCube.qIndentMode?1:this.pinnedColumns,g=0;g<b;g++)m+=this.columns[this.columns.length-1][g].actualWidth;"docked"===this.options.pivotPanel&&(y.style.width=m+"px",y.style.maxWidth=m+"px"),this.rowList.options.items=u.map(function(e,t){return{component:"Dropdown",isQlikPlugin:!0,dim:e,dimId:e.qLibraryId||e.qDef.qFieldLabels[0]||e.qDef.qFieldDefs[0],options:_extends({},n.options.dropdownOptions)}}),this.rowList.render(),this.rowList.options.items.forEach(function(t,e){if(n.dropdowns[t.dimId])t.instance.options.model=n.dropdowns[t.dimId],t.instance.render();else{var o={qInfo:{qType:"table-dropdown"},qListObjectDef:t.dim};o.qListObjectDef.qDef.qSortCriterias=[{qSortByState:1,qSortByAscii:1,qSortByNumeric:1}],n.options.app.createSessionObject(o).then(function(e){n.dropdowns[t.dimId]=e,t.instance.options.model=e,t.instance.render()})}}),this.columnList.options.items=c.map(function(e,t){return{component:"Dropdown",isQlikPlugin:!0,dim:e,dimId:e.qLibraryId||e.qDef.qFieldLabels[0]||e.qDef.qFieldDefs[0],options:_extends({},n.options.dropdownOptions)}}),this.columnList.render(),this.columnList.options.items.forEach(function(t,e){if(n.dropdowns[t.dimId])t.instance.options.model=n.dropdowns[t.dimId],t.instance.render();else{t.dim.qDef||(t.dim.qDef={}),t.dim.qDef.qSortCriterias=[{qSortByAscii:1,qSortByState:1,qSortByNumeric:1}];var o={qInfo:{qType:"table-dropdown"},qListObjectDef:t.dim};o.qListObjectDef.qDef.qSortCriterias=[{qSortByState:1,qSortByAscii:1,qSortByNumeric:1}],n.options.app.createSessionObject(o).then(function(e){n.dropdowns[t.dimId]=e,t.instance.options.model=e,t.instance.render()})}})}else{var v=document.getElementById("".concat(this.elementId,"_tableContainer"));v&&(v.style.height="100%")}}}}},{key:"buildStraightColumnsAndTotals",value:function(){var n=this;this.columns=this.layout.qHyperCube.qDimensionInfo.concat(this.layout.qHyperCube.qMeasureInfo),this.properties.qHyperCubeDef.qDimensions.concat(this.properties.qHyperCubeDef.qMeasures).forEach(function(e,t){n.columns[t].def=e});var a=this.layout.qHyperCube.qEffectiveInterColumnSortOrder[0];this.columns=this.columns.map(function(e,t){if(e.colIndex=n.columnOrder.indexOf(t),e.name=e.qFallbackTitle,e.tooltip&&(e.name+='\n        <div class="websy-info websy-info-dock-right" data-info="'.concat(e.tooltip,'">\n          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512"><path d="M256,56C145.72,56,56,145.72,56,256s89.72,200,200,200,200-89.72,200-200S366.28,56,256,56Zm0,82a26,26,0,1,1-26,26A26,26,0,0,1,256,138Zm48,226H216a16,16,0,0,1,0-32h28V244H228a16,16,0,0,1,0-32h32a16,16,0,0,1,16,16V332h28a16,16,0,0,1,0,32Z"/></svg>\n        </div>\n        ')),e.reverseSort=a===t&&!0!==e.qReverseSort,e.activeSort=a===t,"S"===n.layout.qHyperCube.qMode&&("A"===e.qSortIndicator?e.sort="asc":"D"===e.qSortIndicator&&(e.sort="desc")),!1!==e.searchable&&t<n.layout.qHyperCube.qDimensionInfo.length&&(e.searchable=!0,!e.onSearch)){e.isExternalSearch=!0;var o=e.def.qLibraryId||e.def.qDef.qFieldDefs[0];e.dimId=e.cId||o,e.onSearch=n.handleSearch.bind(n),e.onCloseSearch=n.handleCloseSearch.bind(n)}return e}),this.columns.sort(function(e,t){return e.colIndex-t.colIndex}),this.columns=this.columns.filter(function(e){return!e.qError}),this.table.options.columns=[this.columns],this.totals=[],this.layout.qHyperCube.qGrandTotalRow&&this.layout.totals&&!0===this.layout.totals.show&&"S"===this.layout.qHyperCube.qMode&&(this.totals=this.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError}).map(function(e){return{value:""}}).concat(this.layout.qHyperCube.qGrandTotalRow.map(function(e){return _extends({},e,{value:e.qText})})),this.totals.splice(0,1,{value:this.layout.totals.label||this.totals})),this.table.options.totals=this.totals;var o=this.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError});this.columnParamValues=o.filter(function(e,t){return"S"===n.layout.qHyperCube.qMode||t<n.pinnedColumns}).map(function(e,t){return{value:new Array(Math.max(e.qApprMaxGlyphCount,o[t].qFallbackTitle.length)).fill("X").join(""),width:e.width||null}});o.pop();var e=this.layout.qHyperCube.qMeasureInfo.filter(function(e){return!e.qError}).reduce(function(e,t){return e.qApprMaxGlyphCount>t.qApprMaxGlyphCount?e:t},{qApprMaxGlyphCount:0}),t=this.layout.qHyperCube.qMeasureInfo.filter(function(e){return!e.qError}).reduce(function(e,t){return e>t.qFallbackTitle.length?e:t.qFallbackTitle.length},0);this.columnParamValues=this.columnParamValues.concat(new Array(this.layout.qHyperCube.qSize.qcx).fill(new Array(Math.max(e.qApprMaxGlyphCount,t)).fill("X").join("")).map(function(e){return{value:e,width:null}})),this.layout.scrolling&&!0===this.layout.scrolling.keepFirstColumnInView&&(this.pinnedColumns=1),this.tableSizes=this.table.calculateSizes(this.columnParamValues,this.layout.qHyperCube.qSize.qcy,this.layout.qHyperCube.qSize.qcx,this.pinnedColumns),this.columns.forEach(function(t,o){if(t.searchable&&!0===t.isExternalSearch&&!n.dropdowns[t.dimId]){var e={qInfo:{qType:"table-dropdown"},qListObjectDef:t.def};e.qListObjectDef.qDef.qSortCriterias=[{qSortByState:1,qSortByAscii:1,qSortByNumeric:1}],n.options.app.createSessionObject(e).then(function(e){n.dropdowns[t.dimId]=new WebsyDesignsQlikPlugins.Dropdown("".concat(n.elementId,"_tableContainer_columnSearch_").concat(t.dimId||o),{model:e,multiSelect:!0,closeAfterSelection:!1,onClose:n.handleCloseSearch}),e.on("changed",function(){n.dropdowns[t.dimId].render()})})}}),this.table.options.activeSort=a}},{key:"buildDataStructure",value:function(){this.fullData=[],this.rowIndexList=[],this.buildEmptyRows(0)}},{key:"buildEmptyRows",value:function(e){if("S"===this.layout.qHyperCube.qMode||!0===this.layout.qHyperCube.qIndentMode)for(var t=e;t<Math.min(this.layout.qHyperCube.qSize.qcy,e+this.options.maxPlaceholderRows);t++)if(!this.fullData[t]){for(var o=[],n=0;n<this.layout.qHyperCube.qSize.qcx;n++)o.push({});this.fullData.push(o)}}},{key:"checkDataExists",value:function(a,i){var s=this;return new Promise(function(e,t){if("P"===s.layout.qHyperCube.qMode&&!0!==s.layout.qHyperCube.qIndentMode)s.getData(a,function(){e()});else{for(var o=-1,n=a;n<i;n++)if(-1===s.rowIndexList.indexOf(n)){o=n;break}s.buildEmptyRows(o),o<i&&-1!==o?s.getData(o,function(){e()},!0):-1!==o?s.getData(o,function(){e()},!0):e()}})}},{key:"getData",value:function(){var a=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,i=1<arguments.length?arguments[1]:void 0,t=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(!1===this.busy||!0===t)if((this.busy=!0)===this.options.getAllData)getAllData("qHyperCube",this.options.model,this.layout,function(e){a.busy=!1,i&&i(e.qHyperCube.qDataPages[0].qMatrix)});else{var o=1e4<this.dataWidth*this.options.pageSize?Math.floor(1e4/this.dataWidth):this.options.pageSize;"P"===this.layout.qHyperCube.qMode&&!0!==this.layout.qHyperCube.qIndentMode&&this.tableSizes&&(o=this.tableSizes.rowsToRender);var n=[{qTop:e,qLeft:0,qWidth:this.dataWidth,qHeight:o}];if((this.rowIndexList||[]).length<this.layout.qHyperCube.qSize.qcy){var s="getHyperCubeData";"P"===this.layout.qHyperCube.qMode&&(s="getHyperCubePivotData"),this.options.model[s]("/qHyperCubeDef",n).then(function(e){if(e){if("P"===a.layout.qHyperCube.qMode){var t=a.transformPivotTable(e[0]);e[0].qMatrix=t.data}if("S"===a.layout.qHyperCube.qMode||!0===a.layout.qHyperCube.qIndentMode){var o;(o=a.fullData).splice.apply(o,[e[0].qArea.qTop,e[0].qArea.qHeight].concat(_toConsumableArray(e[0].qMatrix)));for(var n=0;n<e[0].qArea.qHeight;n++)-1===a.rowIndexList.indexOf(e[0].qArea.qTop+n)&&a.rowIndexList.push(e[0].qArea.qTop+n);a.rowIndexList.sort(function(e,t){return e-t})}else a.fullData=e[0].qMatrix;a.busy=!1,i&&("P"===a.layout.qHyperCube.qMode?i(e[0]):i(e[0].qMatrix))}},function(e){console.log("error getting data",e)})}else this.busy=!1,i()}}},{key:"getFontColor",value:function(e){var t,o,n,a;return-1!==e.indexOf("#")?(t=(t=e.toLowerCase().replace("#","")).split(""),o=parseInt(t[0]+t[1],16),n=parseInt(t[2]+t[3],16),a=parseInt(t[4]+t[5],16)):-1!==e.toLowerCase().indexOf("rgb")&&(o=(t=(t=e.toLowerCase().replace("rgb(","").replace(")","")).split(","))[0],n=t[1],a=t[2]),186<.299*o+.587*n+.114*a?"#000000":"#ffffff"}},{key:"handleClick",value:function(e,t,o,n){if(e.target.classList.contains("table-try-again"))this.render();else if(t&&t.qElemNumber)this.options.model.selectHyperCubeValues("/qHyperCubeDef",0,[t.qElemNumber],!1);else if(e.target.classList.contains("toggle-pivot-panel")){var a=document.getElementById("".concat(this.elementId,"_pivotContainer"));a&&(e.target.classList.toggle("active"),a.classList.toggle("active"))}}},{key:"handleCollapse",value:function(e,t,o){var n=3<arguments.length&&void 0!==arguments[3]&&arguments[3];this.options.model.collapseLeft("/qHyperCubeDef",this.startRow+t,this.startCol+o,n)}},{key:"handleExpand",value:function(e,t,o){var n=3<arguments.length&&void 0!==arguments[3]&&arguments[3];this.options.model.expandLeft("/qHyperCubeDef",this.startRow+t,this.startCol+o,n)}},{key:"handleScroll",value:function(e,i,s,r,l){var u=this;this.startCol=r,this.endCol=l,this.startRow=i,this.checkDataExists(i,s).then(function(){if(u.columns&&0<u.columns.length)if("S"===u.layout.qHyperCube.qMode){var e=u.columns.filter(function(e,t){return t<u.pinnedColumns||r<=t&&t<=l});u.table.columns=[e]}else{var t=u.columns.map(function(e){var n=0,a=!1;return e.map(function(e,t){var o=_extends({},e);return t<u.pinnedColumns?(n+=o.colspan||1,o.colspan||1,o.inView=!0):(1<o.colspan?n<r&&n+o.colspan>r&&!1===a?(o.colspan=o.colspan-(r-n),o.inView=!0,a=!0):o.inView=r<=n:o.inView=t>=r+u.pinnedColumns&&t<=l+u.pinnedColumns,n+=e.colspan||1,o.colspan||1),o}).filter(function(e){return!0===e.inView})});u.table.columns=t}if(u.totals&&0<u.totals.length){var o=u.totals.filter(function(e,t){return t<u.pinnedColumns||r<=t&&t<=l});u.table.totals=o}var n="S"===u.layout.qHyperCube.qMode||!0===u.layout.qHyperCube.qIndentMode?i:0,a="S"===u.layout.qHyperCube.qMode||!0===u.layout.qHyperCube.qIndentMode?s:s-i;u.appendRows(u.transformData(u.fullData.slice(n,a+1).map(function(e){return e.filter(function(e,t){return"P"===u.layout.qHyperCube.qMode&&!0!==u.layout.qHyperCube.qIndentMode?e.level<u.pinnedColumns||e.dataIndex>=r&&e.dataIndex<=l:t<u.pinnedColumns||t>=r+u.pinnedColumns&&t<=l+u.pinnedColumns})})))})}},{key:"handleSearch",value:function(e,t){if(this.dropdowns[t.dimId]){var o=document.getElementById("".concat(this.elementId,"_tableContainer_columnSearch_").concat(t.dimId));o&&(o.classList.toggle("active"),o.style.top="".concat(e.pageY,"px"),o.style.right="calc(100vw - ".concat(e.pageX+e.target.offsetWidth,"px)"),this.dropdowns[t.dimId].open())}}},{key:"handleCloseSearch",value:function(e){document.getElementById(e).classList.remove("active")}},{key:"handleSort",value:function(e,t,o){var n=!0===t.reverseSort,a=[{qOp:"replace",qPath:"/qHyperCubeDef/qInterColumnSortOrder",qValue:JSON.stringify([o])}],i=o<this.layout.qHyperCube.qDimensionInfo.length?"qDimensions":"qMeasures",s=o<this.layout.qHyperCube.qDimensionInfo.length?o:o-this.layout.qHyperCube.qDimensionInfo.length;a.push({qOp:"replace",qPath:"/qHyperCubeDef/".concat(i,"/").concat(s,"/qDef/qReverseSort"),qValue:JSON.stringify(n)}),this.options.model.applyPatches(a,!0)}},{key:"handleVirtualScrollX",value:function(e){this.columnParams.scrollableWidth,this.columnParams.scrollableWidth,this.totalWidth;var t=e/this.columnParams.scrollableWidth*this.totalWidth,o=0,n=this.options.pinnedColumns||this.layout.qHyperCube.qNoOfLeftDims;this.leftDataCol=0;for(var a=n;a<this.fullColumnList.length&&t>=+this.fullColumnList[a].width.replace("px","")+o;a++)o+=+this.fullColumnList[a].width.replace("px",""),this.leftDataCol=a;this.fullColumnList.length-this.leftDataCol<this.columnsToRender&&(this.leftDataCol=this.fullColumnList.length-this.columnsToRender+1),this.resize()}},{key:"prepDropdowns",value:function(){}},{key:"prepSearch",value:function(){}},{key:"render",value:function(){var o=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;this.table.showLoading({message:"Loading..."}),this.options.model.getLayout().then(function(t){o.layout=t,o.dataWidth=o.layout.qHyperCube.qSize.qcx,o.columnOrder=o.layout.qHyperCube.qColumnOrder,o.getData(0,function(e){return o.layout.qHyperCube.qDataPages=[e],t.qHyperCube.qError&&t.qHyperCube.qCalcCondMsg?(o.table.hideLoading(),void o.table.showError({message:o.options.customError||t.qHyperCube.qCalcCondMsg})):o.options.forcedRowLimit&&t.qHyperCube.qSize.qcy>o.options.forcedRowLimit?(o.table.hideLoading(),void o.table.showError({message:o.options.forcedRowLimitError||o.options.customError||t.qHyperCube.qCalcCondMsg})):o.options.forcedColLimit&&t.qHyperCube.qSize.qcx>o.options.forcedColLimit?(o.table.hideLoading(),void o.table.showError({message:o.options.forcedColLimitError||o.options.customError||t.qHyperCube.qCalcCondMsg})):(o.table.hideError(),void o.options.model.getEffectiveProperties().then(function(e){o.properties=e,o.options.onUpdate&&o.options.onUpdate(e,t),o.endCol=t.qHyperCube.qSize.qcx+(o.pinnedColumns||t.qHyperCube.qNoOfLeftDims),o.buildDataStructure(),o.errorCount=0,o.pageNum=n,o.pageCount=Math.ceil(t.qHyperCube.qSize.qcy/o.options.pageSize),o.table.options.pageNum=o.pageNum,o.table.options.pageCount=o.pageCount,void 0===o.columnOrder&&(o.columnOrder=new Array(o.layout.qHyperCube.qSize.qcx).fill({}).map(function(e,t){return t})),o.layout.qHyperCube.qDimensionInfo=o.layout.qHyperCube.qDimensionInfo.map(function(e,t){return e.searchable=!0,o.options.columnOverrides[t]&&(e=_objectSpread(_objectSpread({},e),{},{onSearch:o.handleSearch.bind(o),onCloseSearch:o.handleCloseSearch.bind(o)},o.options.columnOverrides[t])),e.searchField="dim".concat(t),e}),o.layout.qHyperCube.qMeasureInfo=o.layout.qHyperCube.qMeasureInfo.map(function(e,t){return o.options.columnOverrides[o.layout.qHyperCube.qDimensionInfo.length+t]&&(e=_objectSpread(_objectSpread({},e),o.options.columnOverrides[o.layout.qHyperCube.qDimensionInfo.length+t])),e}),"S"===o.layout.qHyperCube.qMode?o.buildStraightColumnsAndTotals():o.buildPivotColumns(),0<o.startRow&&o.startRow+o.table.sizes.rowsToRender>o.layout.qHyperCube.qSize.qcy&&(o.startRow=o.layout.qHyperCube.qSize.qcy-o.table.sizes.rowsToRender),o.getData(o.startRow,function(e){if(o.table.hideLoading(),o.table.render([],!1),o.prepDropdowns(),!e||e.err){var t=document.getElementById("".concat(o.elementId,"_foot"));o.tableEl&&(t.innerHTML="\n                  <div class='request-abort-error'>Could not fetch data. Click <strong class='table-try-again'>here</strong> to try again</div>\n                ")}else o.resize()})}))})},function(e){console.log("error getting layout",e)})}},{key:"resize",value:function(){this.appendRows(this.transformData(this.fullData))}},{key:"setPageNum",value:function(e){this.render(e)}},{key:"setPageSize",value:function(e){this.options.pageSize=e,this.render()}},{key:"transformData",value:function(e){var a=this;return e.map(function(e){return e.map(function(n,e){if(!a.table.options.columns[a.table.options.columns.length-1][e]||!0!==a.table.options.columns[a.table.options.columns.length-1][e].showAsLink&&!0!==a.table.options.columns[a.table.options.columns.length-1][e].showAsNavigatorLink?n.value=n.qText||"-":n.qAttrExps&&n.qAttrExps.qValues&&n.qAttrExps.qValues[0].qText?(n.value=n.qAttrExps.qValues[0].qText,-1===n.value.indexOf("https://")&&(n.value="https://".concat(n.value)),n.displayText=n.qText||"-"):n.value=n.qText||"-",n.qAttrExps&&n.qAttrExps.qValues){a.startCol;n.qAttrExps.qValues.forEach(function(e,t){if(e.qText&&""!==e.qText){var o=(n.level-a.layout.qHyperCube.qDimensionInfo.length)%a.layout.qHyperCube.qMeasureInfo.length;a.layout.qHyperCube.qMeasureInfo[o]&&a.layout.qHyperCube.qMeasureInfo[o].qAttrExprInfo&&a.layout.qHyperCube.qMeasureInfo[o].qAttrExprInfo[t]&&"cellForegroundColor"===a.layout.qHyperCube.qMeasureInfo[o].qAttrExprInfo[t].id?n.color=e.qText:a.layout.qHyperCube.qMeasureInfo[o]&&a.layout.qHyperCube.qMeasureInfo[o].qAttrExprInfo&&a.layout.qHyperCube.qMeasureInfo[o].qAttrExprInfo[t]&&"cellBackgroundColor"===a.layout.qHyperCube.qMeasureInfo[o].qAttrExprInfo[t].id&&(n.backgroundColor=e.qText)}})}return n})})}},{key:"transformPivotTable",value:function(e){for(var t=this,o=[],c=[],p=[],d=0,h=0,q=0,f=0,m=[],y=this.layout.qHyperCube.qDimensionInfo.concat(this.layout.qHyperCube.qMeasureInfo),n=0;n<e.qLeft.length;n++)C.call(this,e.qLeft[n],0,0,null,[]);for(var a=0;a<e.qTop.length;a++)x.call(this,e.qTop[a],0,a);this.pinnedColumns=q;for(var i=0;i<e.qData.length;i++){for(var s=e.qData[i],r=0;r<s.length;r++){s[r].classes||(s[r].classes=[]),s[r].pos="Data",s[r].style="text-align: right;",s[r].dataIndex=r,s[r].level=this.pinnedColumns+r;var l=p[p.length-1][r];-1===["T","E"].indexOf(s[r].qType)&&-1===["T"].indexOf(l.qType)||(s[r].qType="T"),c[i]&&"T"===c[i][c[i].length-1].qType&&(c[i][c[i].length-1].classes||(c[i][c[i].length-1].classes=[]),c[i][c[i].length-1].classes.push("total-cell"),s[r].classes.push("total-cell")),s[r].value=s[r].qText||""}c[i]&&(s=c[i].concat(s)),o.push(s)}var u=[],b=q;!0===this.layout.qHyperCube.qIndentMode&&(b=1);for(var g=0;g<b;g++)u.push({rowspan:1,colspan:1,level:0,qText:"",name:"",qType:"V"});if(0!==q)for(var v=0;v<p.length;v++)v===p.length-1&&"P"===this.layout.qHyperCube.qMode&&!0!==this.layout.qHyperCube.qIndentMode?function(){var o=t.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError}),e=u.map(function(e,t){return e.name=(o[t]||{}).qFallbackTitle||"",e});p[v]=e.concat(p[v])}():p[v]=u.concat(p[v]);function C(e,t,o,n,a){var i=_extends({},e);if(i.level=t,i.pos="Left",i.style="",i.value=i.qText||"",e.value=e.qText||"",q=Math.max(q,t+1),i.childCount=i.qSubNodes.length,i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[0]&&i.qAttrExps.qValues[0].qText&&(i.backgroundColor=i.qAttrExps.qValues[0].qText,i.color=this.getFontColor(i.qAttrExps.qValues[0].qText)),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[1]&&i.qAttrExps.qValues[1].qText&&(i.color=this.getFontColor(i.qAttrExps.qValues[1].qText)),delete i.qSubNodes,!(i.qElemNo<0&&!0===this.layout.qHyperCube.qIndentMode&&0<t))if(void 0===i.qText&&(-1===i.qElemNo?i.qText="Totals":-4===i.qElemNo&&(i.qText="")),i.expandable=i.qCanExpand,i.collapsable=i.qCanCollapse,i.rowspan=Math.max(1,e.qSubNodes.length),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues.forEach(function(e,t){e.qText&&""!==e.qText&&(y[i.level]&&y[i.level].qAttrExprInfo&&y[i.level].qAttrExprInfo[t]&&"cellForegroundColor"===y[i.level].qAttrExprInfo[t].id?i.color=e.qText:y[i.level]&&y[i.level].qAttrExprInfo&&y[i.level].qAttrExprInfo[t]&&"cellBackgroundColor"===y[i.level].qAttrExprInfo[t].id&&(i.backgroundColor=e.qText))}),e.rowspan=Math.max(1,e.qSubNodes.length),!0===this.layout.qHyperCube.qIndentMode){i.rowspan=1,0<(i.indent=t)&&(i.style="padding-left: ".concat(20*t,"px;")),"E"!==i.qType&&c.push([i]),m=[];for(var s=0;s<e.qSubNodes.length;s++)C.call(this,e.qSubNodes[s],t+1,s,e,[].concat(_toConsumableArray(a),[i]))}else if(0===e.qSubNodes.length)c.push(m.concat([i])),m=[];else{m.push(i);for(var r=0;r<e.qSubNodes.length;r++)C.call(this,e.qSubNodes[r],t+1,r,e,[].concat(_toConsumableArray(a),[i]));for(var l=0,u=0;u<e.qSubNodes.length;u++)l+=e.qSubNodes[u].rowspan;e.rowspan=l,i.rowspan=l}}function x(e,t,o,n){var a;void 0===p[t]&&(p[t]=[]);var i=_extends({},e);if(i.level=t,i.pos="Top",i.rowIndex=d,i.topNode=!0,i.isHeader=!0,i.style="text-align: center;",i.name=i.qText||"",i.font||(i.font={}),e.value=e.qText,"P"===i.qType&&(i.qElemNo=-99),i.childCount=i.qSubNodes.length,f=Math.max(f,t+1),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[0]&&i.qAttrExps.qValues[0].qText&&(i.backgroundColor=i.qAttrExps.qValues[0].qText,i.color=this.getFontColor(i.qAttrExps.qValues[0].qText)),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[1]&&i.qAttrExps.qValues[1].qText&&(i.color=this.getFontColor(i.qAttrExps.qValues[1].qText)),delete i.qSubNodes,-1===["T","E"].indexOf(i.qType)&&(i.qType="B"),void 0!==n&&"T"===n.qType&&(i.qType=n.qType,e.qType=n.qType),void 0===i.qText&&(-1===i.qElemNo?i.qText=this.layout.tableTotalsLabel:-4===i.qElemNo&&(i.qText="",i.qType="T",e.qType="T")),i.colspan=Math.max(1,e.qSubNodes.length),e.colspan=Math.max(1,e.qSubNodes.length),0===e.qSubNodes.length)o>=this.startCol&&o<=this.endCol&&(i.inView=!0,e.inView=!0,h++);else{for(var s=0;s<e.qSubNodes.length;s++)x.call(this,e.qSubNodes[s],t+1,s,e);for(var r=0,l=0;l<e.qSubNodes.length;l++)r+=e.qSubNodes[l].colspan;i.rowIndex=d,d+=r,i.colspan=r,e.colspan=r,"T"===i.qType&&-1===i.qElemNo&&(h+=r),-99===i.qElemNo&&h++,!0!==e.qCanExpand&&!0!==e.qCanCollapse||(0<e.qSubNodes.length&&!0===e.qCanCollapse&&void 0!==e.qSubNodes[0].rowIndex?(e.rowIndex=e.qSubNodes[0].rowIndex,i.rowIndex=e.qSubNodes[0].rowIndex):(e.rowIndex=h,i.rowIndex=h,h+=i.colspan))}var u=[i];(a=p[t]).push.apply(a,u)}return p[p.length-1],{columns:p,data:o}}},{key:"updatePivotStructure",value:function(){var e=this.rowList.options.items.concat(this.columnList.options.items).map(function(e){return e.dim}),t=this.rowList.options.items.length,o=[{qOp:"replace",qPath:"/qHyperCubeDef/qNoOfLeftDims",qValue:JSON.stringify(t)},{qOp:"replace",qPath:"/qHyperCubeDef/qDimensions",qValue:JSON.stringify(e)}];this.options.onPivot&&this.options.onPivot(),this.options.model.applyPatches(o,!0)}}]),s}(),WebsyDesignsQlikPlugins={Bookmarks:Bookmarks,Chart:Chart,CurrentSelections:CurrentSelections,SimpleSearch:SimpleSearch,Table:Table,Table2:Table2,Table3:Table3,GeoMap:GeoMap,Dropdown:Dropdown,DatePicker:DatePicker,KPI:KPI},ObjectManager=function(){function i(e){var t=this;_classCallCheck(this,i);var o=[{id:"kpi",definition:KPI},{id:"table",definition:Table},{id:"chart",definition:Chart},{id:"map",definition:GeoMap},{id:"dropdown",definition:Dropdown},{id:"datepicker",definition:DatePicker}];if(this.app=null,this.paused=!1,this.supportedChartTypes=[],this.activeViews=[],this.chartLibrary={},this.globalObjectsLoaded=!1,this.options=_extends({},{helpEvent:"mouseover",applySelections:!1,actions:[],retryCount:5,initialActions:[]},e),e.visualisationPlugins&&0<e.visualisationPlugins.length){var n=e.visualisationPlugins.map(function(e){return e.id});o.forEach(function(e){-1===n.indexOf(e.id)&&t.options.visualisationPlugins.push(e)})}else this.options.visualisationPlugins=_extends({},o);if(this.options.visualisationPlugins&&0<this.options.visualisationPlugins.length)for(var a=0;a<this.options.visualisationPlugins.length;a++)this.registerVisualisation(this.options.visualisationPlugins[a].id,this.options.visualisationPlugins[a].definition)}return _createClass(i,[{key:"buildChildElement",value:function(e,t){if(document.getElementById("".concat(e,"_vis")))return"";var o="\n      <article id='".concat(e,"_vis' class='websy-vis-article'></article>\n      <div id='").concat(e,"_loading' class='websy-loading-container'><div class='websy-ripple'><div></div><div></div></div></div>\n    ");return t&&""!==t&&(o+="\n        <i class='websy-vis-help-listener' data-element='".concat(e,"'></i>\n        <div id='").concat(e,"_help' class='websy-vis-help'><span>").concat(t||"","</span></div>        \n      ")),o}},{key:"mergeObjects",value:function(){var o=this,n={},a=!0,e=0;"boolean"==typeof arguments[0]&&(a=arguments[0],e++);for(var t=function(e){for(var t in e)e.hasOwnProperty(t)&&(a&&"[object Object]"===Object.prototype.toString.call(e[t])?n[t]=o.mergeObjects(n,n[t],e[t]):Array.isArray(n[t])&&Array.isArray(e[t])?0<e[t].length&&(n[t]=[].concat(_toConsumableArray(n[t]),_toConsumableArray(e[t]))):n[t]=e[t])};e<arguments.length;e++)t(arguments[e]);return n}},{key:"init",value:function(){var o=this;return new Promise(function(e,t){o.prep("global"),o.connectToApp().then(function(){o.executeAction(0,o.options.initialActions,function(){o.selectFromUrl(function(){e()})})},t)})}},{key:"pause",value:function(){this.paused=!0}},{key:"play",value:function(e,t){if(void 0===t&&(t=[]),!(this.paused=!1)===e){-1===t.indexOf("global")&&this.loadObjects("global");for(var o=0;o<this.activeViews.length;o++)-1===t.indexOf(this.activeViews[o])&&this.loadObjects(this.activeViews[o])}}},{key:"request",value:function(e,a,i,s){return new Promise(function(t,o){var n=new XMLHttpRequest;n.open(e,a),n.setRequestHeader("Content-Type","application/json"),n.responseType="text",s&&(n.responseType=s),n.withCredentials=!0,n.onload=function(){var e="text"===n.responseType?n.responseText:n.response;if(""!==e&&"null"!==e)try{e=JSON.parse(e)}catch(e){}else e=null;e.err?o(JSON.stringify(e)):t(e)},n.onerror=function(){return o(n.statusText)},i?n.send(JSON.stringify(i)):n.send()})}},{key:"prep",value:function(e){for(var a=this,t=0;t<this.options.views[e].objects.length;t++){var o=this.options.views[e].objects[t],n=document.getElementById(o.elementId);n&&(n.innerHTML+=this.buildChildElement(o.elementId,o.help),o.help&&""!==o.help&&(n.addEventListener(this.options.helpEvent,this.handleEvent.bind(this)),n.addEventListener("mouseout",this.handleEvent.bind(this))))}for(var i=function(n){var e=document.getElementById(a.options.actions[n].elementId);e&&e.addEventListener(a.options.actions[n].event,function(){for(var e=function(e){var t,o=a.options.actions[n].items[e];(void 0===o.params&&(o.params=[]),o.field)?a.app.getField(o.field,o.state||"$").then(function(e){e[o.method].apply(e,_toConsumableArray(o.params))}):(t=a.app)[o.method].apply(t,_toConsumableArray(o.params))},t=0;t<a.options.actions[n].items.length;t++)e(t)})},s=0;s<this.options.actions.length;s++)i(s);this.options.views[e].prepped=!0}},{key:"connectToApp",value:function(){var s=this;return new Promise(function(t,o){var n=s.options.enigmaConfig.app;if(s.options.enigmaConfig.app&&(s.options.enigmaConfig.app=s.normalizeId(s.options.enigmaConfig.app)),"undefined"!=typeof enigma)if(void 0!==s.options.enigmaSchema){var e=s.options.enigmaConfig.url;s.options.enigmaConfig.ticket&&(-1===e.indexOf("?")?e+="?":e+="&",e+="qlikTicket=".concat(s.options.enigmaConfig.ticket));var a={schema:s.options.enigmaSchema,url:e,onRejected:function(e,t,o){return o.code===this.options.enigmaSchema.enums.LocalizedErrorCode.LOCERR_GENERIC_ABORTED&&(t.tries=(t.tries||0)+1,t.tries<=5)?t.retry():this.Promise.reject(o)}},i=enigma.create(a);(s.session=i).open().then(function(e){(s.global=e).getActiveDoc().then(function(e){if(!e)return s.openApp(n).then(function(){t()});s.app=e,s.options.views.global?s.executeActions("global").then(function(){t()}):t()},function(e){if(n)return s.openApp(n).then(function(){t()},function(e){s.sessionOnNotification({err:e})});t()}),!0===s.options.keepAlive&&s.keepAlive()},function(e){o(e)}),i.on("traffic:received",function(e){void 0!==e.suspend&&s.sessionSuspended()}),i.on("notification:*",function(e,t){"OnAuthenticationInformation"===e?!0===t.mustAuthenticate?s.options.enigmaConfig.authUrl?window.location=s.options.enigmaConfig.authUrl+window.location.search.replace("?","%3F").replace("=","%3D"):s.options.enigmaConfig.onMustAuthenticate?s.options.enigmaConfig.onMustAuthenticate():t.loginUri&&(window.location=t.loginUri):!1===t.mustAuthenticate&&(s.user={userDirectory:t.userDirectory,userId:t.userId}):s.sessionOnNotification(t,e)}),i.on("suspended",s.sessionSuspended.bind(s)),i.on("resumed",s.sessionResumed.bind(s)),i.on("closed",s.sessionClosed.bind(s))}else o({error:"enigmaSchema property not found."});else o({error:"Enigma.js not found."})})}},{key:"closeApp",value:function(){for(var e in this.session.close(),this.app=null,this.options.views)this.options.views[e].objects.forEach(function(e){delete e.objectId,delete e.vis,e.attached=!1}),delete this.options.views[e]}},{key:"keepAlive",value:function(){var e=this;this.global.engineVersion(),setTimeout(function(){e.keepAlive()},59e3)}},{key:"openApp",value:function(e){var n=this;return new Promise(function(t,o){n.global.openDoc(e).then(function(e){e.abortModal(!0).then(function(){n.app=e,n.options.views.global?n.executeActions("global").then(function(){t()}):t()})},function(e){o(e)})})}},{key:"loadView",value:function(e,t){var o=this;void 0===t&&(t=!1),!0===this.paused&&!1===t||""!==e&&this.options.views[e]&&(-1===this.activeViews.indexOf(e)&&"global"!==e&&this.activeViews.push(e),this.options.views[e].controller&&!0!==this.options.views[e].initialized?this.options.views[e].controller.init(function(){(o.options.views[e].initialized=!0)!==o.options.views[e].prepped&&o.prep(e),o.executeActions(e).then(function(){!1!==o.globalObjectsLoaded&&!0!==o.options.alwaysLoadGlobal||"global"===e||(o.loadObjects("global",t),o.globalObjectsLoaded=!0),o.loadObjects(e,t),"global"===e&&(o.globalObjectsLoaded=!0)})}):(!0!==this.options.views[e].prepped&&this.prep(e),console.log("Running Actions",e),this.executeActions(e).then(function(){console.log("Actions complete",e),!1!==o.globalObjectsLoaded&&!0!==o.options.alwaysLoadGlobal||"global"===e||(o.loadObjects("global",t),o.globalObjectsLoaded=!0),o.loadObjects(e,t),"global"===e&&(o.globalObjectsLoaded=!0)})))}},{key:"executeAction",value:function(t,o,n){var e,a=this,i=o[t];void 0!==i?(void 0===i.params&&(i.params=[]),i.field?this.app.getField(i.field,i.state||"$").then(function(e){e[i.method].apply(e,_toConsumableArray(i.params)).then(function(){!0===i.lock?e.lock().then(function(){++t===o.length?n():a.executeAction(t,o,n)}):++t===o.length?n():a.executeAction(t,o,n)})}):(e=this.app)[i.method].apply(e,_toConsumableArray(i.params)).then(function(){++t===o.length?n():a.executeAction(t,o,n)})):n()}},{key:"executeActions",value:function(o){var n=this;return new Promise(function(e,t){n.options.views[o]&&n.options.views[o].actions&&0!==n.options.views[o].actions.length||e(),n.executeAction(0,n.options.views[o].actions,e)})}},{key:"loadObjects",value:function(e,t){var o=this;if(console.log("Loading objects",e),void 0===t&&(t=!1),!0!==this.paused||!1!==t){var n=this.options.views[e].objects;if(n&&0<n.length)for(var a=function(t){n[t].objectId?(n[t].attached=!0,n[t].vis&&n[t].vis.render?n[t].vis.render():n[t].render&&n[t].render(n[t],n[t].model)):n[t].definition&&"string"==typeof n[t].definition&&-1!==n[t].definition.toLowerCase().indexOf(".json")?o.request("GET",n[t].definition).then(function(e){n[t].definition=e,o.createObjectFromDefinition(n[t])}):o.createObjectFromDefinition(n[t])},i=0;i<n.length;i++)a(i)}}},{key:"closeObjects",value:function(e){this.closeView(e)}},{key:"closeView",value:function(e){if(""!==e&&this.options.views[e]){var t=this.activeViews.indexOf(e);-1!==t&&this.activeViews.splice(t,1);var o=this.options.views[e].objects;if(o&&0<o.length)for(var n=0;n<o.length;n++)o[n].vis?(o[n].attached=!1,o[n].vis.close&&o[n].vis.close()):o[n].objectId&&(o[n].close&&o[n].close(),this.destroyObjectFromId(o[n]))}}},{key:"handleEvent",value:function(e){if(e.target.classList.contains("websy-vis-help-listener")){var t=e.target.attributes["data-element"];t.value&&this.toggleHelp("".concat(t.value,"_help"))}}},{key:"createObjectFromDefinition",value:function(n){var a=this;if(n.retries&&(n.retries=0),n.definition&&this.app){var e="createSessionObject",t=n.definition;n.definition.qField&&(e="getField",t=n.definition.qField),n.definition.qInfo||(e="getObject"),this.app[e](t).then(function(e){n.objectId=e.id,n.attached=!0;var t=n.type||n.definition.qInfo.qType;if(-1!==a.supportedChartTypes.indexOf(t)){var o=_extends({},n.options,{model:e,def:n.definition,app:a.app});n.vis=new a.chartLibrary[t]("".concat(n.elementId,"_vis"),o),e.on("changed",function(){!0===n.attached&&!1===a.paused&&n.vis.render()})}else n.render&&"function"==typeof n.render&&(n.vis={},n.attached=!0,n.model=e,n.render(n,e),e.on("changed",function(){!0===n.attached&&!1===a.paused&&n.render(n,e)}))},function(e){console.log("Error creating object",e),n.retries<a.options.retryCount?(console.log("retrying"),n.retries++,a.createObjectFromDefinition(n)):console.log("Max retries reached.")})}else n.type&&(n.objectId=n.elementId,n.attached=!0,n.vis=new this.chartLibrary[n.type]("".concat(n.elementId,"_vis"),n.options||{}))}},{key:"destroyObjectFromId",value:function(e){var t=document.getElementById("".concat(e.elementId,"_vis"));t&&(t.innerHTML=""),this.app.destroySessionObject(e.objectId)}},{key:"detachObject",value:function(e){e.attached=!1}},{key:"normalizeId",value:function(e){return e.replace(/\s:\\\//,"-")}},{key:"sessionOnNotification",value:function(e,t){this.options.sessionOnNotification&&this.options.sessionOnNotification(e,t)}},{key:"sessionOnTraffic",value:function(e){this.options.sessionOnTraffic&&this.options.sessionOnTraffic(e)}},{key:"sessionResumed",value:function(e){this.options.sessionResumed&&this.options.sessionResumed(e)}},{key:"sessionSuspended",value:function(e){this.options.sessionSuspended&&this.options.sessionSuspended(e)}},{key:"sessionClosed",value:function(e){this.options.sessionClosed&&this.options.sessionClosed(e)}},{key:"showHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.add("active")}},{key:"hideHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.remove("active")}},{key:"toggleHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.toggle("active")}},{key:"onError",value:function(e){console.log(e)}},{key:"onClose",value:function(e){}},{key:"resize",value:function(){for(var e=0;e<this.activeViews.length;e++)this.resizeObjects(this.activeViews[e])}},{key:"resizeObjects",value:function(e){if(""!==e){var t=this.options.views[e].objects;if(t&&0<t.length)for(var o=0;o<t.length;o++)t[o].objectId&&(t[o].vis&&t[o].vis.resize?t[o].vis.resize():t[o].resize&&t[o].resize())}}},{key:"registerVisualisation",value:function(e,t){-1===e.indexOf(/\s/)?-1===this.supportedChartTypes.indexOf(e)?(this.supportedChartTypes.push(e),this.chartLibrary[e]=t):console.log("Failed to register Chart Extension. Chart name already exists."):console.log("Failed to register Chart Extension. Chart name must not contain spaces.")}},{key:"select",value:function(o,n,a,i){var s=this;if(o===n.length)return this.play(),void i();"select"===n[o].param&&this.app.getField(n[o].field,n[o].state).then(function(e){var t=n[o].values.map(function(e){var t=+e;if(isNaN(t)){var o=new Date(e);return isNaN(o.getDate())?{qText:decodeURI(e)}:{qNumber:_websyDesignsEs.default.Utils.toQlikDate(o),qIsNumeric:!0}}return{qNumber:t,qIsNumeric:!0}});e.selectValues(t,!1).then(function(){-1!==a.indexOf(n[o].field)?e.lock().then(function(){o++,s.select(o,n,a,i)}):(o++,s.select(o,n,a,i))})},function(e){console.log("field for selection not found",e),o++,s.select(o,n,a,i)})}},{key:"selectFromUrl",value:function(e){if(!0===this.options.applySelections&&""!==location.search){this.pause();var t=location.search.replace("?","").split("&"),o=(t=t.map(function(e){var t=e.split("="),o=t[1].split(","),n=o.shift().replace(/%20/g," "),a="$";return-1!==n.indexOf("::")&&(a=n.split("::")[0],n=n.split("::")[1]),{param:t[0],field:n,state:a,values:o}})).filter(function(e){return"select"===e.param||"setvariable"===e.param}),n=t.filter(function(e){return"lock"===e.param}).map(function(e){return e.field});this.select(0,o,n,e)}else e()}}]),i}();WebsyDesignsQlikPlugins.QlikObjectManager=ObjectManager;var _default=WebsyDesignsQlikPlugins;exports.default=_default;