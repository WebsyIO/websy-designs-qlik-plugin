"use strict";function ownKeys(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,a)}return o}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(o),!0).forEach(function(e){_defineProperty(t,e,o[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))})}return t}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,a=new Array(t);o<t;o++)a[o]=e[o];return a}function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(e[a]=o[a])}return e}).apply(this,arguments)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var a=t[o];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}var Chart=function(){function a(e,t){var o=this;_classCallCheck(this,a),this.elementId=e,this.options=_extends({},t),this.optionDefaults={data:{left:{min:0,max:0},right:{min:0,max:0},bottom:{min:0,max:0},top:{min:0,max:0},series:[]}},this.chart=new WebsyDesigns.WebsyChart(e),window.addEventListener("resize",function(){return o.chart.render()}),this.monthMap={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"},this.render()}return _createClass(a,[{key:"addOptions",value:function(e,t){for(var o in t)e[o]=t[o]}},{key:"checkForData",value:function(){var o=this;return new Promise(function(t,e){o.layout.qHyperCube.qDataPages[0]&&o.layout.qHyperCube.qDataPages[0].qMatrix?t():o.options.model.getHyperCubeData("/qHyperCubeDef",[{qTop:0,qLeft:0,qWidth:o.layout.qHyperCube.qSize.qcx,qHeight:Math.floor(1e4/o.layout.qHyperCube.qSize.qcx)}]).then(function(e){o.layout.qHyperCube.qDataPages=e,t()})})}},{key:"close",value:function(){this.chart.close()}},{key:"createSeriesKey",value:function(e){return e.replace(/ /g,"_")}},{key:"formatValue",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};console.log("formatting",e,t);var o=0,a=!1;return t.decimals&&(o=t.decimals),!0===t.showAsPercentage&&(a=t.showAsPercentage),"Time"===(t||{}).scale&&e.getDate?e="".concat(e.getDate()," ").concat(this.monthMap[e.getMonth()]," ").concat(e.getFullYear()):isNaN(e)||(e=WebsyDesigns.Utils.toReduced(e,o,a,!1,t.max),!0===t.showAsCurrency&&(e=e.toCurrency())),e}},{key:"fromQlikDate",value:function(e){var t=new Date(Math.round(864e5*(e-25569)));return t.setTime(t.getTime()+6e4*t.getTimezoneOffset()),t}},{key:"render",value:function(){var o=this;this.options.model.getLayout().then(function(t){o.layout=t,o.checkForData().then(function(){var e={};1===t.qHyperCube.qDimensionInfo.length&&1===t.qHyperCube.qMeasureInfo.length?e=o.transformMultiMeasure():1===t.qHyperCube.qDimensionInfo.length&&1<t.qHyperCube.qMeasureInfo.length?e=o.transformMultiMeasure():1<t.qHyperCube.qDimensionInfo.length?e=o.transformMultiDimensions():0===t.qHyperCube.qDimensionInfo.length&&0<t.qHyperCube.qMeasureInfo.length&&(e=o.transformNoDimensions()),o.chart.render(e)})})}},{key:"resize",value:function(){this.chart.render()}},{key:"transformBasic",value:function(){var t=this,o=_extends({},this.optionDefaults,this.layout.options);this.addOptions(o.data.left,this.layout.qHyperCube.qMeasureInfo[0].options||{}),o.data.left.min=this.layout.qHyperCube.qMeasureInfo[0].qMin,o.data.left.max=this.layout.qHyperCube.qMeasureInfo[0].qMax,o.data.left.label=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,this.addOptions(o.data.bottom,this.layout.qHyperCube.qDimensionInfo[0].options||{}),o.data.bottom.label=this.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle,o.data.bottom.data=[],o.data.left.title=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,o.data.left.formatter=function(e){return t.formatValue(e,t.layout.qHyperCube.qMeasureInfo[0].options||{})};var a=this.layout.qHyperCube.qMeasureInfo[0].options||{};return a.data=[],a.key=this.createSeriesKey(this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle),this.layout.qHyperCube.qDataPages[0].qMatrix.forEach(function(e){e[0].value=e[0].qText,e[1].value=isNaN(e[1].qNum)?0:e[1].qNum,e[1].tooltipValue=e[1].qText,o.data.bottom.data.push(e[0]),a.data.push({x:e[0],y:e[1]})}),o.data.series=[a],o}},{key:"transformMultiDimensions",value:function(){var t=this,a=_extends({},this.optionDefaults,this.layout.options);this.addOptions(a.data.left,this.layout.qHyperCube.qMeasureInfo[0].options||{}),a.data.left.min=this.layout.qHyperCube.qMeasureInfo[0].qMin,a.data.left.max=this.layout.qHyperCube.qMeasureInfo[0].qMax,a.data.left.label=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,this.addOptions(a.data.bottom,this.layout.qHyperCube.qDimensionInfo[1].options||{}),a.data.bottom.label=this.layout.qHyperCube.qDimensionInfo[1].qFallbackTitle,a.data.bottom.data=[],a.data.left.title=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,a.data.left.formatter=function(e){return t.formatValue(e,t.layout.qHyperCube.qMeasureInfo[0].options||{})};var n=[],i=[],s=[];return this.layout.qHyperCube.qDataPages[0].qMatrix.forEach(function(e){var t=i.indexOf(e[0].qText);-1===s.indexOf(e[1].qText)&&(s.push(e[1].qText),e[1].value=e[1].qText,a.data.bottom.data.push(e[1])),-1===t&&(i.push(e[0].qText),t=i.length-1,n.push({key:"series_".concat(t),type:a.type||"bar",label:e[0].qText,data:[]}));var o=e[2];o.value=isNaN(o.qNum)?0:o.qNum,o.tooltipLabel=e[0].qText,o.tooltipValue=o.qText,n[t].data.push({x:{value:e[1].qText},y:o})}),a.data.series=n,console.log(a),a}},{key:"transformNoDimensions",value:function(){var o=this,t=_extends({},this.optionDefaults,this.layout.options),a="bottom",n="left",e="Band",i="Linear";return"horizontal"===t.orientation&&(a="left",n="bottom",e="Linear",i="Band"),t.data[a].scale=e,t.data[n].scale=i,t.data[a].padding=t.padding||0,t.data[a].data=[],t.xTitle&&(t.data[a].title=t.xTitle,t.data[a].showTitle=!0,t.data[a].titlePosition=1),t.data[n].formatter=function(e){return o.formatValue(e,t||{})},this.layout.qHyperCube.qMeasureInfo.forEach(function(e){t.data[a].data.push({value:e.qFallbackTitle}),t.data[n].min=Math.min(t.data[n].min,e.qMin),t.data[n].max=Math.max(t.data[n].max,e.qMax)}),t.yMinOverride&&(t.data[n].min=t.yMinOverride),t.yMaxOverride&&(t.data[n].max=t.yMaxOverride),this.layout.qHyperCube.qDataPages[0]&&(t.data.series=[{key:this.layout.qInfo.qId,type:t.type||"bar",color:t.color,data:this.layout.qHyperCube.qDataPages[0].qMatrix.map(function(e){return e.map(function(e,t){return e.value=isNaN(e.qNum)?0:e.qNum,e.qAttrExps&&e.qAttrExps.qValues[0]&&e.qAttrExps.qValues[0].qText&&(e.label=e.qAttrExps.qValues[0].qText),{x:{value:o.layout.qHyperCube.qMeasureInfo[t].qFallbackTitle},y:e}})})[0]}]),t}},{key:"transformMultiMeasure",value:function(){var n=this,i=_extends({},this.optionDefaults,this.layout.options),s="bottom",a="left",r="right";if("horizontal"===i.orientation&&(s="left","right",a="bottom",r="top"),i.data[a].min=0,i.data[a].max=0,i.data[r].min=0,i.data[r].max=0,i.data.series=this.layout.qHyperCube.qMeasureInfo.map(function(t,e){var o=_extends({},t.options);return o.key=n.createSeriesKey(t.qFallbackTitle),o.data=[],o.type=(t.options||{}).type||i.type||"bar",o.accumulative=0,"secondary"===t.axis?(n.addOptions(i.data[r],t.options||{}),"stacked"!==i.grouping&&(i.data[r].min=Math.min(i.data[r].min,t.qMin),i.data[r].max=Math.max(i.data[r].max,t.qMax)),i.data[r].scale=(t.options||{}).scale||"Linear",i.data[r].title=t.qFallbackTitle,i.data[r].formatter=function(e){return n.formatValue(e,_extends({},t.options,i.data[r]))}):(n.addOptions(i.data[a],t.options||{}),"stacked"!==i.grouping&&(i.data[a].min=Math.min(i.data[a].min,t.qMin),i.data[a].max=Math.max(i.data[a].max,t.qMax)),console.log("max",i.data[a].max),i.data[a].scale=(t.options||{}).scale||"Linear",i.data[a].title=t.qFallbackTitle,i.data[a].formatter=function(e){return n.formatValue(e,_extends({},t.options,i.data[a]))}),o}),this.addOptions(i.data[s],this.layout.qHyperCube.qDimensionInfo[0].options||{}),i.data[s].ticks&&-1!==i.data[s].ticks.indexOf("d3.time")){var e=i.data[s].ticks.split(".").pop();i.data[s]=d3.time[e]}i.data[s].title=this.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle,i.data[s].data=[],i.data[s].min=this.layout.qHyperCube.qDimensionInfo[0].qMin,i.data[s].max=this.layout.qHyperCube.qDimensionInfo[0].qMax,i.data[s].scale=(this.layout.qHyperCube.qDimensionInfo[0].options||{}).scale||"Band","Time"!==i.data[s].scale?i.data[s].formatter=function(e){return n.formatValue(e,n.layout.qHyperCube.qDimensionInfo[0].options||{})}:(i.data[s].min=this.fromQlikDate(this.layout.qHyperCube.qDimensionInfo[0].qMin),i.data[s].max=this.fromQlikDate(this.layout.qHyperCube.qDimensionInfo[0].qMax));var l=[],u=[],c=[];return this.layout.qHyperCube.qDataPages[0].qMatrix.map(function(a){a.forEach(function(e,t){if(0!==t){var o=a[0];o.value=o.qText,"Time"===(n.layout.qHyperCube.qDimensionInfo[0].options||{}).scale&&(o.value=n.fromQlikDate(o.qNum)),-1===l.indexOf(o.qElemNumber)&&(l.push(o.qElemNumber),c.push(0),u.push(0),i.data[s].data.push(o)),e.value=isNaN(e.qNum)?0:e.qNum,u[l.indexOf(o.qElemNumber)]+=e.value,e.tooltipLabel=n.layout.qHyperCube.qMeasureInfo[t-1].qFallbackTitle,e.tooltipValue=e.qText,e.index=t,e.accumulative=c[l.indexOf(o.qElemNumber)],c[l.indexOf(o.qElemNumber)]+=e.value,o.index=l.indexOf(o.value),i.data.series[t-1].data.push({x:o,y:e})}else"Time"!==i.data[s].scale&&(i.data[s].min=i.data[s].min.length<e.qText.length?i.data[s].min:e.qText,i.data[s].max=i.data[s].max.length>e.qText.length?i.data[s].max:e.qText)})}),"stacked"===i.grouping&&(i.data[a].min=0,i.data[a].max=Math.max.apply(Math,u),i.data[r].min=0,i.data[r].max=Math.max.apply(Math,u)),console.log("options",i,u),i}}]),a}(),DatePicker=function(){function o(e,t){_classCallCheck(this,o);this.elementId=e,this.options=_extends({},{mode:"date",pageSize:1e3},t),this.picker=new WebsyDesigns.WebsyDatePicker(e,_extends({},t,{onChange:this.onChange.bind(this)})),this.listening=!0,this.render()}return _createClass(o,[{key:"checkForData",value:function(){var a=this;return new Promise(function(t,o){!0===a.listening&&(a.listening=!1,a.options.model.getListObjectData("/qListObjectDef",[{qTop:0,qLeft:0,qWidth:1,qHeight:a.options.pageSize}]).then(function(e){a.layout.qListObject.qDataPages=[e[0]],a.listening=!0,t()},function(e){a.listening=!0,o(e)}))})}},{key:"floorDate",value:function(e){return"number"==typeof e&&(e=new Date(e)),new Date(e.setHours(0,0,0,0))}},{key:"fromQlikDate",value:function(e){var t=new Date(Math.round(864e5*(e-25569)));return t.setTime(t.getTime()+6e4*t.getTimezoneOffset()),this.floorDate(t)}},{key:"getField",value:function(o){var a=this;return new Promise(function(t,e){a.field?t(a.field):a.options.app.getField(o).then(function(e){e&&(a.field=e,t(a.field))},e)})}},{key:"toQlikDate",value:function(e){var t=e.getDate();1===t.toString().length&&(t="0".concat(t));var o=e.getMonth()+1;1===o.toString().length&&(o="0".concat(o));var a=e.getFullYear();return"".concat(a,"-").concat(o,"-").concat(t)}},{key:"toQlikDateNum",value:function(e){return Math.floor(e.getTime()/864e5+25569)}},{key:"onChange",value:function(e,t){var o=this;console.log(e);var a=e.map(function(e){return"date"===o.options.mode?o.toQlikDate(e):e}),n="";t?(n="".concat(a[0]),1<a.length&&(n=">=".concat(a[0],"<=").concat(a[a.length-1]))):n=a.join(" "),this.options.model.searchListObjectFor("/qListObjectDef",n).then(function(){o.options.model.acceptListObjectSearch("/qListObjectDef",!1).then()})}},{key:"render",value:function(){var p=this;this.options.model.getLayout().then(function(c){p.layout=c,p.checkForData().then(function(){var a,n,t=[],o=[];if(c.qListObject.qDataPages[0]&&!0===p.listening){var e,i,s={};"date"===p.options.mode?(e=p.fromQlikDate(c.qListObject.qDataPages[0].qMatrix[0][0].qNum).getTime(),i=p.fromQlikDate(c.qListObject.qDataPages[0].qMatrix[c.qListObject.qDataPages[0].qMatrix.length-1][0].qNum).getTime()):"year"===p.options.mode&&(e=c.qListObject.qDataPages[0].qMatrix[0][0].qNum,(i=c.qListObject.qDataPages[0].qMatrix[c.qListObject.qDataPages[0].qMatrix.length-1][0].qNum)<e&&(i=c.qListObject.qDataPages[0].qMatrix[0][0].qNum,e=c.qListObject.qDataPages[0].qMatrix[c.qListObject.qDataPages[0].qMatrix.length-1][0].qNum,p.options.sortDirection="desc",p.picker.options.sortDirection="desc"),a=e,n=i,p.picker.options.minAllowedYear=e,p.picker.options.maxAllowedYear=i);var r=i-e;"date"===p.options.mode&&(r/=864e5);for(var l=0;l<r+1;l++)if("date"===p.options.mode){var u=new Date(e+864e5*l);u.setHours(0,0,0),s[u.getTime()]={qNum:p.toQlikDateNum(u),qState:"Z"}}else"year"===p.options.mode&&(s[e+l]={qNum:e+l,qState:"Z"});c.qListObject.qDataPages[0].qMatrix.forEach(function(e,t,o){"date"===p.options.mode?(s[p.fromQlikDate(e[0].qNum).getTime()]&&(s[p.fromQlikDate(e[0].qNum).getTime()]=e[0]),0===t?a=p.fromQlikDate(e[0].qNum):t===o.length-1&&(n=p.fromQlikDate(e[0].qNum))):"year"===p.options.mode&&s[e[0].qNum]&&(s[e[0].qNum]=e[0])}),Object.values(s).forEach(function(e){"S"===e.qState&&o.push("date"===p.options.mode?p.fromQlikDate(e.qNum):e.qNum),-1!==["Z"].indexOf(e.qState)&&t.push("date"===p.options.mode?p.fromQlikDate(e.qNum):e.qNum)}),p.picker.setDateBounds([a,n]),o.length!==c.qListObject.qDataPages[0].qMatrix.length||0<o.length&&p.picker.selectCustomRange([o[0],o[o.length-1]||o[0]]),p.picker.render(t),p.listening=!0}})})}}]),o}(),Dropdown=function(){function o(e,t){_classCallCheck(this,o),this.elementId=e;this.options=_extends({},{pageSize:100,path:"",useVariable:!1},t),t.def||(t.def={options:{}}),this.busy=!1,this.dropdownOptions=_extends({},t,t.def.options||{},{onItemSelected:this.itemSelected.bind(this),onClearSelected:this.clearSelected.bind(this),onSearch:this.search.bind(this),onCancelSearch:this.cancelSearch.bind(this),onScroll:this.handleScroll.bind(this)}),this.dropdown=new WebsyDesigns.WebsyDropdown(e,this.dropdownOptions),this.render()}return _createClass(o,[{key:"cancelSearch",value:function(e){this.options.model.abortListObjectSearch("/".concat(this.options.path,"/qListObjectDef").replace(/\/\//g,"/"))}},{key:"checkForData",value:function(){var a=this;return new Promise(function(t,o){!1===a.busy&&(a.busy=!0,a.options.model.getListObjectData("/".concat(a.options.path,"/qListObjectDef").replace(/\/\//g,"/"),[{qTop:a.rowsLoaded,qLeft:0,qWidth:1,qHeight:a.options.pageSize}]).then(function(e){""!==a.options.path?(a.layout[a.options.path].qListObject.qDataPages[0].qMatrix=a.layout[a.options.path].qListObject.qDataPages[0].qMatrix.concat((e[0]||{qMatrix:[]}).qMatrix),a.rowsLoaded=a.layout[a.options.path].qListObject.qDataPages[0].qMatrix.length):(a.layout.qListObject.qDataPages[0]||(a.layout.qListObject.qDataPages[0]={qMatrix:[]}),a.layout.qListObject.qDataPages[0].qMatrix=a.layout.qListObject.qDataPages[0].qMatrix.concat((e[0]||{qMatrix:[]}).qMatrix),a.rowsLoaded=a.layout.qListObject.qDataPages[0].qMatrix.length),a.busy=!1,t()},function(e){a.busy=!1,o(e)}))})}},{key:"checkForVariable",value:function(){var o=this;return new Promise(function(t,e){!0===o.options.useVariable&&o.options.variable&&o.options.app?o.options.app.getVariableByName(o.options.variable).then(function(e){e.getLayout().then(function(e){t(e)})}):t()})}},{key:"clearSelected",value:function(){this.options.model.clearSelections("/".concat(this.options.path,"/qListObjectDef").replace(/\/\//g,"/"))}},{key:"handleScroll",value:function(e){var t=this;.7<e.target.scrollTop/(e.target.scrollHeight-e.target.clientHeight)&&this.checkForData().then(function(){t.dropdown.data=t.transformData()})}},{key:"itemSelected",value:function(t,e,o){!0===this.options.useVariable&&this.options.variable&&this.options.app?this.options.app.getVariableByName(this.options.variable).then(function(e){"NaN"===t.qNum?e.setStringValue(t.qText):e.setNumValue(t.qNum)}):this.options.model.selectListObjectValues("/".concat(this.options.path,"/qListObjectDef").replace(/\/\//g,"/"),[t.qElemNumber],!0===this.dropdown.options.multiSelect)}},{key:"open",value:function(){this.dropdown.open()}},{key:"render",value:function(){var o=this;this.rowsLoaded=0,this.options.model.getLayout().then(function(e){o.layout=e,o.checkForVariable().then(function(e){var t=""!==o.options.path?o.layout[o.options.path].qListObject:o.layout.qListObject;t.qDataPages&&0!==t.qDataPages.length||(t.qDataPages=[{qMatrix:[]}]),o.rowsLoaded=t.qDataPages[0].qMatrix.length,o.checkForData().then(function(){t.qDataPages[0]&&(o.dropdown.options.label=t.qDimensionInfo.qFallbackTitle,o.dropdown.data=o.transformData(e))})})})}},{key:"search",value:function(e){this.options.model.searchListObjectFor("/".concat(this.options.path,"/qListObjectDef").replace(/\/\//g,"/"),"*".concat(e,"*"))}},{key:"transformData",value:function(e){var o={},t=""!==this.options.path?this.layout[this.options.path].qListObject:this.layout.qListObject,a=t.qDataPages[0].qMatrix.map(function(e){return e[0].qText});if(!0===this.options.hideExcluded&&(t.qDataPages[0].qMatrix=t.qDataPages[0].qMatrix.filter(function(e){return-1===["X","XS","XL"].indexOf(e[0].qState)})),e){var n=a.indexOf(e.qText);-1!==n&&(this.dropdown.selectedItems=[n])}else t.qDataPages[0].qMatrix.forEach(function(e,t){o[e[0].qState]||(o[e[0].qState]=[]),o[e[0].qState].push(t)}),o.S&&0<o.S.length?this.dropdown.selectedItems=o.S:o.S&&0===o.S.length&&o.O&&1===o.O.length?this.dropdown.selectedItems=o.O:this.dropdown.selectedItems=[];return t.qDataPages[0].qMatrix.map(function(e){return _extends(e[0],{label:e[0].qText||"-",classes:["state-".concat(e[0].qState)]})})}}]),o}(),KPI=function(){function o(e,t){_classCallCheck(this,o),this.elementId=e,this.options=_extends({},t),this.kpiOptions={},this.kpi=new WebsyDesigns.WebsyKPI(e,this.kpiOptions),this.render()}return _createClass(o,[{key:"close",value:function(){this.kpiOptions.value={value:"-"},this.kpiOptions.subValue={value:""},this.kpi.render(this.kpiOptions)}},{key:"render",value:function(){var a=this;this.options.model.getLayout().then(function(e){var t=e.kpi.qHyperCube.qDataPages[0].qMatrix[0][0].qText;if(a.kpiOptions.value={value:t},a.kpiOptions.label={value:e.kpi.qHyperCube.qMeasureInfo[0].qFallbackTitle},e.icon&&(a.kpiOptions.icon="".concat(window.location.origin,"/resources/svg/").concat(e.icon,".svg")),e.tooltip&&e.tooltip.value&&(a.kpiOptions.tooltip={value:e.tooltip.value},e.tooltip.classes&&(a.kpiOptions.tooltip.classes=e.tooltip.classes)),a.kpiOptions.subValue={value:""},e.kpi.qHyperCube.qMeasureInfo[1]){void 0!==e.kpi.qHyperCube.qMeasureInfo[1].decimals&&e.kpi.qHyperCube.qMeasureInfo[1].decimals;var o=e.kpi.qHyperCube.qDataPages[0].qMatrix[0][1].qText;a.kpiOptions.subValue={value:"".concat(e.kpi.qHyperCube.qMeasureInfo[1].qFallbackTitle," ").concat(o)}}a.kpi.render(a.kpiOptions)})}},{key:"resize",value:function(){this.kpi.resize()}}]),o}(),GeoMap=function(){function a(t,e){var o=this;_classCallCheck(this,a),this.elementId=t;this.options=_extends({},{geoFillColor:"#783c96",geoAutoFill:!0,geoShowTooltip:!0},e,e.def.options),this.options.geoJSON&&"string"==typeof this.options.geoJSON?WebsyDesigns.service.get(this.options.geoJSON).then(function(e){o.geoJSON=e,delete o.options.geoJSON,o.map=new WebsyDesigns.WebsyMap(t,o.options),o.render()}):(this.map=new WebsyDesigns.WebsyMap(t,this.options),this.render())}return _createClass(a,[{key:"findGeoJsonByProperty",value:function(e){for(var t=0;t<this.geoJSON.features.length;t++)if(this.geoJSON.features[t].properties.name.toLowerCase()===e.toLowerCase())return this.geoJSON.features[t];return null}},{key:"render",value:function(){var a=this,e=document.getElementById(this.elementId);e.parentElement&&e.parentElement.classList.add("loading"),this.options.model.getLayout().then(function(n){if(n.options&&(a.options=_extends({},n.options),a.map.options=_extends({},a.map.options,n.options)),n.qHyperCube.qDataPages[0]){if(a.geoJSON){var o={type:"FeatureCollection",features:[]};n.qHyperCube.qDataPages[0].qMatrix.forEach(function(e){var t=a.findGeoJsonByProperty(e[0].qText);t&&(!0===a.options.geoAutoFill&&(t.fillColor=a.options.geoFillColor,t.fillOpacity=.4+e[1].qNum/n.qHyperCube.qMeasureInfo[0].qMax*.6),e[1].qAttrExps&&e[1].qAttrExps.qValues&&e[1].qAttrExps.qValues[0]&&e[1].qAttrExps.qValues[0].qText&&(t.fillColor=e[1].qAttrExps.qValues[0].qText),!0===a.options.geoShowTooltip&&(t.tooltip="".concat(e[1].qText,"<br>").concat(t.properties.label),t.tooltipClass="websy-map-tooltip"),o.features.push(t))}),a.map.options.geoJSON=o}var i={};n.qHyperCube.qDataPages[0].qMatrix.forEach(function(a){a.forEach(function(e,t){if(0!==t&&"polygon"===(n.qHyperCube.qMeasureInfo[t-1].options||{}).type){i.polygons||(i.polygons=[]);var o=JSON.parse("[".concat(e.qText,"]"));i.polygons.push({label:a[0].qText,data:o.map(function(e){return e.map(function(e){return{Latitude:e[1],Longitude:e[0]}})})})}})}),a.map.options.data=i,e.parentElement&&e.parentElement.classList.remove("loading"),a.map.render()}})}}]),a}(),Table=function(){function a(e,t){_classCallCheck(this,a);this.elementId=e,this.options=_extends({},{pageSize:50},t),this.rowCount=0,this.pageNum=0,this.pageCount=0,this.errorCount=0,this.retryFn=null,this.pivotIndent=!1,this.busy=!1,this.table=new WebsyDesigns.WebsyTable(this.elementId,_extends({},{onClick:this.handleClick.bind(this),onScroll:this.handleScroll.bind(this),onSort:this.handleSort.bind(this),onChangePageSize:this.setPageSize.bind(this),onSetPage:this.setPageNum.bind(this)},this.options));var o=document.getElementById(this.elementId);o&&o.addEventListener("click",this.handleClick.bind(this)),this.render()}return _createClass(a,[{key:"appendRows",value:function(e){this.table.appendRows(e)}},{key:"getData",value:function(t){var o=this;if(!1===this.busy)if((this.busy=!0)===this.options.getAllData)getAllData("qHyperCube",this.options.model,this.layout,function(e){o.rowCount=e.qHyperCube.qDataPages[0].qMatrix.length,o.busy=!1,t&&t(e.qHyperCube.qDataPages[0].qMatrix)});else{var e=[{qTop:this.rowCount,qLeft:0,qWidth:this.dataWidth,qHeight:1e4<this.dataWidth*this.options.pageSize?Math.floor(1e4/this.dataWidth):this.options.pageSize}];if(this.rowCount<this.layout.qHyperCube.qSize.qcy){var a="getHyperCubeData";"P"===this.layout.qHyperCube.qMode&&(a="getHyperCubePivotData"),this.options.model[a]("/qHyperCubeDef",e).then(function(e){e&&e[0]&&("P"===o.layout.qHyperCube.qMode?(o.layout.qHyperCube.qPivotDataPages.push(e[0]),o.rowCount+=e[0].qData.length):(e[0].qMatrix=e[0].qMatrix.filter(function(e){return"-"!==e[0].qText}),o.layout.qHyperCube.qDataPages.push(e[0]),o.rowCount+=e[0].qMatrix.length),o.busy=!1,t&&("P"===o.layout.qHyperCube.qMode?t(e[0]):t(e[0].qMatrix)))},function(e){o.errorCount<50&&(o.errorCount++,console.log("error getting data, attempt",o.errorCount),clearTimeout(o.retryFn),o.retryFn=setTimeout(function(){o.getData(t)},300))})}else this.busy=!1}}},{key:"getFontColor",value:function(e){var t,o,a,n;return-1!==e.indexOf("#")?(t=(t=e.toLowerCase().replace("#","")).split(""),o=parseInt(t[0]+t[1],16),a=parseInt(t[2]+t[3],16),n=parseInt(t[4]+t[5],16)):-1!==e.toLowerCase().indexOf("rgb")&&(o=(t=(t=e.toLowerCase().replace("rgb(","").replace(")","")).split(","))[0],a=t[1],n=t[2]),186<.299*o+.587*a+.114*n?"#000000":"#ffffff"}},{key:"handleClick",value:function(e,t,o,a){e.target.classList.contains("table-try-again")?this.render():t&&t.qElemNumber&&this.options.model.selectHyperCubeValues("/qHyperCubeDef",0,[t.qElemNumber],!1)}},{key:"handleScroll",value:function(e){var t=this;.7<e.target.scrollTop/(e.target.scrollHeight-e.target.clientHeight)&&this.getData(function(e){t.appendRows(t.transformData(e))})}},{key:"handleSort",value:function(e,t,o){var a=!0===t.reverseSort,n=[{qOp:"replace",qPath:"/qHyperCubeDef/qInterColumnSortOrder",qValue:JSON.stringify([o])}],i=o<this.layout.qHyperCube.qDimensionInfo.length?"qDimensions":"qMeasures",s=o<this.layout.qHyperCube.qDimensionInfo.length?o:o-this.layout.qHyperCube.qDimensionInfo.length;n.push({qOp:"replace",qPath:"/qHyperCubeDef/".concat(i,"/").concat(s,"/qDef/qReverseSort"),qValue:JSON.stringify(a)}),this.options.model.applyPatches(n,!0)}},{key:"render",value:function(){var a=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;this.table.showLoading({message:"Loading..."}),this.options.model.getLayout().then(function(e){if(console.log(e),a.layout=e,a.rowCount=n*a.options.pageSize,a.errorCount=0,a.pageNum=n,a.pageCount=Math.ceil(e.qHyperCube.qSize.qcy/a.options.pageSize),a.table.options.pageNum=a.pageNum,a.table.options.pageCount=a.pageCount,e.qHyperCube.qError&&e.qHyperCube.qCalcCondMsg)return a.table.hideLoading(),void a.table.showError({message:a.options.customError||e.qHyperCube.qCalcCondMsg});a.dataWidth=a.layout.qHyperCube.qSize.qcx,a.columnOrder=a.layout.qHyperCube.qColumnOrder,void 0===a.columnOrder&&(a.columnOrder=new Array(a.layout.qHyperCube.qSize.qcx).fill({}).map(function(e,t){return t}));var t=a.layout.qHyperCube.qDimensionInfo.concat(a.layout.qHyperCube.qMeasureInfo),o=a.layout.qHyperCube.qEffectiveInterColumnSortOrder[0];(t=t.map(function(e,t){return e.colIndex=a.columnOrder.indexOf(t),e.name=e.qFallbackTitle,e.tooltip&&(e.name+='\n          <div class="websy-info websy-info-dock-right" data-info="'.concat(e.tooltip,'">\n            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512"><path d="M256,56C145.72,56,56,145.72,56,256s89.72,200,200,200,200-89.72,200-200S366.28,56,256,56Zm0,82a26,26,0,1,1-26,26A26,26,0,0,1,256,138Zm48,226H216a16,16,0,0,1,0-32h28V244H228a16,16,0,0,1,0-32h32a16,16,0,0,1,16,16V332h28a16,16,0,0,1,0,32Z"/></svg>\n          </div>\n          ')),e.reverseSort=o===t&&!0!==e.qReverseSort,e.activeSort=o===t,"A"===e.qSortIndicator?e.sort="asc":"D"===e.qSortIndicator&&(e.sort="desc"),e})).sort(function(e,t){return e.colIndex-t.colIndex}),a.getData(function(e){(a.table.options.columns=t,a.table.options.activeSort=o,a.table.hideLoading(),a.table.render(),e.err)?document.getElementById("".concat(a.elementId,"_foot")).innerHTML="\n            <div class='request-abort-error'>Could not fetch data. Click <strong class='table-try-again'>here</strong> to try again</div>\n          ":a.appendRows(a.transformData(e))})},function(e){a.errorCount<50&&(a.errorCount++,console.log("error getting layout, attempt",a.errorCount),clearTimeout(a.retryFn),a.retryFn=setTimeout(function(){a.render()},300))})}},{key:"setPageNum",value:function(e){this.render(e)}},{key:"setPageSize",value:function(e){this.options.pageSize=e,this.render()}},{key:"transformData",value:function(e){var i=this;if(console.log("page",e),"S"===this.layout.qHyperCube.qMode)return e.map(function(e){return e.map(function(o,e){if((!0===i.table.options.columns[e].showAsLink||!0===i.table.options.columns[e].showAsNavigatorLink)&&o.qAttrExps&&o.qAttrExps.qValues&&o.qAttrExps.qValues[0].qText?(o.value=o.qAttrExps.qValues[0].qText,-1===o.value.indexOf("https://")&&(o.value="https://".concat(o.value)),o.displayText=o.qText||"-"):o.value=o.qText||"-",o.qAttrExps&&o.qAttrExps.qValues){var a="qDimensionInfo",n=e;e>i.layout.qHyperCube.qDimensionInfo.length-1&&(a="qMeasureInfo",n-=i.layout.qHyperCube.qDimensionInfo.length),o.qAttrExps.qValues.forEach(function(e,t){e.qText&&""!==e.qText&&("cellForegroundColor"===i.layout.qHyperCube[a][n].qAttrExprInfo[t].id?o.color=e.qText:"cellBackgroundColor"===i.layout.qHyperCube[a][n].qAttrExprInfo[t].id&&(o.backgroundColor=e.qText))})}return o})});var t=this.transformPivotTable(e);return this.table.options.columns=t.shift(),this.table.render(),t}},{key:"transformPivotTable",value:function(e){for(var t=[],u=[],c=[],p=0,h=0,d=0,q=0,f=[],o=0;o<e.qLeft.length;o++)g.call(this,e.qLeft[o],0,0,null,[]);for(var a=0;a<e.qTop.length;a++)v.call(this,e.qTop[a],0,a);for(var n=0;n<e.qData.length;n++){for(var i=e.qData[n],s=0;s<i.length;s++){i[s].pos="Data",i[s].qAttrExps&&i[s].qAttrExps.qValues&&i[s].qAttrExps.qValues[0]&&i[s].qAttrExps.qValues[0].qText&&(i[s].backgroundColor=i[s].qAttrExps.qValues[0].qText,i[s].color=this.getFontColor(i[s].qAttrExps.qValues[0].qText)),i[s].qAttrExps&&i[s].qAttrExps.qValues&&i[s].qAttrExps.qValues[1]&&i[s].qAttrExps.qValues[1].qText&&(i[s].color=this.getFontColor(i[s].qAttrExps.qValues[1].qText));var r=c[c.length-1][s];-1===["T","E"].indexOf(i[s].qType)&&-1===["T"].indexOf(r.qType)||(i[s].qType="T"),i[s].value=i[s].qText}u[n]&&(i=u[n].concat(i)),t.push(i)}for(var l=[],y=d,m=0;m<y;m++)l.push({rowspan:1,colSpan:1,level:0,qText:"",qType:"V"});if(0!==d)for(var b=0;b<c.length;b++)b===c.length-1?c[b]=this.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError}).filter(function(e,t){return t<d}).map(function(e){return{name:e.qFallbackTitle}}).concat(c[b]):c[b]=l.concat(c[b]);function g(e,t,o,a,n){var i=_extends({},e);if(i.level=t,i.pos="Left",i.value=i.qText,e.value=e.qText,d=Math.max(d,t+1),i.childCount=i.qSubNodes.length,i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[0]&&i.qAttrExps.qValues[0].qText&&(i.backgroundColor=i.qAttrExps.qValues[0].qText,i.color=this.getFontColor(i.qAttrExps.qValues[0].qText)),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[1]&&i.qAttrExps.qValues[1].qText&&(i.color=this.getFontColor(i.qAttrExps.qValues[1].qText)),delete i.qSubNodes,void 0===i.qText&&(-1===i.qElemNo?i.qText="Totals??":-4===i.qElemNo&&(i.qText="",i.qType="T")),i.rowspan=Math.max(1,e.qSubNodes.length),e.rowspan=Math.max(1,e.qSubNodes.length),0===e.qSubNodes.length)u.push(f.concat([i])),f=[];else{f.push(i);for(var s=0;s<e.qSubNodes.length;s++)g.call(this,e.qSubNodes[s],t+1,s,e,[].concat(_toConsumableArray(n),[i]));for(var r=0,l=0;l<e.qSubNodes.length;l++)r+=e.qSubNodes[l].rowspan;e.rowspan=r,i.rowspan=r}}function v(e,t,o,a){var n;void 0===c[t]&&(c[t]=[]);var i=_extends({},e);if(i.level=t,i.pos="Top",i.rowIndex=p,i.topNode=!0,i.isHeader=!0,i.name=i.qText,i.font||(i.font={}),e.value=e.qText,"P"===i.qType&&(i.qElemNo=-99),i.childCount=i.qSubNodes.length,q=Math.max(q,t+1),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[0]&&i.qAttrExps.qValues[0].qText&&(i.backgroundColor=i.qAttrExps.qValues[0].qText,i.color=this.getFontColor(i.qAttrExps.qValues[0].qText)),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[1]&&i.qAttrExps.qValues[1].qText&&(i.color=this.getFontColor(i.qAttrExps.qValues[1].qText)),delete i.qSubNodes,-1===["T","E"].indexOf(i.qType)&&(i.qType="B"),void 0!==a&&"T"===a.qType&&(i.qType=a.qType,e.qType=a.qType),void 0===i.qText&&(-1===i.qElemNo?i.qText=this.layout.tableTotalsLabel:-4===i.qElemNo&&(i.qText="",i.qType="T",e.qType="T")),i.colSpan=Math.max(1,e.qSubNodes.length),e.colSpan=Math.max(1,e.qSubNodes.length),0===e.qSubNodes.length)-99===i.qElemNo&&!0===i.qCanCollapse&&h++;else{for(var s=0;s<e.qSubNodes.length;s++)v.call(this,e.qSubNodes[s],t+1,s,e);for(var r=0,l=0;l<e.qSubNodes.length;l++)r+=e.qSubNodes[l].colSpan;i.rowIndex=p,p+=r,i.colSpan=r,e.colSpan=r,"T"===i.qType&&-1===i.qElemNo&&(h+=r),-99===i.qElemNo&&h++,!0!==e.qCanExpand&&!0!==e.qCanCollapse||(0<e.qSubNodes.length&&!0===e.qCanCollapse&&void 0!==e.qSubNodes[0].rowIndex?(e.rowIndex=e.qSubNodes[0].rowIndex,i.rowIndex=e.qSubNodes[0].rowIndex):(e.rowIndex=h,i.rowIndex=h,h+=i.colSpan))}var u=[i];1<i.colSpan&&(u=new Array(i.colSpan).fill(_objectSpread({},i))),(n=c[t]).push.apply(n,_toConsumableArray(u))}return c[c.length-1],t=c.concat(t)}}]),a}(),Table2=function(){function a(e,t){_classCallCheck(this,a);Dropdown&&(WebsyDesignsQlikPlugins||(WebsyDesignsQlikPlugins={}),WebsyDesignsQlikPlugins.Dropdown=Dropdown),this.elementId=e,this.options=_extends({},{pageSize:50,cellHeight:35,virtualScroll:!1,columnOverrides:[]},t),this.rowCount=0,this.pageNum=0,this.pageCount=0,this.errorCount=0,this.leftDataCol=0,this.topDataRow=0,this.retryFn=null,this.pivotIndent=!1,this.busy=!1,this.dimensionWidth=0,this.dropdowns=[],this.searchPrepped=!1,this.table=new WebsyDesigns.WebsyTable2(this.elementId,_extends({},{onClick:this.handleClick.bind(this),onScroll:this.handleScroll.bind(this),onSort:this.handleSort.bind(this),onChangePageSize:this.setPageSize.bind(this),onSetPage:this.setPageNum.bind(this),onScrollX:this.handleVirtualScrollX.bind(this)},this.options));var o=document.getElementById(this.elementId);o&&o.addEventListener("click",this.handleClick.bind(this)),this.render()}return _createClass(a,[{key:"appendRows",value:function(e){this.table.appendRows(e)}},{key:"getData",value:function(t){var o=this;if(!1===this.busy)if((this.busy=!0)===this.options.getAllData)getAllData("qHyperCube",this.options.model,this.layout,function(e){o.rowCount=e.qHyperCube.qDataPages[0].qMatrix.length,o.busy=!1,t&&t(e.qHyperCube.qDataPages[0].qMatrix)});else{var e=[{qTop:this.rowCount,qLeft:0,qWidth:this.dataWidth,qHeight:1e4<this.dataWidth*this.options.pageSize?Math.floor(1e4/this.dataWidth):this.options.pageSize}];if(this.rowCount<this.layout.qHyperCube.qSize.qcy){var a="getHyperCubeData";"P"===this.layout.qHyperCube.qMode&&(a="getHyperCubePivotData"),this.options.model[a]("/qHyperCubeDef",e).then(function(e){e&&e[0]&&("P"===o.layout.qHyperCube.qMode?(o.layout.qHyperCube.qPivotDataPages.push(e[0]),o.rowCount+=e[0].qData.length):(e[0].qMatrix=e[0].qMatrix.filter(function(e){return"-"!==e[0].qText}),o.layout.qHyperCube.qDataPages.push(e[0]),o.rowCount+=e[0].qMatrix.length),o.busy=!1,t&&("P"===o.layout.qHyperCube.qMode?t(e[0]):t(e[0].qMatrix)))},function(e){o.errorCount<50&&(o.errorCount++,console.log("error getting data, attempt",o.errorCount),clearTimeout(o.retryFn),o.retryFn=setTimeout(function(){o.getData(t)},300))})}else this.busy=!1}}},{key:"getFontColor",value:function(e){var t,o,a,n;return-1!==e.indexOf("#")?(t=(t=e.toLowerCase().replace("#","")).split(""),o=parseInt(t[0]+t[1],16),a=parseInt(t[2]+t[3],16),n=parseInt(t[4]+t[5],16)):-1!==e.toLowerCase().indexOf("rgb")&&(o=(t=(t=e.toLowerCase().replace("rgb(","").replace(")","")).split(","))[0],a=t[1],n=t[2]),186<.299*o+.587*a+.114*n?"#000000":"#ffffff"}},{key:"handleClick",value:function(e,t,o,a){e.target.classList.contains("table-try-again")?this.render():t&&t.qElemNumber&&this.options.model.selectHyperCubeValues("/qHyperCubeDef",0,[t.qElemNumber],!1)}},{key:"handleScroll",value:function(e){var t=this;.7<e.target.scrollTop/(e.target.scrollHeight-e.target.clientHeight)&&this.getData(function(e){t.appendRows(t.transformData(e))})}},{key:"handleSearch",value:function(e,t){if(console.log(e,t),this.dropdowns[t.searchField]){var o=document.getElementById("".concat(this.elementId,"_columnSearch_").concat(e.target.getAttribute("data-col-index")));o&&(o.classList.toggle("active"),o.style.top="".concat(e.pageY,"px"),o.style.right="calc(100vw - ".concat(e.pageX+e.target.offsetWidth,"px)"),this.dropdowns[t.searchField].open())}}},{key:"handleSort",value:function(e,t,o){var a=!0===t.reverseSort,n=[{qOp:"replace",qPath:"/qHyperCubeDef/qInterColumnSortOrder",qValue:JSON.stringify([o])}],i=o<this.layout.qHyperCube.qDimensionInfo.length?"qDimensions":"qMeasures",s=o<this.layout.qHyperCube.qDimensionInfo.length?o:o-this.layout.qHyperCube.qDimensionInfo.length;n.push({qOp:"replace",qPath:"/qHyperCubeDef/".concat(i,"/").concat(s,"/qDef/qReverseSort"),qValue:JSON.stringify(a)}),this.options.model.applyPatches(n,!0)}},{key:"handleVirtualScrollX",value:function(e){this.columnParams.scrollableWidth,this.columnParams.scrollableWidth,this.totalWidth;var t=e/this.columnParams.scrollableWidth*this.totalWidth,o=0,a=this.options.freezeColumns||this.layout.qHyperCube.qNoOfLeftDims;this.leftDataCol=0;for(var n=a;n<this.fullColumnList.length&&t>=+this.fullColumnList[n].width.replace("px","")+o;n++)o+=+this.fullColumnList[n].width.replace("px",""),this.leftDataCol=n;this.fullColumnList.length-this.leftDataCol<this.columnsToRender&&(this.leftDataCol=this.fullColumnList.length-this.columnsToRender+1),this.resize()}},{key:"prepDropdowns",value:function(){var o=this;this.layout.qHyperCube.qDimensionInfo.forEach(function(e,t){o.dropdowns["dim".concat(t)]||(o.dropdowns["dim".concat(t)]=new WebsyDesignsQlikPlugins.Dropdown("".concat(o.elementId,"_columnSearch_").concat(t),{model:o.options.model,path:"dim".concat(t)}))})}},{key:"prepSearch",value:function(){var t=this;this.busy=!0,this.options.model.getProperties().then(function(e){console.log("props",e);var o=[];e.qHyperCubeDef.qDimensions.forEach(function(e,t){o.push({qOp:"add",qPath:"/dim".concat(t),qValue:JSON.stringify({qListObjectDef:{qDef:e.qDef,qLibraryId:e.qLibraryId}})})}),t.options.model.applyPatches(o,!0).then(function(){t.busy=!1,t.searchPrepped=!0,t.render()})})}},{key:"render",value:function(){var r=this,l=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;!1!==this.searchPrepped?(this.table.showLoading({message:"Loading..."}),this.options.model.getLayout().then(function(e){if(r.layout=e,console.log("table layout",e),r.rowCount=l*r.options.pageSize,r.layout.qHyperCube.qPivotDataPages[0]&&(r.layout.qHyperCube.qPivotDataPages=[]),r.errorCount=0,r.pageNum=l,r.pageCount=Math.ceil(e.qHyperCube.qSize.qcy/r.options.pageSize),r.table.options.pageNum=r.pageNum,r.layout.qHyperCube.qNoOfLeftDims&&(r.table.options.leftColumns=r.options.freezeColumns||r.layout.qHyperCube.qNoOfLeftDims),r.table.options.pageCount=r.pageCount,e.qHyperCube.qError&&e.qHyperCube.qCalcCondMsg)return r.table.hideLoading(),void r.table.showError({message:r.options.customError||e.qHyperCube.qCalcCondMsg});r.table.hideError(),r.dataWidth=r.layout.qHyperCube.qSize.qcx,r.columnOrder=r.layout.qHyperCube.qColumnOrder,void 0===r.columnOrder&&(r.columnOrder=new Array(r.layout.qHyperCube.qSize.qcx).fill({}).map(function(e,t){return t})),r.layout.qHyperCube.qDimensionInfo=r.layout.qHyperCube.qDimensionInfo.map(function(e,t){return r.options.columnOverrides[t]&&(e=_objectSpread(_objectSpread({},e),r.options.columnOverrides[t])),e.searchable=!0,e.searchField="dim".concat(t),e.onSearch=r.handleSearch.bind(r),e}),r.layout.qHyperCube.qMeasureInfo=r.layout.qHyperCube.qMeasureInfo.map(function(e,t){return r.options.columnOverrides[r.layout.qHyperCube.qDimensionInfo.length+t]&&(e=_objectSpread(_objectSpread({},e),r.options.columnOverrides[r.layout.qHyperCube.qDimensionInfo.length+t])),e});var t=r.layout.qHyperCube.qDimensionInfo.concat(r.layout.qHyperCube.qMeasureInfo),o=r.layout.qHyperCube.qEffectiveInterColumnSortOrder[0];(t=t.map(function(e,t){return e.colIndex=r.columnOrder.indexOf(t),e.name=e.qFallbackTitle,e.tooltip&&(e.name+='\n          <div class="websy-info websy-info-dock-right" data-info="'.concat(e.tooltip,'">\n            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512"><path d="M256,56C145.72,56,56,145.72,56,256s89.72,200,200,200,200-89.72,200-200S366.28,56,256,56Zm0,82a26,26,0,1,1-26,26A26,26,0,0,1,256,138Zm48,226H216a16,16,0,0,1,0-32h28V244H228a16,16,0,0,1,0-32h32a16,16,0,0,1,16,16V332h28a16,16,0,0,1,0,32Z"/></svg>\n          </div>\n          ')),e.reverseSort=o===t&&!0!==e.qReverseSort,e.activeSort=o===t,"A"===e.qSortIndicator?e.sort="asc":"D"===e.qSortIndicator&&(e.sort="desc"),!0===e.searchable&&(e.onSearch||(e.onSearch=r.handleSearch.bind(r))),e})).sort(function(e,t){return e.colIndex-t.colIndex}),"P"===r.layout.qHyperCube.qMode&&(t=t.filter(function(e,t){return t<r.layout.qHyperCube.qNoOfLeftDims})),t=t.filter(function(e){return!e.qError}),r.table.options.columns=t;var a=r.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError}),n=a.filter(function(e,t){return"S"===r.layout.qHyperCube.qMode||t<r.layout.qHyperCube.qNoOfLeftDims}).map(function(e){return{value:new Array(e.qApprMaxGlyphCount).fill("x").join(""),width:e.width||null}}),i=a.pop();n=n.concat(r.layout.qHyperCube.qMeasureInfo.filter(function(e){return!e.qError}).map(function(e){return{value:new Array("S"===r.layout.qHyperCube.qMode?e.qApprMaxGlyphCount:Math.max(e.qApprMaxGlyphCount,i.qApprMaxGlyphCount)).fill("x").join(""),width:"S"===r.layout.qHyperCube.qMode?e.width||null:e.width||i.width||null}})),r.columnParams=r.table.getColumnParameters(n);for(var s=0;s<t.length;s++)t[s].width="".concat(r.columnParams.cellWidths[s]||r.columnParams.cellWidths[r.columnParams.cellWidths.length-1],"px");r.rowsToRender=Math.ceil(r.columnParams.availableHeight/r.columnParams.cellHeight),r.getData(function(e){(r.table.options.activeSort=o,r.table.hideLoading(),"S"===r.layout.qHyperCube.qMode&&(r.table.render(),r.prepDropdowns()),e.err)?document.getElementById("".concat(r.elementId,"_foot")).innerHTML="\n            <div class='request-abort-error'>Could not fetch data. Click <strong class='table-try-again'>here</strong> to try again</div>\n          ":(r.fullData=e,r.resize())})},function(e){r.errorCount<50&&(r.errorCount++,console.log("error getting layout, attempt",r.errorCount),clearTimeout(r.retryFn),r.retryFn=setTimeout(function(){r.render()},300))})):this.prepSearch()}},{key:"resize",value:function(){this.appendRows(this.transformData(this.fullData))}},{key:"setPageNum",value:function(e){this.render(e)}},{key:"setPageSize",value:function(e){this.options.pageSize=e,this.render()}},{key:"transformData",value:function(e){var i=this;if("S"===this.layout.qHyperCube.qMode)return e.map(function(e){return e.map(function(o,e){if((!0===i.table.options.columns[e].showAsLink||!0===i.table.options.columns[e].showAsNavigatorLink)&&o.qAttrExps&&o.qAttrExps.qValues&&o.qAttrExps.qValues[0].qText?(o.value=o.qAttrExps.qValues[0].qText,-1===o.value.indexOf("https://")&&(o.value="https://".concat(o.value)),o.displayText=o.qText||"-"):o.value=o.qText||"-",o.qAttrExps&&o.qAttrExps.qValues){var a="qDimensionInfo",n=e;e>i.layout.qHyperCube.qDimensionInfo.length-1&&(a="qMeasureInfo",n-=i.layout.qHyperCube.qDimensionInfo.length),o.qAttrExps.qValues.forEach(function(e,t){e.qText&&""!==e.qText&&("cellForegroundColor"===i.layout.qHyperCube[a][n].qAttrExprInfo[t].id?o.color=e.qText:"cellBackgroundColor"===i.layout.qHyperCube[a][n].qAttrExprInfo[t].id&&(o.backgroundColor=e.qText))})}return o})});var t=this.transformPivotTable(e);this.fullColumnList=t.shift();for(var o=[],a=this.options.freezeColumns||this.layout.qHyperCube.qNoOfLeftDims,n=0;n<this.fullColumnList.length;n++)n<a?o.push(this.fullColumnList[n]):n>=a+this.leftDataCol&&n<a+this.leftDataCol+this.columnsToRender&&o.push(this.fullColumnList[n]);this.table.options.columns=o;var s=0;return o.forEach(function(e){s+=+e.width.toString().replace("px","")}),this.table.setWidth(s),this.table.render(),this.prepDropdowns(),t}},{key:"transformPivotTable",value:function(e){for(var o=this,t=[],u=[],c=[],p=0,h=0,d=0,q=0,f=[],a=0;a<e.qLeft.length;a++)T.call(this,e.qLeft[a],0,0,null,[]);for(var n=0;n<e.qTop.length;n++)w.call(this,e.qTop[n],0,n);u[0]&&u[0].forEach(function(e,t){e.width=o.columnParams.cellWidths[t]});for(var i=this.layout.qHyperCube.qSize.qcx,s=this.totalWidth=0,r=this.columnsToRender=0;r<i;r++)r>=this.leftDataCol&&s<this.columnParams.scrollableWidth&&(s+=this.columnParams.cellWidths[(this.options.freezeColumns||this.layout.qHyperCube.qNoOfLeftDims)+r]||this.columnParams.cellWidths[this.columnParams.cellWidths.length-1],this.columnsToRender++),this.totalWidth+=this.columnParams.cellWidths[(this.options.freezeColumns||this.layout.qHyperCube.qNoOfLeftDims)+r]||this.columnParams.cellWidths[this.columnParams.cellWidths.length-1];this.table.setHorizontalScroll({width:this.columnParams.scrollableWidth*(this.columnParams.scrollableWidth/this.totalWidth),left:0}),c[c.length-1].forEach(function(e,t){e.width="".concat(o.columnParams.cellWidths[(o.options.freezeColumns||o.layout.qHyperCube.qNoOfLeftDims)+t]||o.columnParams.cellWidths[o.columnParams.cellWidths.length-1],"px")});for(var l=0;l<e.qData.length;l++){for(var y=[],m=this.leftDataCol;m<this.leftDataCol+this.columnsToRender;m++)y.push(e.qData[l][m]);for(var b=0;b<y.length;b++){y[b].pos="Data",y[b].width="".concat(this.columnParams.cellWidths[(this.options.freezeColumns||this.layout.qHyperCube.qNoOfLeftDims)+b]||this.columnParams.cellWidths[this.columnParams.cellWidths.length-1],"px"),y[b].qAttrExps&&y[b].qAttrExps.qValues&&y[b].qAttrExps.qValues[0]&&y[b].qAttrExps.qValues[0].qText&&(y[b].backgroundColor=y[b].qAttrExps.qValues[0].qText,y[b].color=this.getFontColor(y[b].qAttrExps.qValues[0].qText)),y[b].qAttrExps&&y[b].qAttrExps.qValues&&y[b].qAttrExps.qValues[1]&&y[b].qAttrExps.qValues[1].qText&&(y[b].color=this.getFontColor(y[b].qAttrExps.qValues[1].qText));var g=c[c.length-1][b];-1===["T","E"].indexOf(y[b].qType)&&-1===["T"].indexOf(g.qType)||(y[b].qType="T"),y[b].value=y[b].qText}u[l]&&(y=u[l].concat(y)),t.push(y)}for(var v=[],x=d,C=0;C<x;C++)v.push({rowspan:1,colSpan:1,level:0,qText:"",qType:"V"});if(0!==d)for(var D=0;D<c.length;D++)D===c.length-1?c[D]=this.layout.qHyperCube.qDimensionInfo.filter(function(e){return!e.qError}).filter(function(e,t){return t<d}).map(function(e,t){return _extends({},e,{name:e.qFallbackTitle,width:"".concat(o.columnParams.cellWidths[t]||o.columnParams.cellWidths[o.columnParams.cellWidths.length-1],"px")})}).concat(c[D]):c[D]=v.concat(c[D]);function T(e,t,o,a,n){var i=_extends({},e);if(i.level=t,i.pos="Left",i.value=i.qText,e.value=e.qText,d=Math.max(d,t+1),i.childCount=i.qSubNodes.length,i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[0]&&i.qAttrExps.qValues[0].qText&&(i.backgroundColor=i.qAttrExps.qValues[0].qText,i.color=this.getFontColor(i.qAttrExps.qValues[0].qText)),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[1]&&i.qAttrExps.qValues[1].qText&&(i.color=this.getFontColor(i.qAttrExps.qValues[1].qText)),delete i.qSubNodes,void 0===i.qText&&(-1===i.qElemNo?i.qText="Totals??":-4===i.qElemNo&&(i.qText="",i.qType="T")),i.rowspan=Math.max(1,e.qSubNodes.length),e.rowspan=Math.max(1,e.qSubNodes.length),0===e.qSubNodes.length)u.push(f.concat([i])),f=[];else{f.push(i);for(var s=0;s<e.qSubNodes.length;s++)T.call(this,e.qSubNodes[s],t+1,s,e,[].concat(_toConsumableArray(n),[i]));for(var r=0,l=0;l<e.qSubNodes.length;l++)r+=e.qSubNodes[l].rowspan;e.rowspan=r,i.rowspan=r}}function w(e,t,o,a){var n;void 0===c[t]&&(c[t]=[]);var i=_extends({},e);if(i.level=t,i.pos="Top",i.rowIndex=p,i.topNode=!0,i.isHeader=!0,i.name=i.qText,i.font||(i.font={}),e.value=e.qText,"P"===i.qType&&(i.qElemNo=-99),i.childCount=i.qSubNodes.length,q=Math.max(q,t+1),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[0]&&i.qAttrExps.qValues[0].qText&&(i.backgroundColor=i.qAttrExps.qValues[0].qText,i.color=this.getFontColor(i.qAttrExps.qValues[0].qText)),i.qAttrExps&&i.qAttrExps.qValues&&i.qAttrExps.qValues[1]&&i.qAttrExps.qValues[1].qText&&(i.color=this.getFontColor(i.qAttrExps.qValues[1].qText)),delete i.qSubNodes,-1===["T","E"].indexOf(i.qType)&&(i.qType="B"),void 0!==a&&"T"===a.qType&&(i.qType=a.qType,e.qType=a.qType),void 0===i.qText&&(-1===i.qElemNo?i.qText=this.layout.tableTotalsLabel:-4===i.qElemNo&&(i.qText="",i.qType="T",e.qType="T")),i.colSpan=Math.max(1,e.qSubNodes.length),e.colSpan=Math.max(1,e.qSubNodes.length),0===e.qSubNodes.length)-99===i.qElemNo&&!0===i.qCanCollapse&&h++;else{for(var s=0;s<e.qSubNodes.length;s++)w.call(this,e.qSubNodes[s],t+1,s,e);for(var r=0,l=0;l<e.qSubNodes.length;l++)r+=e.qSubNodes[l].colSpan;i.rowIndex=p,p+=r,i.colSpan=r,e.colSpan=r,"T"===i.qType&&-1===i.qElemNo&&(h+=r),-99===i.qElemNo&&h++,!0!==e.qCanExpand&&!0!==e.qCanCollapse||(0<e.qSubNodes.length&&!0===e.qCanCollapse&&void 0!==e.qSubNodes[0].rowIndex?(e.rowIndex=e.qSubNodes[0].rowIndex,i.rowIndex=e.qSubNodes[0].rowIndex):(e.rowIndex=h,i.rowIndex=h,h+=i.colSpan))}var u=[i];1<i.colSpan&&(u=new Array(i.colSpan).fill(_objectSpread({},i))),(n=c[t]).push.apply(n,_toConsumableArray(u))}return c[c.length-1],t=c.concat(t)}}]),a}();if("undefined"!=typeof WebsyDesigns){WebsyDesigns.QlikPlugins={Chart:Chart,Table:Table,Table2:Table2,GeoMap:GeoMap,Dropdown:Dropdown,DatePicker:DatePicker,KPI:KPI},window.WebsyDesignsQlikPlugins={Chart:Chart,Table:Table,Table2:Table2,GeoMap:GeoMap,Dropdown:Dropdown,DatePicker:DatePicker,KPI:KPI};var ObjectManager=function(){function a(e){_classCallCheck(this,a);var t={helpEvent:"mouseover",applySelections:!1,actions:[],retryCount:5,initialActions:[],visualisationPlugins:[{id:"kpi",definition:KPI},{id:"table",definition:Table},{id:"chart",definition:Chart},{id:"map",definition:GeoMap},{id:"dropdown",definition:Dropdown},{id:"datepicker",definition:DatePicker}]};if(this.app=null,this.paused=!1,this.supportedChartTypes=[],this.activeViews=[],this.chartLibrary={},this.globalObjectsLoaded=!1,this.options=this.mergeObjects({},t,e),this.options.visualisationPlugins&&0<this.options.visualisationPlugins.length)for(var o=0;o<this.options.visualisationPlugins.length;o++)this.registerVisualisation(this.options.visualisationPlugins[o].id,this.options.visualisationPlugins[o].definition)}return _createClass(a,[{key:"buildChildElement",value:function(e,t){if(document.getElementById("".concat(e,"_vis")))return"";var o="\n      <article id='".concat(e,"_vis' class='websy-vis-article'></article>\n      <div id='").concat(e,"_loading' class='websy-loading-container'><div class='websy-ripple'><div></div><div></div></div></div>\n    ");return t&&""!==t&&(o+="\n        <i class='websy-vis-help-listener' data-element='".concat(e,"'></i>\n        <div id='").concat(e,"_help' class='websy-vis-help'><span>").concat(t||"","</span></div>        \n      ")),o}},{key:"mergeObjects",value:function(){var o={},a=!1,e=0;"boolean"==typeof arguments[0]&&(a=arguments[0],e++);for(var t=function(e){for(var t in e)e.hasOwnProperty(t)&&(a&&"[object Object]"===Object.prototype.toString.call(e[t])?o[t]=this.mergeObjects(!0,o[t],e[t]):Array.isArray(o[t])&&Array.isArray(e[t])?o[t]=o[t].concat(e[t]):o[t]=e[t])};e<arguments.length;e++)t(arguments[e]);return o}},{key:"init",value:function(){var o=this;return new Promise(function(e,t){o.prep("global"),o.connectToApp().then(function(){o.executeAction(0,o.options.initialActions,function(){o.selectFromUrl(function(){e()})})},t)})}},{key:"pause",value:function(){this.paused=!0}},{key:"play",value:function(e,t){if(void 0===t&&(t=[]),!(this.paused=!1)===e){-1===t.indexOf("global")&&this.loadObjects("global");for(var o=0;o<this.activeViews.length;o++)-1===t.indexOf(this.activeViews[o])&&this.loadObjects(this.activeViews[o])}}},{key:"request",value:function(e,n,i,s){return new Promise(function(t,o){var a=new XMLHttpRequest;a.open(e,n),a.setRequestHeader("Content-Type","application/json"),a.responseType="text",s&&(a.responseType=s),a.withCredentials=!0,a.onload=function(){var e="text"===a.responseType?a.responseText:a.response;if(""!==e&&"null"!==e)try{e=JSON.parse(e)}catch(e){}else e=null;e.err?o(JSON.stringify(e)):t(e)},a.onerror=function(){return o(a.statusText)},i?a.send(JSON.stringify(i)):a.send()})}},{key:"prep",value:function(e){for(var n=this,t=0;t<this.options.views[e].objects.length;t++){var o=this.options.views[e].objects[t],a=document.getElementById(o.elementId);a&&(a.innerHTML+=this.buildChildElement(o.elementId,o.help),o.help&&""!==o.help&&(a.addEventListener(this.options.helpEvent,this.handleEvent.bind(this)),a.addEventListener("mouseout",this.handleEvent.bind(this))))}for(var i=function(a){var e=document.getElementById(n.options.actions[a].elementId);e&&e.addEventListener(n.options.actions[a].event,function(){for(var e=function(e){var t,o=n.options.actions[a].items[e];(void 0===o.params&&(o.params=[]),o.field)?n.app.getField(o.field).then(function(e){e[o.method].apply(e,_toConsumableArray(o.params))}):(t=n.app)[o.method].apply(t,_toConsumableArray(o.params))},t=0;t<n.options.actions[a].items.length;t++)e(t)})},s=0;s<this.options.actions.length;s++)i(s);this.options.views[e].prepped=!0}},{key:"connectToApp",value:function(){var s=this;return new Promise(function(t,o){var a=s.options.enigmaConfig.app;if(s.options.enigmaConfig.app&&(s.options.enigmaConfig.app=s.normalizeId(s.options.enigmaConfig.app)),"undefined"!=typeof enigma)if(void 0!==s.options.enigmaSchema){var e=s.options.enigmaConfig.url;s.options.enigmaConfig.ticket&&(-1===e.indexOf("?")?e+="?":e+="&",e+="qlikTicket=".concat(s.options.enigmaConfig.ticket));var n={schema:s.options.enigmaSchema,url:e},i=enigma.create(n);(s.session=i).open().then(function(e){(s.global=e).getActiveDoc().then(function(e){if(!e)return s.openApp(a).then(function(){t()});s.app=e,s.options.views.global?s.executeActions("global").then(function(){t()}):t()},function(e){if(a)return s.openApp(a).then(function(){t()},function(e){s.sessionOnNotification({err:e})});t()}),!0===s.options.keepAlive&&s.keepAlive()},function(e){o(e)}),i.on("traffic:received",function(e){void 0!==e.suspend&&s.sessionSuspended()}),i.on("notification:*",function(e,t){"OnAuthenticationInformation"===e?!0===t.mustAuthenticate?s.options.enigmaConfig.authUrl?window.location=s.options.enigmaConfig.authUrl+window.location.search.replace("?","%3F").replace("=","%3D"):s.options.enigmaConfig.onMustAuthenticate?s.options.enigmaConfig.onMustAuthenticate():t.loginUri&&(window.location=t.loginUri):!1===t.mustAuthenticate&&(s.user={userDirectory:t.userDirectory,userId:t.userId}):s.sessionOnNotification(t,e)}),i.on("suspended",s.sessionSuspended.bind(s)),i.on("resumed",s.sessionResumed.bind(s)),i.on("closed",s.sessionClosed.bind(s))}else o({error:"enigmaSchema property not found."});else o({error:"Enigma.js not found."})})}},{key:"closeApp",value:function(){for(var e in this.session.close(),this.app=null,this.options.views)this.options.views[e].objects.forEach(function(e){delete e.objectId,delete e.vis,e.attached=!1}),delete this.options.views[e]}},{key:"keepAlive",value:function(){var e=this;this.global.engineVersion(),setTimeout(function(){e.keepAlive()},59e3)}},{key:"openApp",value:function(e){var a=this;return new Promise(function(t,o){a.global.openDoc(e).then(function(e){a.app=e,a.options.views.global?a.executeActions("global").then(function(){t()}):t()},function(e){o(e)})})}},{key:"loadView",value:function(e,t){var o=this;void 0===t&&(t=!1),!0===this.paused&&!1===t||""!==e&&this.options.views[e]&&(-1===this.activeViews.indexOf(e)&&"global"!==e&&this.activeViews.push(e),this.options.views[e].controller&&!0!==this.options.views[e].initialized?this.options.views[e].controller.init(function(){(o.options.views[e].initialized=!0)!==o.options.views[e].prepped&&o.prep(e),o.executeActions(e).then(function(){!1!==o.globalObjectsLoaded&&!0!==o.options.alwaysLoadGlobal||"global"===e||(o.loadObjects("global",t),o.globalObjectsLoaded=!0),o.loadObjects(e,t),"global"===e&&(o.globalObjectsLoaded=!0)})}):(!0!==this.options.views[e].prepped&&this.prep(e),console.log("Running Actions",e),this.executeActions(e).then(function(){console.log("Actions complete",e),!1!==o.globalObjectsLoaded&&!0!==o.options.alwaysLoadGlobal||"global"===e||(o.loadObjects("global",t),o.globalObjectsLoaded=!0),o.loadObjects(e,t),"global"===e&&(o.globalObjectsLoaded=!0)})))}},{key:"executeAction",value:function(t,o,a){var e,n=this,i=o[t];(void 0===i.params&&(i.params=[]),i.field)?this.app.getField(i.field).then(function(e){e[i.method].apply(e,_toConsumableArray(i.params)).then(function(){!0===i.lock?e.lock().then(function(){++t===o.length?a():n.executeAction(t,o,a)}):++t===o.length?a():n.executeAction(t,o,a)})}):(e=this.app)[i.method].apply(e,_toConsumableArray(i.params)).then(function(){++t===o.length?a():n.executeAction(t,o,a)})}},{key:"executeActions",value:function(o){var a=this;return new Promise(function(e,t){a.options.views[o]&&a.options.views[o].actions&&0!==a.options.views[o].actions.length||e(),a.executeAction(0,a.options.views[o].actions,e)})}},{key:"loadObjects",value:function(e,t){var o=this;if(console.log("Loading objects",e),void 0===t&&(t=!1),!0!==this.paused||!1!==t){var a=this.options.views[e].objects;if(a&&0<a.length)for(var n=function(t){a[t].objectId?(a[t].attached=!0,a[t].vis&&a[t].vis.render?a[t].vis.render():a[t].render&&a[t].render(a[t],a[t].model)):a[t].definition&&"string"==typeof a[t].definition&&-1!==a[t].definition.toLowerCase().indexOf(".json")?o.request("GET",a[t].definition).then(function(e){a[t].definition=e,o.createObjectFromDefinition(a[t])}):o.createObjectFromDefinition(a[t])},i=0;i<a.length;i++)n(i)}}},{key:"closeObjects",value:function(e){this.closeView(e)}},{key:"closeView",value:function(e){if(""!==e&&this.options.views[e]){var t=this.activeViews.indexOf(e);-1!==t&&this.activeViews.splice(t,1);var o=this.options.views[e].objects;if(o&&0<o.length)for(var a=0;a<o.length;a++)o[a].vis?(o[a].attached=!1,o[a].vis.close&&o[a].vis.close()):o[a].objectId&&(o[a].close&&o[a].close(),this.destroyObjectFromId(o[a]))}}},{key:"handleEvent",value:function(e){if(e.target.classList.contains("websy-vis-help-listener")){var t=e.target.attributes["data-element"];t.value&&this.toggleHelp("".concat(t.value,"_help"))}}},{key:"createObjectFromDefinition",value:function(o){var a=this;if(o.retries&&(o.retries=0),o.definition&&this.app){console.log("Creating object",o.definition.qInfo);var e="createSessionObject",t=o.definition;o.definition.qField&&(e="getField",t=o.definition.qField),this.app[e](t).then(function(e){if(o.objectId=e.id,o.attached=!0,-1!==a.supportedChartTypes.indexOf(o.definition.qInfo.qType)){var t=_extends({},o.options,{model:e,def:o.definition,app:a.app});o.vis=new a.chartLibrary[o.definition.qInfo.qType]("".concat(o.elementId,"_vis"),t),e.on("changed",function(){!0===o.attached&&!1===a.paused&&o.vis.render()})}else o.render&&"function"==typeof o.render&&(o.vis={},o.attached=!0,o.model=e,o.render(o,e),e.on("changed",function(){!0===o.attached&&!1===a.paused&&o.render(o,e)}))},function(e){console.log("Error creating object",e),o.retries<a.options.retryCount?(console.log("retrying"),o.retries++,a.createObjectFromDefinition(o)):console.log("Max retries reached.")})}else o.type&&(o.objectId=o.elementId,o.attached=!0,o.vis=new this.chartLibrary[o.type]("".concat(o.elementId,"_vis"),o.options||{}))}},{key:"destroyObjectFromId",value:function(e){var t=document.getElementById("".concat(e.elementId,"_vis"));t&&(t.innerHTML=""),this.app.destroySessionObject(e.objectId)}},{key:"detachObject",value:function(e){e.attached=!1}},{key:"normalizeId",value:function(e){return e.replace(/\s:\\\//,"-")}},{key:"sessionOnNotification",value:function(e,t){this.options.sessionOnNotification&&this.options.sessionOnNotification(e,t)}},{key:"sessionOnTraffic",value:function(e){this.options.sessionOnTraffic&&this.options.sessionOnTraffic(e)}},{key:"sessionResumed",value:function(e){this.options.sessionResumed&&this.options.sessionResumed(e)}},{key:"sessionSuspended",value:function(e){this.options.sessionSuspended&&this.options.sessionSuspended(e)}},{key:"sessionClosed",value:function(e){this.options.sessionClosed&&this.options.sessionClosed(e)}},{key:"showHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.add("active")}},{key:"hideHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.remove("active")}},{key:"toggleHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.toggle("active")}},{key:"onError",value:function(e){console.log(e)}},{key:"onClose",value:function(e){}},{key:"resize",value:function(){for(var e=0;e<this.activeViews.length;e++)this.resizeObjects(this.activeViews[e])}},{key:"resizeObjects",value:function(e){if(""!==e){var t=this.options.views[e].objects;if(t&&0<t.length)for(var o=0;o<t.length;o++)t[o].objectId&&(t[o].vis&&t[o].vis.resize?t[o].vis.resize():t[o].resize&&t[o].resize())}}},{key:"registerVisualisation",value:function(e,t){-1===e.indexOf(/\s/)?-1===this.supportedChartTypes.indexOf(e)?(this.supportedChartTypes.push(e),this.chartLibrary[e]=t):console.log("Failed to register Chart Extension. Chart name already exists."):console.log("Failed to register Chart Extension. Chart name must not contain spaces.")}},{key:"select",value:function(o,a,n){var i=this;o!==a.length?"select"===a[o].param&&this.app.getField(a[o].field,a[o].state).then(function(e){var t=a[o].values.map(function(e){var t=+e;if(isNaN(t)){var o=new Date(e);return isNaN(o.getDate())?{qText:decodeURI(e)}:{qNumber:WebsyDesigns.Utils.toQlikDate(o),qIsNumeric:!0}}return{qNumber:t,qIsNumeric:!0}});e.selectValues(t).then(function(){o++,i.select(o,a,n)})},function(e){console.log("field for selection not found",e),o++,i.select(o,a,n)}):n()}},{key:"selectFromUrl",value:function(e){if(!0===this.options.applySelections&&""!==location.search){var t=location.search.replace("?","").split("&");t=t.map(function(e){var t=e.split("="),o=t[1].split(","),a=o.shift().replace(/%20/g," "),n="$";return-1!==a.indexOf("::")&&(n=a.split("::")[0],a=a.split("::")[1]),{param:t[0],field:a,state:n,values:o}}).filter(function(e){return"select"===e.param||"setvariable"===e.param}),this.select(0,t,e)}else e()}}]),a}();WebsyDesigns.QlikObjectManager=ObjectManager}