"use strict";function ownKeys(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}var Chart=function(){function i(e,t){var n=this;_classCallCheck(this,i),this.elementId=e,this.options=_extends({},t),this.optionDefaults={data:{left:{min:0,max:0},right:{min:0,max:0},bottom:{min:0,max:0},top:{min:0,max:0},series:[]}},this.chart=new WebsyDesigns.WebsyChart(e),window.addEventListener("resize",function(){return n.chart.render()}),this.monthMap={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"},this.render()}return _createClass(i,[{key:"addOptions",value:function(e,t){for(var n in t)e[n]=t[n]}},{key:"close",value:function(){this.chart.close()}},{key:"createSeriesKey",value:function(e){return e.replace(/ /g,"_")}},{key:"formatValue",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};console.log("formatting",e,t);var n=0,i=!1;return t.decimals&&(n=t.decimals),!0===t.showAsPercentage&&(i=t.showAsPercentage),"Time"===(t||{}).scale&&e.getDate?e="".concat(e.getDate()," ").concat(this.monthMap[e.getMonth()]," ").concat(e.getFullYear()):isNaN(e)||(e=WebsyDesigns.Utils.toReduced(e,n,i,!1,t.max),!0===t.showAsCurrency&&(e=e.toCurrency())),e}},{key:"fromQlikDate",value:function(e){var t=new Date(Math.round(864e5*(e-25569)));return t.setTime(t.getTime()+6e4*t.getTimezoneOffset()),t}},{key:"render",value:function(){var n=this;this.options.model.getLayout().then(function(e){n.layout=e,console.log(n.layout);var t={};1===e.qHyperCube.qDimensionInfo.length&&1===e.qHyperCube.qMeasureInfo.length?t=n.transformMultiMeasure():1===e.qHyperCube.qDimensionInfo.length&&1<e.qHyperCube.qMeasureInfo.length?t=n.transformMultiMeasure():1<e.qHyperCube.qDimensionInfo.length?t=n.transformMultiDimensions():0===e.qHyperCube.qDimensionInfo.length&&0<e.qHyperCube.qMeasureInfo.length&&(t=n.transformNoDimensions()),n.chart.render(t)})}},{key:"resize",value:function(){this.chart.render()}},{key:"transformBasic",value:function(){var t=this,n=_extends({},this.optionDefaults,this.layout.options);this.addOptions(n.data.left,this.layout.qHyperCube.qMeasureInfo[0].options||{}),n.data.left.min=this.layout.qHyperCube.qMeasureInfo[0].qMin,n.data.left.max=this.layout.qHyperCube.qMeasureInfo[0].qMax,n.data.left.label=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,this.addOptions(n.data.bottom,this.layout.qHyperCube.qDimensionInfo[0].options||{}),n.data.bottom.label=this.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle,n.data.bottom.data=[],n.data.left.title=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,n.data.left.formatter=function(e){return t.formatValue(e,t.layout.qHyperCube.qMeasureInfo[0].options||{})};var i=this.layout.qHyperCube.qMeasureInfo[0].options||{};return i.data=[],i.key=this.createSeriesKey(this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle),this.layout.qHyperCube.qDataPages[0].qMatrix.forEach(function(e){e[0].value=e[0].qText,e[1].value=isNaN(e[1].qNum)?0:e[1].qNum,e[1].tooltipValue=e[1].qText,n.data.bottom.data.push(e[0]),i.data.push({x:e[0],y:e[1]})}),n.data.series=[i],n}},{key:"transformMultiDimensions",value:function(){var t=this,i=_extends({},this.optionDefaults,this.layout.options);this.addOptions(i.data.left,this.layout.qHyperCube.qMeasureInfo[0].options||{}),i.data.left.min=this.layout.qHyperCube.qMeasureInfo[0].qMin,i.data.left.max=this.layout.qHyperCube.qMeasureInfo[0].qMax,i.data.left.label=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,this.addOptions(i.data.bottom,this.layout.qHyperCube.qDimensionInfo[1].options||{}),i.data.bottom.label=this.layout.qHyperCube.qDimensionInfo[1].qFallbackTitle,i.data.bottom.data=[],i.data.left.title=this.layout.qHyperCube.qMeasureInfo[0].qFallbackTitle,i.data.left.formatter=function(e){return t.formatValue(e,t.layout.qHyperCube.qMeasureInfo[0].options||{})};var o=[],a=[],s=[];return this.layout.qHyperCube.qDataPages[0].qMatrix.forEach(function(e){var t=a.indexOf(e[0].qText);-1===s.indexOf(e[1].qText)&&(s.push(e[1].qText),e[1].value=e[1].qText,i.data.bottom.data.push(e[1])),-1===t&&(a.push(e[0].qText),t=a.length-1,o.push({key:"series_".concat(t),type:i.type||"bar",label:e[0].qText,data:[]}));var n=e[2];n.value=isNaN(n.qNum)?0:n.qNum,n.tooltipLabel=e[0].qText,n.tooltipValue=n.qText,o[t].data.push({x:{value:e[1].qText},y:n})}),i.data.series=o,console.log(i),i}},{key:"transformNoDimensions",value:function(){var n=this,t=_extends({},this.optionDefaults,this.layout.options),i="bottom",o="left",e="Band",a="Linear";return"horizontal"===t.orientation&&(i="left",o="bottom",e="Linear",a="Band"),t.data[i].scale=e,t.data[o].scale=a,t.data[i].padding=t.padding||0,t.data[i].data=[],t.xTitle&&(t.data[i].title=t.xTitle,t.data[i].showTitle=!0,t.data[i].titlePosition=1),t.data[o].formatter=function(e){return n.formatValue(e,t||{})},this.layout.qHyperCube.qMeasureInfo.forEach(function(e){t.data[i].data.push({value:e.qFallbackTitle}),t.data[o].min=Math.min(t.data[o].min,e.qMin),t.data[o].max=Math.max(t.data[o].max,e.qMax)}),t.yMinOverride&&(t.data[o].min=t.yMinOverride),t.yMaxOverride&&(t.data[o].max=t.yMaxOverride),this.layout.qHyperCube.qDataPages[0]&&(t.data.series=[{key:this.layout.qInfo.qId,type:t.type||"bar",color:t.color,data:this.layout.qHyperCube.qDataPages[0].qMatrix.map(function(e){return e.map(function(e,t){return e.value=isNaN(e.qNum)?0:e.qNum,e.qAttrExps&&e.qAttrExps.qValues[0]&&e.qAttrExps.qValues[0].qText&&(e.label=e.qAttrExps.qValues[0].qText),{x:{value:n.layout.qHyperCube.qMeasureInfo[t].qFallbackTitle},y:e}})})[0]}]),t}},{key:"transformMultiMeasure",value:function(){var o=this,a=_extends({},this.optionDefaults,this.layout.options),s="bottom",i="left",r="right";if("horizontal"===a.orientation&&(s="left","right",i="bottom",r="top"),a.data[i].min=0,a.data[i].max=0,a.data[r].min=0,a.data[r].max=0,a.data.series=this.layout.qHyperCube.qMeasureInfo.map(function(t,e){var n=_extends({},t.options);return n.key=o.createSeriesKey(t.qFallbackTitle),n.data=[],n.type=(t.options||{}).type||a.type||"bar",n.accumulative=0,"secondary"===t.axis?(o.addOptions(a.data[r],t.options||{}),"stacked"!==a.grouping&&(a.data[r].min=Math.min(a.data[r].min,t.qMin),a.data[r].max=Math.max(a.data[r].max,t.qMax)),a.data[r].scale=(t.options||{}).scale||"Linear",a.data[r].title=t.qFallbackTitle,a.data[r].formatter=function(e){return o.formatValue(e,_extends({},t.options,a.data[r]))}):(o.addOptions(a.data[i],t.options||{}),"stacked"!==a.grouping&&(a.data[i].min=Math.min(a.data[i].min,t.qMin),a.data[i].max=Math.max(a.data[i].max,t.qMax)),console.log("max",a.data[i].max),a.data[i].scale=(t.options||{}).scale||"Linear",a.data[i].title=t.qFallbackTitle,a.data[i].formatter=function(e){return o.formatValue(e,_extends({},t.options,a.data[i]))}),n}),this.addOptions(a.data[s],this.layout.qHyperCube.qDimensionInfo[0].options||{}),a.data[s].ticks&&-1!==a.data[s].ticks.indexOf("d3.time")){var e=a.data[s].ticks.split(".").pop();a.data[s]=d3.time[e]}a.data[s].title=this.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle,a.data[s].data=[],a.data[s].min=this.layout.qHyperCube.qDimensionInfo[0].qMin,a.data[s].max=this.layout.qHyperCube.qDimensionInfo[0].qMax,a.data[s].scale=(this.layout.qHyperCube.qDimensionInfo[0].options||{}).scale||"Band","Time"!==a.data[s].scale?a.data[s].formatter=function(e){return o.formatValue(e,o.layout.qHyperCube.qDimensionInfo[0].options||{})}:(a.data[s].min=this.fromQlikDate(this.layout.qHyperCube.qDimensionInfo[0].qMin),a.data[s].max=this.fromQlikDate(this.layout.qHyperCube.qDimensionInfo[0].qMax));var l=[],u=[],c=[];return this.layout.qHyperCube.qDataPages[0].qMatrix.map(function(i){i.forEach(function(e,t){if(0!==t){var n=i[0];n.value=n.qText,"Time"===(o.layout.qHyperCube.qDimensionInfo[0].options||{}).scale&&(n.value=o.fromQlikDate(n.qNum)),-1===l.indexOf(n.qElemNumber)&&(l.push(n.qElemNumber),c.push(0),u.push(0),a.data[s].data.push(n)),e.value=isNaN(e.qNum)?0:e.qNum,u[l.indexOf(n.qElemNumber)]+=e.value,e.tooltipLabel=o.layout.qHyperCube.qMeasureInfo[t-1].qFallbackTitle,e.tooltipValue=e.qText,e.index=t,e.accumulative=c[l.indexOf(n.qElemNumber)],c[l.indexOf(n.qElemNumber)]+=e.value,n.index=l.indexOf(n.value),a.data.series[t-1].data.push({x:n,y:e})}else"Time"!==a.data[s].scale&&(a.data[s].min=a.data[s].min.length<e.qText.length?a.data[s].min:e.qText,a.data[s].max=a.data[s].max.length>e.qText.length?a.data[s].max:e.qText)})}),"stacked"===a.grouping&&(a.data[i].min=0,a.data[i].max=Math.max.apply(Math,u),a.data[r].min=0,a.data[r].max=Math.max.apply(Math,u)),console.log("options",a,u),a}}]),i}(),DatePicker=function(){function n(e,t){_classCallCheck(this,n),this.elementId=e,this.options=_extends({},t),this.picker=new WebsyDesigns.WebsyDatePicker(e,{onChange:this.onChange.bind(this)}),this.listening=!0,this.render()}return _createClass(n,[{key:"floorDate",value:function(e){return"number"==typeof e&&(e=new Date(e)),new Date(e.setHours(0,0,0,0))}},{key:"fromQlikDate",value:function(e){var t=new Date(Math.round(864e5*(e-25569)));return t.setTime(t.getTime()+6e4*t.getTimezoneOffset()),this.floorDate(t)}},{key:"getField",value:function(n){var i=this;return new Promise(function(t,e){i.field?t(i.field):objectManager.app.getField(n).then(function(e){e&&(i.field=e,t(i.field))},e)})}},{key:"toQlikDate",value:function(e){var t=e.getDate();1===t.toString().length&&(t="0".concat(t));var n=e.getMonth()+1;1===n.toString().length&&(n="0".concat(n));var i=e.getFullYear();return"".concat(i,"-").concat(n,"-").concat(t)}},{key:"toQlikDateNum",value:function(e){return Math.floor(e.getTime()/864e5+25569)}},{key:"onChange",value:function(e){var t,n=this,i=this.toQlikDate(e[0]);e[1]&&e[0].getTime()!==e[1].getTime()&&(t=this.toQlikDate(e[1]));var o="".concat(i);t&&(o=">=".concat(i,"<=").concat(t)),this.getField("Date").then(function(e){n.listening=!1,e.select(o)})}},{key:"render",value:function(){var c=this;this.options.model.getLayout().then(function(e){var i,o,t=[],n=[];if(e.qListObject.qDataPages[0]&&!0===c.listening){for(var a={},s=c.fromQlikDate(e.qListObject.qDataPages[0].qMatrix[0][0].qNum).getTime(),r=(c.fromQlikDate(e.qListObject.qDataPages[0].qMatrix[e.qListObject.qDataPages[0].qMatrix.length-1][0].qNum).getTime()-s)/864e5,l=0;l<r+1;l++){var u=new Date(s+864e5*l);u.setHours(0,0,0),a[u.getTime()]={qNum:c.toQlikDateNum(u),qState:"Z"}}e.qListObject.qDataPages[0].qMatrix.forEach(function(e,t,n){a[c.fromQlikDate(e[0].qNum).getTime()]&&(a[c.fromQlikDate(e[0].qNum).getTime()]=e[0]),0===t?i=c.fromQlikDate(e[0].qNum):t===n.length-1&&(o=c.fromQlikDate(e[0].qNum))}),Object.values(a).forEach(function(e){"S"===e.qState&&n.push(c.fromQlikDate(e.qNum)),-1!==["Z"].indexOf(e.qState)&&t.push(c.fromQlikDate(e.qNum))}),c.picker.setDateBounds([i,o]),0<n.length&&c.picker.selectCustomRange([n[0],n[n.length-1]||n[0]]),c.picker.render(t),c.listening=!0}})}}]),n}(),Dropdown=function(){function n(e,t){_classCallCheck(this,n),this.elementId=e;this.options=_extends({},{pageSize:100},t),this.dropdownOptions=_extends({},t.def.options,{onItemSelected:this.itemSelected.bind(this),onClearSelected:this.clearSelected.bind(this),onSearch:this.search.bind(this),onCancelSearch:this.cancelSearch.bind(this)}),this.dropdown=new WebsyDesigns.WebsyDropdown(e,this.dropdownOptions),this.render()}return _createClass(n,[{key:"cancelSearch",value:function(e){this.options.model.abortListObjectSearch("/qListObjectDef")}},{key:"checkForData",value:function(n){var i=this;return new Promise(function(t,e){i.options.model.getListObjectData("/qListObjectDef",[{qTop:0,qLeft:0,qWidth:1,qHeight:i.options.pageSize}]).then(function(e){n.qListObject.qDataPages=e,t(n)},e)})}},{key:"clearSelected",value:function(){this.options.model.clearSelections("/qListObjectDef")}},{key:"itemSelected",value:function(e,t,n){this.options.model.selectListObjectValues("/qListObjectDef",[e.qElemNumber],!0===this.dropdown.options.multiSelect)}},{key:"render",value:function(){var i=this;this.options.model.getLayout().then(function(e){i.checkForData(e).then(function(e){if(e.qListObject.qDataPages[0]){i.dropdown.options.label=e.qListObject.qDimensionInfo.qFallbackTitle;var n={};!0===i.options.hideExcluded&&(e.qListObject.qDataPages[0].qMatrix=e.qListObject.qDataPages[0].qMatrix.filter(function(e){return-1===["X","XS","XL"].indexOf(e[0].qState)})),e.qListObject.qDataPages[0].qMatrix.forEach(function(e,t){n[e[0].qState]||(n[e[0].qState]=[]),n[e[0].qState].push(t)}),n.S&&0<n.S.length?i.dropdown.selectedItems=n.S:n.S&&0===n.S.length&&n.O&&1===n.O.length?i.dropdown.selectedItems=n.O:i.dropdown.selectedItems=[];var t=e.qListObject.qDataPages[0].qMatrix.map(function(e){return _extends(e[0],{label:e[0].qText||"-",classes:["state-".concat(e[0].qState)]})});i.dropdown.data=t}})})}},{key:"search",value:function(e){this.options.model.searchListObjectFor("/qListObjectDef","*".concat(e,"*"))}}]),n}(),KPI=function(){function n(e,t){_classCallCheck(this,n),this.elementId=e,this.options=_extends({},t),this.kpiOptions={},this.kpi=new WebsyDesigns.WebsyKPI(e,this.kpiOptions),this.render()}return _createClass(n,[{key:"close",value:function(){this.kpiOptions.value={value:"-"},this.kpiOptions.subValue={value:""},this.kpi.render(this.kpiOptions)}},{key:"render",value:function(){var i=this;this.options.model.getLayout().then(function(e){var t=e.kpi.qHyperCube.qDataPages[0].qMatrix[0][0].qText;if(i.kpiOptions.value={value:t},i.kpiOptions.label={value:e.kpi.qHyperCube.qMeasureInfo[0].qFallbackTitle},e.icon&&(i.kpiOptions.icon="".concat(window.location.origin,"/resources/svg/").concat(e.icon,".svg")),e.tooltip&&e.tooltip.value&&(i.kpiOptions.tooltip={value:e.tooltip.value},e.tooltip.classes&&(i.kpiOptions.tooltip.classes=e.tooltip.classes)),i.kpiOptions.subValue={value:""},e.kpi.qHyperCube.qMeasureInfo[1]){void 0!==e.kpi.qHyperCube.qMeasureInfo[1].decimals&&e.kpi.qHyperCube.qMeasureInfo[1].decimals;var n=e.kpi.qHyperCube.qDataPages[0].qMatrix[0][1].qText;i.kpiOptions.subValue={value:"".concat(e.kpi.qHyperCube.qMeasureInfo[1].qFallbackTitle," ").concat(n)}}i.kpi.render(i.kpiOptions)})}},{key:"resize",value:function(){this.kpi.resize()}}]),n}(),GeoMap=function(){function i(t,e){var n=this;_classCallCheck(this,i),this.elementId=t;this.options=_extends({},{geoFillColor:"#783c96",geoAutoFill:!0,geoShowTooltip:!0},e,e.def.options),this.options.geoJSON&&"string"==typeof this.options.geoJSON?WebsyDesigns.service.get(this.options.geoJSON).then(function(e){n.geoJSON=e,delete n.options.geoJSON,n.map=new WebsyDesigns.WebsyMap(t,n.options),n.render()}):(this.map=new WebsyDesigns.WebsyMap(t,this.options),this.render())}return _createClass(i,[{key:"findGeoJsonByProperty",value:function(e){for(var t=0;t<this.geoJSON.features.length;t++)if(this.geoJSON.features[t].properties.name.toLowerCase()===e.toLowerCase())return this.geoJSON.features[t];return null}},{key:"render",value:function(){var i=this,e=document.getElementById(this.elementId);e.parentElement&&e.parentElement.classList.add("loading"),this.options.model.getLayout().then(function(o){if(o.options&&(i.options=_extends({},o.options),i.map.options=_extends({},i.map.options,o.options)),o.qHyperCube.qDataPages[0]){if(i.geoJSON){var n={type:"FeatureCollection",features:[]};o.qHyperCube.qDataPages[0].qMatrix.forEach(function(e){var t=i.findGeoJsonByProperty(e[0].qText);t&&(!0===i.options.geoAutoFill&&(t.fillColor=i.options.geoFillColor,t.fillOpacity=.4+e[1].qNum/o.qHyperCube.qMeasureInfo[0].qMax*.6),e[1].qAttrExps&&e[1].qAttrExps.qValues&&e[1].qAttrExps.qValues[0]&&e[1].qAttrExps.qValues[0].qText&&(t.fillColor=e[1].qAttrExps.qValues[0].qText),!0===i.options.geoShowTooltip&&(t.tooltip="".concat(e[1].qText,"<br>").concat(t.properties.label),t.tooltipClass="websy-map-tooltip"),n.features.push(t))}),i.map.options.geoJSON=n}var a={};o.qHyperCube.qDataPages[0].qMatrix.forEach(function(i){i.forEach(function(e,t){if(0!==t&&"polygon"===(o.qHyperCube.qMeasureInfo[t-1].options||{}).type){a.polygons||(a.polygons=[]);var n=JSON.parse("[".concat(e.qText,"]"));a.polygons.push({label:i[0].qText,data:n.map(function(e){return e.map(function(e){return{Latitude:e[1],Longitude:e[0]}})})})}})}),i.map.options.data=a,e.parentElement&&e.parentElement.classList.remove("loading"),i.map.render()}})}}]),i}(),Table=function(){function i(e,t){_classCallCheck(this,i);this.elementId=e,this.options=_extends({},{pageSize:50},t),this.rowCount=0,this.errorCount=0,this.retryFn=null,this.busy=!1,this.table=new WebsyDesigns.WebsyTable(this.elementId,{onClick:this.handleClick.bind(this),onScroll:this.handleScroll.bind(this),onSort:this.handleSort.bind(this)});var n=document.getElementById(this.elementId);n&&n.addEventListener("click",this.handleClick.bind(this)),this.render()}return _createClass(i,[{key:"appendRows",value:function(e){this.table.appendRows(e)}},{key:"getData",value:function(t){var n=this;if(!1===this.busy)if((this.busy=!0)===this.options.getAllData)getAllData("qHyperCube",this.options.model,this.layout,function(e){n.rowCount=e.qHyperCube.qDataPages[0].qMatrix.length,n.busy=!1,t&&t(e.qHyperCube.qDataPages[0].qMatrix)});else{var e=[{qTop:this.rowCount,qLeft:0,qWidth:this.dataWidth,qHeight:1e4<this.dataWidth*this.options.pageSize?Math.floor(1e4/this.dataWidth):this.options.pageSize}];if(this.rowCount<this.layout.qHyperCube.qSize.qcy){var i="getHyperCubeData";"P"===this.layout.qHyperCube.qMode&&(i="getHyperCubePivotData"),this.options.model[i]("/qHyperCubeDef",e).then(function(e){e&&e[0]&&("P"===n.layout.qHyperCube.qMode?(n.layout.qHyperCube.qPivotDataPages.push(e[0]),n.rowCount+=e[0].qData.length):(e[0].qMatrix=e[0].qMatrix.filter(function(e){return"-"!==e[0].qText}),n.layout.qHyperCube.qDataPages.push(e[0]),n.rowCount+=e[0].qMatrix.length),n.busy=!1,t&&("P"===n.layout.qHyperCube.qMode?t(e[0]):t(e[0].qMatrix)))},function(e){n.errorCount<50&&(n.errorCount++,console.log("error getting data, attempt",n.errorCount),clearTimeout(n.retryFn),n.retryFn=setTimeout(function(){n.getData(t)},300))})}else this.busy=!1}}},{key:"handleClick",value:function(e,t,n,i){e.target.classList.contains("table-try-again")?this.render():t&&t.qElemNumber&&this.options.model.selectHyperCubeValues("/qHyperCubeDef",0,[t.qElemNumber],!1)}},{key:"handleScroll",value:function(e){var t=this;.7<e.target.scrollTop/(e.target.scrollHeight-e.target.clientHeight)&&this.getData(function(e){t.appendRows(t.transformData(e))})}},{key:"handleSort",value:function(e,t,n){var i=!0===t.reverseSort,o=[{qOp:"replace",qPath:"/qHyperCubeDef/qInterColumnSortOrder",qValue:JSON.stringify([n])}],a=n<this.layout.qHyperCube.qDimensionInfo.length?"qDimensions":"qMeasures",s=n<this.layout.qHyperCube.qDimensionInfo.length?n:n-this.layout.qHyperCube.qDimensionInfo.length;o.push({qOp:"replace",qPath:"/qHyperCubeDef/".concat(a,"/").concat(s,"/qDef/qReverseSort"),qValue:JSON.stringify(i)}),this.options.model.applyPatches(o)}},{key:"render",value:function(){var i=this;this.options.model.getLayout().then(function(e){i.layout=e,i.rowCount=0,i.errorCount=0,i.dataWidth=i.layout.qHyperCube.qSize.qcx,i.columnOrder=i.layout.qHyperCube.qColumnOrder,void 0===i.columnOrder&&(i.columnOrder=new Array(i.layout.qHyperCube.qSize.qcx).fill({}).map(function(e,t){return t}));var t=i.layout.qHyperCube.qDimensionInfo.concat(i.layout.qHyperCube.qMeasureInfo),n=i.layout.qHyperCube.qEffectiveInterColumnSortOrder[0];(t=t.map(function(e,t){return e.colIndex=i.columnOrder.indexOf(t),e.name=e.qFallbackTitle,e.tooltip&&(e.name+='\n          <div class="websy-info websy-info-dock-right" data-info="'.concat(e.tooltip,'">\n            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 512 512"><path d="M256,56C145.72,56,56,145.72,56,256s89.72,200,200,200,200-89.72,200-200S366.28,56,256,56Zm0,82a26,26,0,1,1-26,26A26,26,0,0,1,256,138Zm48,226H216a16,16,0,0,1,0-32h28V244H228a16,16,0,0,1,0-32h32a16,16,0,0,1,16,16V332h28a16,16,0,0,1,0,32Z"/></svg>\n          </div>\n          ')),e.reverseSort=n===t&&!0!==e.qReverseSort,e.activeSort=n===t,"A"===e.qSortIndicator?e.sort="asc":"D"===e.qSortIndicator&&(e.sort="desc"),e})).sort(function(e,t){return e.colIndex-t.colIndex}),i.getData(function(e){(i.table.options.columns=t,i.table.options.activeSort=n,i.table.render(),e.err)?document.getElementById("".concat(i.elementId,"_foot")).innerHTML="\n            <div class='request-abort-error'>Could not fetch data. Click <strong class='table-try-again'>here</strong> to try again</div>\n          ":i.appendRows(i.transformData(e))})},function(e){i.errorCount<50&&(i.errorCount++,console.log("error getting layout, attempt",i.errorCount),clearTimeout(i.retryFn),i.retryFn=setTimeout(function(){i.render()},300))})}},{key:"transformData",value:function(n){var i=this;if("S"===this.layout.qHyperCube.qMode)return n.map(function(e){return e.map(function(e,t){return(!0===i.table.options.columns[t].showAsLink||!0===i.table.options.columns[t].showAsNavigatorLink)&&e.qAttrExps&&e.qAttrExps.qValues&&e.qAttrExps.qValues[0].qText?(e.value=e.qAttrExps.qValues[0].qText,-1===e.value.indexOf("https://")&&(e.value="https://".concat(e.value)),e.displayText=e.qText||"-"):e.value=e.qText||"-",e})});var e=[{name:this.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle}];e=e.concat(n.qTop.map(function(e){return{name:e.qText?e.qText:"T"===e.qType?"Total":"-"}})),this.table.options.columns=e,this.table.render();var o=[];return n.qData.forEach(function(e,t){o.push([_objectSpread({value:n.qLeft[t].qText},n.qLeft[t])].concat(_toConsumableArray(e.map(function(e){var t,n,i,o;(e.value=e.qText||"-",e.qAttrExps&&e.qAttrExps.qValues&&e.qAttrExps.qValues[0].qText)&&(e.backgroundColor=e.qAttrExps.qValues[0].qText,-1!==e.backgroundColor.indexOf("#")?(t=(t=e.qAttrExps.qValues[0].qText.toLowerCase().replace("#","")).split(""),n=parseInt(t[0]+t[1],16),i=parseInt(t[2]+t[3],16),o=parseInt(t[4]+t[5],16)):-1!==e.backgroundColor.toLowerCase().indexOf("rgb")&&(n=(t=(t=e.qAttrExps.qValues[0].qText.toLowerCase().replace("rgb(","").replace(")","")).split(","))[0],i=t[1],o=t[2]),e.color=186<.299*n+.587*i+.114*o?"#000000":"#ffffff");return e}))))}),o}}]),i}();if("undefined"!=typeof WebsyDesigns){WebsyDesigns.QlikPlugins={Chart:Chart,Table:Table,GeoMap:GeoMap,Dropdown:Dropdown,DatePicker:DatePicker,KPI:KPI};var ObjectManager=function(){function i(e){_classCallCheck(this,i);var t={helpEvent:"mouseover",applySelections:!1,actions:[],retryCount:5,initialActions:[],visualisationPlugins:[{id:"kpi",definition:KPI},{id:"table",definition:Table},{id:"chart",definition:Chart},{id:"map",definition:GeoMap},{id:"dropdown",definition:Dropdown},{id:"datepicker",definition:DatePicker}]};if(this.app=null,this.paused=!1,this.supportedChartTypes=[],this.activeViews=[],this.chartLibrary={},this.globalObjectsLoaded=!1,this.options=this.mergeObjects({},t,e),this.options.visualisationPlugins&&0<this.options.visualisationPlugins.length)for(var n=0;n<this.options.visualisationPlugins.length;n++)this.registerVisualisation(this.options.visualisationPlugins[n].id,this.options.visualisationPlugins[n].definition)}return _createClass(i,[{key:"buildChildElement",value:function(e,t){if(document.getElementById("".concat(e,"_vis")))return"";var n="\n      <article id='".concat(e,"_vis' class='websy-vis-article'></article>\n      <div id='").concat(e,"_loading' class='websy-loading-container'><div class='websy-ripple'><div></div><div></div></div></div>\n    ");return t&&""!==t&&(n+="\n        <i class='websy-vis-help-listener' data-element='".concat(e,"'></i>\n        <div id='").concat(e,"_help' class='websy-vis-help'><span>").concat(t||"","</span></div>        \n      ")),n}},{key:"mergeObjects",value:function(){var n={},i=!1,e=0;"boolean"==typeof arguments[0]&&(i=arguments[0],e++);for(var t=function(e){for(var t in e)e.hasOwnProperty(t)&&(i&&"[object Object]"===Object.prototype.toString.call(e[t])?n[t]=this.mergeObjects(!0,n[t],e[t]):Array.isArray(n[t])&&Array.isArray(e[t])?n[t]=n[t].concat(e[t]):n[t]=e[t])};e<arguments.length;e++)t(arguments[e]);return n}},{key:"init",value:function(){var n=this;return new Promise(function(e,t){n.prep("global"),n.connectToApp().then(function(){n.executeAction(0,n.options.initialActions,function(){n.selectFromUrl(function(){e()})})},t)})}},{key:"pause",value:function(){this.paused=!0}},{key:"play",value:function(e,t){if(void 0===t&&(t=[]),!(this.paused=!1)===e){-1===t.indexOf("global")&&this.loadObjects("global");for(var n=0;n<this.activeViews.length;n++)-1===t.indexOf(this.activeViews[n])&&this.loadObjects(this.activeViews[n])}}},{key:"request",value:function(e,o,a,s){return new Promise(function(t,n){var i=new XMLHttpRequest;i.open(e,o),i.setRequestHeader("Content-Type","application/json"),i.responseType="text",s&&(i.responseType=s),i.withCredentials=!0,i.onload=function(){var e="text"===i.responseType?i.responseText:i.response;if(""!==e&&"null"!==e)try{e=JSON.parse(e)}catch(e){}else e=null;e.err?n(JSON.stringify(e)):t(e)},i.onerror=function(){return n(i.statusText)},a?i.send(JSON.stringify(a)):i.send()})}},{key:"prep",value:function(e){for(var o=this,t=0;t<this.options.views[e].objects.length;t++){var n=this.options.views[e].objects[t],i=document.getElementById(n.elementId);i&&(i.innerHTML+=this.buildChildElement(n.elementId,n.help),n.help&&""!==n.help&&(i.addEventListener(this.options.helpEvent,this.handleEvent.bind(this)),i.addEventListener("mouseout",this.handleEvent.bind(this))))}for(var a=function(i){var e=document.getElementById(o.options.actions[i].elementId);e&&e.addEventListener(o.options.actions[i].event,function(){for(var e=function(e){var t,n=o.options.actions[i].items[e];(void 0===n.params&&(n.params=[]),n.field)?o.app.getField(n.field).then(function(e){e[n.method].apply(e,_toConsumableArray(n.params))}):(t=o.app)[n.method].apply(t,_toConsumableArray(n.params))},t=0;t<o.options.actions[i].items.length;t++)e(t)})},s=0;s<this.options.actions.length;s++)a(s);this.options.views[e].prepped=!0}},{key:"connectToApp",value:function(){var s=this;return new Promise(function(t,n){var i=s.options.enigmaConfig.app;if(s.options.enigmaConfig.app&&(s.options.enigmaConfig.app=s.normalizeId(s.options.enigmaConfig.app)),"undefined"!=typeof enigma)if(void 0!==s.options.enigmaSchema){var e=s.options.enigmaConfig.url;s.options.enigmaConfig.ticket&&(-1===e.indexOf("?")?e+="?":e+="&",e+="qlikTicket=".concat(s.options.enigmaConfig.ticket));var o={schema:s.options.enigmaSchema,url:e},a=enigma.create(o);(s.session=a).open().then(function(e){(s.global=e).getActiveDoc().then(function(e){if(!e)return s.openApp(i).then(function(){t()});s.app=e,s.options.views.global?s.executeActions("global").then(function(){t()}):t()},function(e){if(i)return s.openApp(i).then(function(){t()},function(e){s.sessionOnNotification({err:e})});t()}),!0===s.options.keepAlive&&s.keepAlive()},function(e){n(e)}),a.on("traffic:received",function(e){void 0!==e.suspend&&s.sessionSuspended()}),a.on("notification:*",function(e,t){"OnAuthenticationInformation"===e?!0===t.mustAuthenticate?s.options.enigmaConfig.authUrl?window.location=s.options.enigmaConfig.authUrl+window.location.search.replace("?","%3F").replace("=","%3D"):s.options.enigmaConfig.onMustAuthenticate?s.options.enigmaConfig.onMustAuthenticate():t.loginUri&&(window.location=t.loginUri):!1===t.mustAuthenticate&&(s.user={userDirectory:t.userDirectory,userId:t.userId}):s.sessionOnNotification(t,e)}),a.on("suspended",s.sessionSuspended.bind(s)),a.on("resumed",s.sessionResumed.bind(s)),a.on("closed",s.sessionClosed.bind(s))}else n({error:"enigmaSchema property not found."});else n({error:"Enigma.js not found."})})}},{key:"closeApp",value:function(){for(var e in this.session.close(),this.app=null,this.options.views)this.options.views[e].objects.forEach(function(e){delete e.objectId,delete e.vis,e.attached=!1}),delete this.options.views[e]}},{key:"keepAlive",value:function(){var e=this;this.global.engineVersion(),setTimeout(function(){e.keepAlive()},59e3)}},{key:"openApp",value:function(e){var i=this;return new Promise(function(t,n){i.global.openDoc(e).then(function(e){i.app=e,i.options.views.global?i.executeActions("global").then(function(){t()}):t()},function(e){n(e)})})}},{key:"loadView",value:function(e,t){var n=this;void 0===t&&(t=!1),!0===this.paused&&!1===t||""!==e&&this.options.views[e]&&(-1===this.activeViews.indexOf(e)&&"global"!==e&&this.activeViews.push(e),this.options.views[e].controller&&!0!==this.options.views[e].initialized?this.options.views[e].controller.init(function(){(n.options.views[e].initialized=!0)!==n.options.views[e].prepped&&n.prep(e),n.executeActions(e).then(function(){!1!==n.globalObjectsLoaded&&!0!==n.options.alwaysLoadGlobal||"global"===e||(n.loadObjects("global",t),n.globalObjectsLoaded=!0),n.loadObjects(e,t),"global"===e&&(n.globalObjectsLoaded=!0)})}):(!0!==this.options.views[e].prepped&&this.prep(e),console.log("Running Actions",e),this.executeActions(e).then(function(){console.log("Actions complete",e),!1!==n.globalObjectsLoaded&&!0!==n.options.alwaysLoadGlobal||"global"===e||(n.loadObjects("global",t),n.globalObjectsLoaded=!0),n.loadObjects(e,t),"global"===e&&(n.globalObjectsLoaded=!0)})))}},{key:"executeAction",value:function(t,n,i){var e,o=this,a=n[t];(void 0===a.params&&(a.params=[]),a.field)?this.app.getField(a.field).then(function(e){e[a.method].apply(e,_toConsumableArray(a.params)).then(function(){!0===a.lock?e.lock().then(function(){++t===n.length?i():o.executeAction(t,n,i)}):++t===n.length?i():o.executeAction(t,n,i)})}):(e=this.app)[a.method].apply(e,_toConsumableArray(a.params)).then(function(){++t===n.length?i():o.executeAction(t,n,i)})}},{key:"executeActions",value:function(n){var i=this;return new Promise(function(e,t){i.options.views[n]&&i.options.views[n].actions&&0!==i.options.views[n].actions.length||e(),i.executeAction(0,i.options.views[n].actions,e)})}},{key:"loadObjects",value:function(e,t){var n=this;if(console.log("Loading objects",e),void 0===t&&(t=!1),!0!==this.paused||!1!==t){var i=this.options.views[e].objects;if(i&&0<i.length)for(var o=function(t){i[t].objectId?(i[t].attached=!0,i[t].vis&&i[t].vis.render?i[t].vis.render():i[t].render&&i[t].render(i[t],i[t].model)):i[t].definition&&"string"==typeof i[t].definition&&-1!==i[t].definition.toLowerCase().indexOf(".json")?n.request("GET",i[t].definition).then(function(e){i[t].definition=e,n.createObjectFromDefinition(i[t])}):n.createObjectFromDefinition(i[t])},a=0;a<i.length;a++)o(a)}}},{key:"closeObjects",value:function(e){this.closeView(e)}},{key:"closeView",value:function(e){if(""!==e&&this.options.views[e]){var t=this.activeViews.indexOf(e);-1!==t&&this.activeViews.splice(t,1);var n=this.options.views[e].objects;if(n&&0<n.length)for(var i=0;i<n.length;i++)n[i].vis?(n[i].attached=!1,n[i].vis.close&&n[i].vis.close()):n[i].objectId&&(n[i].close&&n[i].close(),this.destroyObjectFromId(n[i]))}}},{key:"handleEvent",value:function(e){if(e.target.classList.contains("websy-vis-help-listener")){var t=e.target.attributes["data-element"];t.value&&this.toggleHelp("".concat(t.value,"_help"))}}},{key:"createObjectFromDefinition",value:function(n){var i=this;if(n.retries&&(n.retries=0),n.definition&&this.app){console.log("Creating object",n.definition.qInfo);var e="createSessionObject",t=n.definition;n.definition.qField&&(e="getField",t=n.definition.qField),this.app[e](t).then(function(e){if(n.objectId=e.id,n.attached=!0,-1!==i.supportedChartTypes.indexOf(n.definition.qInfo.qType)){var t=_extends({},n.options,{model:e,def:n.definition,app:i.app});n.vis=new i.chartLibrary[n.definition.qInfo.qType]("".concat(n.elementId,"_vis"),t),e.on("changed",function(){!0===n.attached&&!1===i.paused&&n.vis.render()})}else n.render&&"function"==typeof n.render&&(n.vis={},n.attached=!0,n.model=e,n.render(n,e),e.on("changed",function(){!0===n.attached&&!1===i.paused&&n.render(n,e)}))},function(e){console.log("Error creating object",e),n.retries<i.options.retryCount?(console.log("retrying"),n.retries++,i.createObjectFromDefinition(n)):console.log("Max retries reached.")})}else n.type&&(n.objectId=n.elementId,n.attached=!0,n.vis=new this.chartLibrary[n.type]("".concat(n.elementId,"_vis"),n.options||{}))}},{key:"destroyObjectFromId",value:function(e){var t=document.getElementById("".concat(e.elementId,"_vis"));t&&(t.innerHTML=""),this.app.destroySessionObject(e.objectId)}},{key:"detachObject",value:function(e){e.attached=!1}},{key:"normalizeId",value:function(e){return e.replace(/\s:\\\//,"-")}},{key:"sessionOnNotification",value:function(e,t){this.options.sessionOnNotification&&this.options.sessionOnNotification(e,t)}},{key:"sessionOnTraffic",value:function(e){this.options.sessionOnTraffic&&this.options.sessionOnTraffic(e)}},{key:"sessionResumed",value:function(e){this.options.sessionResumed&&this.options.sessionResumed(e)}},{key:"sessionSuspended",value:function(e){this.options.sessionSuspended&&this.options.sessionSuspended(e)}},{key:"sessionClosed",value:function(e){this.options.sessionClosed&&this.options.sessionClosed(e)}},{key:"showHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.add("active")}},{key:"hideHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.remove("active")}},{key:"toggleHelp",value:function(e){var t=document.getElementById(e);t&&t.classList.toggle("active")}},{key:"onError",value:function(e){console.log(e)}},{key:"onClose",value:function(e){}},{key:"resize",value:function(){for(var e=0;e<this.activeViews.length;e++)this.resizeObjects(this.activeViews[e])}},{key:"resizeObjects",value:function(e){if(""!==e){var t=this.options.views[e].objects;if(t&&0<t.length)for(var n=0;n<t.length;n++)t[n].objectId&&(t[n].vis&&t[n].vis.resize?t[n].vis.resize():t[n].resize&&t[n].resize())}}},{key:"registerVisualisation",value:function(e,t){-1===e.indexOf(/\s/)?-1===this.supportedChartTypes.indexOf(e)?(this.supportedChartTypes.push(e),this.chartLibrary[e]=t):console.log("Failed to register Chart Extension. Chart name already exists."):console.log("Failed to register Chart Extension. Chart name must not contain spaces.")}},{key:"select",value:function(n,i,o){var a=this;n!==i.length?"select"===i[n].param&&this.app.getField(i[n].field,i[n].state).then(function(e){var t=i[n].values.map(function(e){var t=+e;if(isNaN(t)){var n=new Date(e);return isNaN(n.getDate())?{qText:decodeURI(e)}:{qNumber:WebsyDesigns.Utils.toQlikDate(n),qIsNumeric:!0}}return{qNumber:t,qIsNumeric:!0}});e.selectValues(t).then(function(){n++,a.select(n,i,o)})},function(e){console.log("field for selection not found",e),n++,a.select(n,i,o)}):o()}},{key:"selectFromUrl",value:function(e){if(!0===this.options.applySelections&&""!==location.search){var t=location.search.replace("?","").split("&");t=t.map(function(e){var t=e.split("="),n=t[1].split(","),i=n.shift().replace(/%20/g," "),o="$";return-1!==i.indexOf("::")&&(o=i.split("::")[0],i=i.split("::")[1]),{param:t[0],field:i,state:o,values:n}}).filter(function(e){return"select"===e.param||"setvariable"===e.param}),this.select(0,t,e)}else e()}}]),i}();WebsyDesigns.QlikObjectManager=ObjectManager}